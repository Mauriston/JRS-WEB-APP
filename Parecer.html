<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script type="module" src="https://esm.run/@material/web/all.js"></script>

    <style>
      /* --- Configuração de Cores e Fontes M3 --- */
      :root {
        --primary-color: #050F41;
        --background-color: #F5F5F5;
        --card-background-color: #FFFFFF;
        --text-color: #333333;
        --label-color: #555555;
        --primary-font: 'Montserrat', sans-serif;
        --body-font: 'Carlito', sans-serif;

        /* Override MWC Theme */
        --md-sys-color-primary: var(--primary-color);
        --md-sys-color-background: var(--background-color);
        --md-sys-color-surface: var(--card-background-color);
        --md-sys-color-on-surface: var(--text-color);
        --md-sys-color-on-surface-variant: var(--label-color);
        --md-ref-typeface-brand: var(--primary-font);
        --md-ref-typeface-plain: var(--body-font);
      }

      .hidden { display: none !important; }

      body {
        font-family: var(--body-font);
        background-color: var(--background-color);
        margin: 0;
        padding: 16px;
        color: var(--text-color);
      }

      /* --- Cabeçalho --- */
      .header-box {
        display: flex;
        align-items: center;
        background-color: var(--primary-color);
        color: #fff;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
      }
      .header-logo { height: 65px; width: auto; margin-right: 25px; }
      .header-text h2 {
        font-family: var(--primary-font);
        font-size: 26px;
        margin: 0;
        font-weight: 700;
      }
      .header-text p {
        font-family: var(--body-font);
        font-size: 18px;
        margin: 5px 0 0;
        opacity: .9;
      }
      .header-actions { display: flex; margin-left: auto; gap: 10px; }
      .header-actions md-icon-button {
        --md-sys-color-on-primary: #FFFFFF;
        --md-icon-button-icon-color: #FFFFFF;
        --md-icon-button-hover-icon-color: #FFFFFF;
        /* ... (mesmos estilos do Formulario.html) ... */
      }

      /* --- Card Principal --- */
      main {
        max-width: 900px;
        margin: 20px auto;
      }
      
      md-elevated-card {
        background-color: var(--card-background-color);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,.1);
      }

      .form-title {
        text-align: center;
        font-family: var(--primary-font);
        color: var(--primary-color);
        font-size: 22px;
        margin: 25px 0 15px;
      }

      /* --- Formulário --- */
      form {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 30px;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      /* Rótulo customizado para Select2 */
      .form-group label {
        font-family: var(--primary-font);
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 4px;
        color: var(--label-color);
        text-transform: uppercase;
      }
      
      md-outlined-text-field, 
      md-outlined-select {
        width: 100%;
      }

      .section-header {
        font-family: var(--primary-font);
        font-size: 18px;
        color: var(--primary-color);
        margin: 0;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--primary-color);
      }
      
      /* --- Ações e Status --- */
      .form-actions {
        display: flex;
        justify-content: flex-end;
        flex-wrap: wrap; /* Para responsividade dos botões */
        gap: 10px;
        margin-top: 10px;
      }
      .form-actions md-filled-button,
      .form-actions md-outlined-button {
        --md-filled-button-container-shape: 20px;
        --md-outlined-button-container-shape: 20px;
        --md-filled-button-label-text-font: var(--primary-font);
        --md-outlined-button-label-text-font: var(--primary-font);
        font-size: 16px;
        font-weight: 700;
      }
      
      #post-actions {
        justify-content: center;
        border-top: 1px solid #e0e0e0;
        padding-top: 20px;
      }

      #status {
        margin: 0 30px 20px 30px;
        padding: 12px;
        border-radius: 8px;
        font-size: 1em;
        text-align: center;
      }
      .processing {
        background-color: #e6e8f0; color: #555; border: 1px solid #c9d0e8;
      }
      .success {
        background-color: #e6f7e9; color: #2e6035; border: 1px solid #5cb85c;
      }
      .error {
        background-color: #f7e6e6; color: #a94442; border: 1px solid #d9534f;
      }

      /* --- Select2 Overrides --- */
      .select2-container .select2-selection--single {
        height: 56px !important;
        border: 1px solid var(--label-color) !important;
        border-radius: 4px !important;
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 54px !important;
        padding-left: 16px !important;
        font-family: var(--body-font);
        font-size: 16px;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 54px !important;
        top: 1px !important;
        right: 8px !important;
      }
    </style>
</head>
<body>
    <main>
        <md-elevated-card>
            <div class="header-box">
                <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
                <div class="header-text">
                    <h2>HOSPITAL NAVAL DE RECIFE</h2>
                    <p>GERADOR DE PARECERES</p>
                </div>
                <div class="header-actions">
                    <md-icon-button onclick="navigateTo('form')" title="Novo Formulário">
                        <md-icon>assignment</md-icon>
                    </md-icon-button>
                    <md-icon-button onclick="navigateTo('dashboard')" title="Dashboard">
                        <md-icon>dashboard</md-icon>
                    </md-icon-button>
                </div>
            </div>
            
            <h2 class="form-title">GERAR NOVO PARECER</h2>
            <div id="status" class="hidden"></div>
            
            <form id="parecerForm">
                <h3 class="section-header">PERITO E ESPECIALIDADE</h3>
                <div class="form-row">
                    <md-outlined-select label="Perito" id="PERITO_SELECAO" name="PERITO_SELECAO" required>
                        </md-outlined-select>
                    <md-outlined-select label="Especialidade" id="ESPECIALIDADE" name="ESPECIALIDADE" required>
                        </md-outlined-select>
                </div>
                
                <h3 class="section-header">INSPECIONADO</h3>
                
                <div class="form-group">
                    <label for="NOME">Inspecionado (HNRe)</label>
                    <select id="NOME" name="NOME" required style="width:100%"></select>
                </div>
                
                <div class="form-row">
                    <md-outlined-text-field label="Posto/Graduação" id="GRAU_HIERARQUICO" name="GRAU_HIERARQUICO" required readonly></md-outlined-text-field>
                    <md-outlined-text-field label="NIP" id="NIP_MAT" name="NIP_MAT" required readonly></md-outlined-text-field>
                </div>
                
                <h3 class="section-header">INFORMAÇÕES DA INSPEÇÃO</h3>
                <md-outlined-text-field label="Finalidade da Inspeção" id="FINALIDADE_INSP" name="FINALIDADE_INSP" required></md-outlined-text-field>
                <md-outlined-text-field label="Informações Complementares" type="textarea" rows="3" id="INFO_COMPLEMENTARES" name="INFO_COMPLEMENTARES"></md-outlined-text-field>
                
                <div class="form-actions" id="main-action">
                    <md-filled-button type="submit" id="submitBtn">
                        <md-icon slot="icon">picture_as_pdf</md-icon>
                        Gerar PDF
                    </md-filled-button>
                </div>

                <div class="form-actions hidden" id="post-actions">
                    <md-outlined-button id="newBtn">
                        <md-icon slot="icon">add</md-icon>
                        Novo Parecer
                    </md-outlined-button>
                    <md-outlined-button id="openBtn" href="" target="_blank">
                        <md-icon slot="icon">open_in_new</md-icon>
                        Abrir PDF
                    </md-outlined-button>
                    <md-filled-button id="emailZimbraBtn">
                        <md-icon slot="icon">outgoing_mail</md-icon>
                        Enviar (Zimbra)
                    </md-filled-button>
                    <md-filled-button id="emailJrsBtn">
                        <md-icon slot="icon">mail</md-icon>
                        Enviar (JRS)
                    </md-filled-button>
                </div>
            </form>
        </md-elevated-card>
    </main>

    <script>
      let BASE_URL = '';
      let militaryData = [];
      let currentPdfId = '';
      let currentFormData = {};
      
      // Constantes baseadas no Code.gs
      const TEMPLATE_IDS = {
        'Psiquiatria': '1dBBPpAUigm9DFUWqyP0NkTEVGxeHWwKZF8dnoJ7xqP8',
        'Psicologia': '1eQiRCtmF-V1Etn7fp6AbhTGZbYkqJlLrQYGjLRfePqQ',
        'Hepatologia': '12-s0h077A6hwipVe4oARcor4cNMKeAGOl6elV-pk_HQ',
        'Cardiologia': '1woGqRVEpe7hQkqZiPrPn2bUgIgcN7MtImn0plq8fbLE',
        'Ortopedia': '1qmi93Y_kZpNZEeYcqhSA41KVsZ4gFE1MqkK6kbAsheI'
      };
      const PERITO_EMAILS = {
        'CT Mauriston': 'mauriston.martins@marinha.mil.br',
        'CT Júlio César': 'julio.xaiver@marinha.mil.br',
        '1T Salyne': 'salyne.martins@marinha.mil.br',
        '1T Luz': 'lucas.luz@marinha.mil.br',
        '2T Trindade': 'marcelo.trindade@marinha.mil.br'
      };

      /* --- Inicialização --- */
      $(document).ready(function() {
        setStatus('processing', 'Carregando dados...');
        
        populateMwcSelect('#ESPECIALIDADE', Object.keys(TEMPLATE_IDS), 'Selecione a Especialidade...');
        populateMwcSelect('#PERITO_SELECAO', Object.keys(PERITO_EMAILS), 'Selecione o Perito...');
        
        google.script.run.withSuccessHandler(onMilitaryDataLoaded).withFailureHandler(onLoadFailure).getHnreMilitaryDataForParecer();
        google.script.run.withSuccessHandler((url) => { BASE_URL = url; }).getWebAppUrl();

        // Bind de eventos
        $('#NOME').on('change', onMilitarySelect);
        $('#parecerForm').on('submit', handleFormSubmit);
        
        $('#newBtn').on('click', resetForm);
        $('#emailZimbraBtn').on('click', () => handleEmailSend('zimbra'));
        $('#emailJrsBtn').on('click', () => handleEmailSend('jrs'));
      });

      function onMilitaryDataLoaded(data) {
        if (data.error) {
          onLoadFailure({ message: data.error });
          return;
        }
        militaryData = data;
        const inspSelect = $('#NOME');
        inspSelect.append(new Option('', '', true, true));
        data.forEach(m => inspSelect.append(new Option(m.name, m.nip))); // Usar NIP como value
        
        inspSelect.select2({ placeholder: 'Digite para buscar militar...', allowClear: true });
        setStatus('clear');
      }

      function onLoadFailure(error) {
        setStatus('error', `<b>Falha Crítica:</b> Não foi possível carregar dados. <br><small>Erro: ${error.message}</small>`);
        $('#parecerForm').find('md-outlined-text-field, md-outlined-select, md-filled-button, select').prop('disabled', true);
      }

      /* --- Lógica de UI Dinâmica --- */
      function onMilitarySelect() {
        const selectedNip = $(this).val();
        const military = militaryData.find(m => m.nip === selectedNip);
        
        if (military) {
          $('#GRAU_HIERARQUICO').val(military.posto);
          $('#NIP_MAT').val(military.nip);
        } else {
          $('#GRAU_HIERARQUICO').val('');
          $('#NIP_MAT').val('');
        }
      }

      /* --- Submissão do Formulário --- */
      function handleFormSubmit(e) {
        e.preventDefault();
        const btn = $('#submitBtn');
        btn.prop('disabled', true).html('<md-icon slot="icon">hourglass_top</md-icon> Gerando...');
        setStatus('processing', 'Gerando PDF. Isso pode levar alguns segundos...');
        
        // Coleta dados do formulário
        const selectedNip = $('#NOME').val();
        const military = militaryData.find(m => m.nip === selectedNip);
        
        currentFormData = {
          ESPECIALIDADE: $('#ESPECIALIDADE').val(),
          PERITO_SELECAO: $('#PERITO_SELECAO').val(),
          NOME: military ? military.name : '', // Pega o nome do militar selecionado
          GRAU_HIERARQUICO: $('#GRAU_HIERARQUICO').val(),
          NIP_MAT: $('#NIP_MAT').val(),
          FINALIDADE_INSP: $('#FINALIDADE_INSP').val(),
          INFO_COMPLEMENTARES: $('#INFO_COMPLEMENTARES').val()
        };
        
        google.script.run.withSuccessHandler(onPdfSuccess).withFailureHandler(onFailure).processForm(currentFormData);
      }

      function onPdfSuccess(response) {
        if (response.success) {
          currentPdfId = response.pdfId;
          $('#openBtn').attr('href', response.pdfUrl);
          
          setStatus('success', 'PDF gerado com sucesso!');
          $('#parecerForm').find('md-outlined-text-field, md-outlined-select, select').prop('disabled', true);
          $('#main-action').addClass('hidden');
          $('#post-actions').removeClass('hidden');
        } else {
          onFailure({ message: response.message });
        }
      }
      
      function handleEmailSend(target) {
        setStatus('processing', 'Enviando e-mail...');
        $('#post-actions').find('md-filled-button, md-outlined-button').prop('disabled', true);
        
        google.script.run.withSuccessHandler(onEmailSuccess).withFailureHandler(onEmailFailure).sendPdfByEmail(currentPdfId, currentFormData, target);
      }
      
      function onEmailSuccess(response) {
        if (response.success) {
          setStatus('success', response.message);
        } else {
          setStatus('error', response.message);
        }
        $('#post-actions').find('md-filled-button, md-outlined-button').prop('disabled', false);
      }
      
      function onEmailFailure(error) {
        setStatus('error', `Erro ao enviar: ${error.message}`);
        $('#post-actions').find('md-filled-button, md-outlined-button').prop('disabled', false);
      }

      function onFailure(error) {
        setStatus('error', `ERRO: ${error.message}`);
        $('#submitBtn').prop('disabled', false).html('<md-icon slot="icon">error</md-icon> Tentar Novamente');
      }

      function resetForm() {
        currentPdfId = '';
        currentFormData = {};
        
        $('#parecerForm').find('md-outlined-text-field, md-outlined-select').val('');
        $('#parecerForm').find('md-outlined-text-field, md-outlined-select, select').prop('disabled', false);
        $('#NOME').val(null).trigger('change');
        
        $('#main-action').removeClass('hidden');
        $('#post-actions').addClass('hidden');
        $('#submitBtn').prop('disabled', false).html('<md-icon slot="icon">picture_as_pdf</md-icon> Gerar PDF');
        setStatus('clear');
      }

      /* --- Utilitários --- */
      function populateMwcSelect(selector, options, placeholder) {
        const select = $(selector);
        select.empty();
        if (placeholder) {
          select.append($('<md-select-option>', { value: "" }).append($('<div>', { slot: 'headline', text: placeholder })));
        }
        if (options && options.length > 0) {
          options.sort().forEach(opt => {
            select.append($('<md-select-option>', { value: opt }).append($('<div>', { slot: 'headline', text: opt })));
          });
        }
      }

      function setStatus(type, message) {
        const statusDiv = $('#status');
        statusDiv.removeClass('processing success error hidden').hide();
        if (type !== 'clear') {
          statusDiv.addClass(type).html(message).removeClass('hidden');
        }
      }
      
      function navigateTo(page) {
        if (BASE_URL) {
          let targetPage = (page === 'form') ? '' : `?page=${page}`;
          window.top.location.href = BASE_URL + targetPage;
        }
      }
    </script>
</body>
</html>
