<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Parecer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <script type="module" src="https://cdn.jsdelivr.net/npm/@material/web/all.js/+esm"></script>
  
  <style>
    /* --- Material Design 3 Tokens & Globals --- */
    :root {
      /* Paleta de Cores (Tokens) */
      --md-sys-color-primary: #050F41;
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-secondary: #5A5D72;
      --md-sys-color-on-secondary: #FFFFFF;
      --md-sys-color-background: #F5F5F5;
      --md-sys-color-surface: #FFFFFF;
      --md-sys-color-surface-container-high: #F0F0F0;
      --md-sys-color-on-surface: #1C1B1F;
      --md-sys-color-on-surface-variant: #49454F;
      --md-sys-color-outline: #79747E;
      --md-sys-color-error: #B3261E;

      /* Tipografia (Tokens) */
      --md-sys-font-family-headline: 'Montserrat', sans-serif;
      --md-sys-font-family-body: 'Carlito', sans-serif;

      /* Shape */
      --md-sys-shape-corner-medium: 12px;
      --md-sys-shape-corner-large: 16px;
    }

    /* Estilos Globais */
    body {
      font-family: var(--md-sys-font-family-body);
      background-color: var(--md-sys-color-background);
      color: var(--md-sys-color-on-surface);
      margin: 0;
      padding: 24px;
      box-sizing: border-box;
    }

    /* Tipografia */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--md-sys-font-family-headline);
      color: var(--md-sys-color-primary);
      font-weight: 500;
    }
    
    h1 { font-size: 2rem; margin-bottom: 16px; }
    h2 { font-size: 1.5rem; margin-bottom: 12px; }

    /* Layout Principal */
    .container {
      display: grid;
      grid-template-columns: 1fr 2fr; /* 1/3 para o form, 2/3 para o preview */
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr; /* Coluna única */
      }
    }
    
    /* Card do Formulário */
    md-elevated-card {
      background-color: var(--md-sys-color-surface);
      border-radius: var(--md-sys-shape-corner-medium);
      padding: 24px;
      box-sizing: border-box;
      height: fit-content; /* Ajusta a altura ao conteúdo */
    }

    /* Campos do Formulário */
    md-outlined-text-field,
    md-outlined-select {
      width: 100%;
      margin-bottom: 16px;
      --md-outlined-text-field-container-shape: var(--md-sys-shape-corner-medium);
      --md-outlined-select-container-shape: var(--md-sys-shape-corner-medium);
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }
    
    .button-container md-filled-button,
    .button-container md-outlined-button {
      width: 100%; /* Botões com largura total */
    }
    
    #emailStatus {
      text-align: center;
      margin-top: 12px;
      font-weight: 500;
    }

    /* Preview do PDF */
    .preview-container {
      /* O card de preview */
    }
    
    #pdfPreview {
      width: 100%;
      height: 700px;
      border: none;
      border-radius: var(--md-sys-shape-corner-medium);
      background-color: var(--md-sys-color-surface-container-high);
    }
    
    /* Loader */
    #loader {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
    md-circular-progress {
      --md-circular-progress-size: 64px;
    }

    /* Navegação */
    .header-actions {
      display: flex;
      justify-content: flex-end;
      gap: 16px;
      margin-bottom: 16px;
    }
    .IconButton {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-primary);
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      text-decoration: none;
    }
    .IconButton:hover {
      background-color: rgba(5, 15, 65, 0.1);
    }
    .IconButton .material-symbols-outlined {
      font-size: 24px;
    }

  </style>
</head>
<body>

  <div class="header-actions">
      <div class="IconButton" onclick="navigateTo('formulario')" title="Formulário de Inspeção">
        <span class="material-symbols-outlined">description</span>
      </div>
      <div class="IconButton" onclick="navigateTo('dashboard')" title="Dashboard">
        <span class="material-symbols-outlined">dashboard</span>
      </div>
  </div>

  <div class="container">
    
    <md-elevated-card>
      <h1>Gerador de Parecer</h1>
      <form id="parecerForm">
        
        <md-outlined-select label="Template do Parecer" id="templateSelect" onchange="handleTemplateChange()" required>
          </md-outlined-select>
        
        <md-outlined-text-field
          label="NIP (com pontos e traço)"
          id="nipInput"
          oninput="searchMilitar()"
          required>
        </md-outlined-text-field>
        
        <md-outlined-text-field
          label="Nome do Inspecionado"
          id="nomeInput"
          required>
        </md-outlined-text-field>
        
        <md-outlined-text-field
          label="Data do Parecer"
          type="date"
          id="dataInput"
          required>
        </md-outlined-text-field>
        
        <div id="dynamicFields"></div>

        <div class="button-container">
          <md-filled-button id="generateButton" onclick="generateParecer()">
            Gerar Parecer
            <span class="material-symbols-outlined" slot="icon">picture_as_pdf</span>
          </md-filled-button>
          
          <md-outlined-button id="emailButton" onclick="sendEmail()" disabled>
            Enviar por E-mail
            <span class="material-symbols-outlined" slot="icon">email</span>
          </md-outlined-button>
        </div>
        
        <div id="emailStatus"></div>

      </form>
    </md-elevated-card>
    
    <md-elevated-card class="preview-container">
      <h2>Pré-visualização</h2>
      <iframe id="pdfPreview" src=""></iframe>
    </md-elevated-card>
    
  </div> <div id="loader">
    <md-circular-progress indeterminate></md-circular-progress>
  </div>

    <script>
      let hnreData=[],cachedPdfId=null,cachedFormData=null;const form=document.getElementById("myForm"),nameContainer=document.getElementById("name-container"),grauSelect=document.getElementById("GRAU_HIERARQUICO"),nipInput=document.getElementById("NIP_MAT"),statusDiv=document.getElementById("status"),actionsContainer=document.getElementById("formActionsContainer"),emailModal=document.getElementById("emailModal"),modalStatus=document.getElementById("modalStatus");function handleNipInput(e){let t=e.target.value.replace(/\D/g,"");t.length>8&&(t=t.slice(0,8)),t.length>6?t=t.replace(/^(\d{2})(\d{4})(\d{1,2})/,"$1.$2.$3"):t.length>2&&(t=t.replace(/^(\d{2})(\d{1,4})/,"$1.$2")),e.target.value=t}function toggleNipMask(){const e=grauSelect.value;nipInput.required="CANDIDATO"!==e;const t="SERVIDOR CIVIL"===e||"CANDIDATO"===e;t?(nipInput.removeEventListener("input",handleNipInput),nipInput.placeholder="Digite o identificador",nipInput.maxLength=50,"CANDIDATO"===e&&(nipInput.placeholder="Opcional")):(nipInput.addEventListener("input",handleNipInput),nipInput.placeholder="Ex: 13.0450.24",nipInput.maxLength=11)}function resetToManual(){nameContainer.innerHTML='<label for="NOME">NOME:</label><input type="text" id="NOME" name="NOME" required>',grauSelect.value="",nipInput.value="",grauSelect.disabled=!1,nipInput.disabled=!1,toggleNipMask()}function setupHnreAutocomplete(){nameContainer.innerHTML='<label for="NOME">NOME:</label><div class="autocomplete-container"><input type="text" id="NOME" name="NOME" required placeholder="Buscar militar do HNRe..."><div id="autocomplete-list" class="autocomplete-items"></div></div>';const e=document.getElementById("NOME");e.addEventListener("input",function(){const t=this.value;closeAllLists(),t&&hnreData.filter(e=>e.name.toUpperCase().includes(t.toUpperCase())).forEach(n=>{let o=document.createElement("DIV");o.innerHTML=n.name.replace(new RegExp(t,"gi"),"<strong>$&</strong>"),o.addEventListener("click",function(){e.value=n.name,grauSelect.value=n.posto,nipInput.value=n.nip,grauSelect.disabled=!0,nipInput.disabled=!0,toggleNipMask(),closeAllLists()}),document.getElementById("autocomplete-list").appendChild(o)})}),document.addEventListener("click",t=>{t.target!==e&&closeAllLists()})}function closeAllLists(){const e=document.getElementById("autocomplete-list");e&&(e.innerHTML="")}function handleOmSelection(e){
        "hnre"===e
          ? 0===hnreData.length
            ?(statusDiv.textContent="Buscando militares do HNRe...",
              // AQUI ESTÁ A MUDANÇA:
              google.script.run.withSuccessHandler(e=>{
                statusDiv.textContent="",
                "error"in e
                  ?(statusDiv.className="error",statusDiv.textContent="Erro ao buscar dados: "+e.error)
                  :(hnreData=e,setupHnreAutocomplete())
              }).withFailureHandler(e=>{
                statusDiv.className="error",statusDiv.textContent="Falha no script: "+e.message
              }).getHnreMilitaryDataForParecer() // <-- NOME DA FUNÇÃO ATUALIZADO
            )
            :setupHnreAutocomplete()
          :resetToManual()
      }
      function restoreFormToInitialState(){statusDiv.innerHTML="",form.reset(),grauSelect.disabled=!1,nipInput.disabled=!1,actionsContainer.innerHTML='<button type="submit" id="submitButton" class="btn btn-primary"><span class="material-symbols-outlined">description</span>Gerar PDF</button>',document.getElementById("om_hnre").checked=!0,handleOmSelection("hnre"),toggleNipMask()}
      function showModal(){emailModal.style.display="flex";modalStatus.innerHTML=""}
      function hideModal(){emailModal.style.display="none"}
      function triggerEmailSend(e){modalStatus.innerHTML="Enviando e-mail...";google.script.run.withSuccessHandler(e=>{modalStatus.innerHTML=`<span class="success">${e.message}</span>`,setTimeout(hideModal,2e3)}).withFailureHandler(e=>{modalStatus.innerHTML=`<span class="error">${e.message}</span>`}).sendPdfByEmail(cachedPdfId,cachedFormData,e)}
      document.getElementById("sendToZimbra").onclick=()=>triggerEmailSend("zimbra");
      document.getElementById("sendToSecretaria").onclick=()=>triggerEmailSend("secretaria");
      emailModal.addEventListener("click",e=>{e.target===emailModal&&hideModal()});
      document.querySelectorAll('input[name="om_selection"]').forEach(e=>{e.addEventListener("change",t=>handleOmSelection(t.target.value))});
      form.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("submitButton");if(document.getElementById("om_outras").checked){const e=document.getElementById("NOME");e.value=e.value.toUpperCase()}t.disabled=!0,statusDiv.textContent="Gerando PDF, por favor aguarde...",statusDiv.className="";const n={};Array.from(this.elements).forEach(e=>{if(e.name&&(e.type!=="radio"||e.checked)){n[e.name]=e.value}});cachedFormData=n;google.script.run.withSuccessHandler(e=>{if(e.success){cachedPdfId=e.pdfId,statusDiv.className="success",statusDiv.innerHTML="PDF gerado com sucesso!",actionsContainer.innerHTML="";const t=document.createElement("button");t.type="button",t.className="btn btn-secondary",t.innerHTML='<span class="material-symbols-outlined">repeat</span>NOVO PARECER',t.onclick=restoreFormToInitialState,actionsContainer.appendChild(t);const n=document.createElement("a");n.href=e.pdfUrl,n.target="_blank",n.className="btn btn-success",n.innerHTML='<span class="material-symbols-outlined">open_in_new</span>ABRIR PDF',actionsContainer.appendChild(n);const o=document.createElement("button");o.type="button",o.className="btn btn-outline",o.innerHTML='<span class="material-symbols-outlined">outgoing_mail</span>ENVIAR EMAIL',o.onclick=showModal,actionsContainer.appendChild(o)}else{statusDiv.className="error",statusDiv.textContent="Erro ao gerar PDF: "+e.message,t.disabled=!1}}).withFailureHandler(e=>{statusDiv.className="error",statusDiv.textContent="Erro no script: "+e.message,t.disabled=!1}).processForm(n)});
      document.addEventListener("DOMContentLoaded",restoreFormToInitialState);
    </script>
    
    <script>
      let BASE_URL = '';
      function navigateTo(page) {
        if (BASE_URL) {
          window.top.location.href = BASE_URL + '?page=' + page;
        } else {
          alert('Aguarde o carregamento da página e tente novamente.');
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        google.script.run.withSuccessHandler((url) => {
          BASE_URL = url;
        }).withFailureHandler((error) => {
          console.error('Failed to get Web App URL:', error);
          alert('Não foi possível carregar os links de navegação.');
        }).getWebAppUrl();
      });
    </script>
  </body>
</html>
