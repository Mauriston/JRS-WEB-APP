<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Oswald:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
      :root { --primary-color: #050f41; --warning-color: #FAB932; --font-oswald: 'Oswald', sans-serif; --font-carlito: 'Carlito', sans-serif; --sidebar-width: 250px; }
      body { font-family: var(--font-carlito); background-color: #f4f4f9; margin: 0; padding: 0; }

      /* SIDEBAR FIXA */
      .sidenav { height: 100%; width: var(--sidebar-width); position: fixed; z-index: 1000; top: 0; left: 0; background-color: var(--primary-color); overflow-x: hidden; padding-top: 20px; transition: transform 0.3s ease; }
      .sidenav-header { text-align: center; color: white; margin-bottom: 30px; display: flex; justify-content: center; align-items: center; height: 100px; }
      .sidenav-header img { width: 100px; height: auto; }
      .sidenav a { padding: 15px 25px; text-decoration: none; font-size: 18px; font-family: var(--font-oswald); color: #e0e0e0; display: flex; align-items: center; transition: 0.2s; border-left: 4px solid transparent; }
      .sidenav a:hover, .sidenav a.active { background-color: rgba(255,255,255,0.1); color: #fff; border-left: 4px solid var(--warning-color); }
      .sidenav a .material-symbols-outlined { margin-right: 15px; }

      /* CONTEÚDO */
      .container-main { margin-left: var(--sidebar-width); padding: 20px; transition: margin-left 0.3s ease; }
      .header-box { display: flex; align-items: center; background-color: var(--primary-color); color: #fff; padding: 20px 30px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: relative; }
      .header-logo { height: 65px; margin-right: 25px; }
      
      .header-text { flex-grow: 1; text-align: center; }
      .header-text h1 { font-family: var(--font-oswald); font-size: 32px; margin: 0; font-weight: 700; line-height: 1.1; }
      
      .mobile-toggle { display: none; margin-right: 20px; cursor: pointer; color: white; }

      @media (max-width: 992px) { .sidenav { transform: translateX(-100%); } .sidenav.active { transform: translateX(0); } .container-main { margin-left: 0; } .mobile-toggle { display: block; position: absolute; left: 20px; } .header-text { padding-left: 40px; } .sidenav .closebtn { display: block; position: absolute; top: 10px; right: 10px; color: white; font-size: 30px; cursor: pointer; } }
      @media (min-width: 993px) { .sidenav .closebtn { display: none; } }

      /* FORMULÁRIO ESPECÍFICO */
      .container-form { max-width: 800px; margin: 0 auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 30px; }
      
      form { display: flex; flex-direction: column; gap: 15px; }
      .form-group { display: flex; flex-direction: column; }
      .form-row { display: flex; gap: 20px; flex-wrap: wrap; }
      .form-row .form-group { flex: 1; min-width: 200px; }
      
      label { font-family: 'Oswald', sans-serif; font-weight: 700; margin-bottom: 5px; font-size: 14px; color: #555; text-transform: uppercase; }
      input[type=text], textarea, select { padding: 10px; font-size: 16px; font-family: 'Carlito', sans-serif; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; width: 100%; }
      input:disabled, select:disabled { background-color: #e9ecef; cursor: not-allowed; }
      
      .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 10px 20px; font-size: 16px; font-family: 'Oswald', sans-serif; font-weight: 700; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background 0.3s; text-decoration: none; }
      .btn-primary { background-color: var(--primary-color); }
      .btn-primary:hover { background-color: #0a1a7a; }
      .btn-success { background-color: var(--success-color); }
      .btn-secondary { background-color: #6c757d; }
      .btn-outline { background-color: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
      .btn-outline:hover { background-color: rgba(5,15,65,0.1); }
      
      /* Grid Especialidade */
      .specialty-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
      .specialty-grid-container input[type=radio] { display: none; }
      .specialty-grid-container label { display: block; padding: 10px; border: 2px solid var(--primary-color); border-radius: 4px; cursor: pointer; text-align: center; color: var(--primary-color); transition: 0.3s; }
      .specialty-grid-container input[type=radio]:checked + label { background-color: var(--primary-color); color: white; }
      
      /* OM Selector */
      .om-selector { display: flex; gap: 10px; }
      .om-selector input[type=radio] { display: none; }
      .om-selector label { padding: 8px 15px; border: 1px solid var(--primary-color); border-radius: 4px; cursor: pointer; color: var(--primary-color); }
      .om-selector input[type=radio]:checked + label { background-color: var(--primary-color); color: white; font-weight: bold; }

      /* Autocomplete */
      .autocomplete-container { position: relative; }
      .autocomplete-items { position: absolute; border: 1px solid #d4d4d4; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; }
      .autocomplete-items div { padding: 10px; cursor: pointer; border-bottom: 1px solid #d4d4d4; }
      .autocomplete-items div:hover { background-color: #e9e9e9; }

      /* Modal Email */
      .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
      .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
      .modal-actions { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
      
      #status { margin-top: 15px; text-align: center; font-weight: bold; }
      .success { color: var(--success-color); } .error { color: var(--danger-color); }
    </style>
</head>
<body>

    <nav class="sidenav" id="mySidenav">
        <span class="closebtn" onclick="toggleSidebar()">&times;</span>
        <div class="sidenav-header">
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe">
        </div>
        <a href="#" onclick="navigateTo('dashboard'); return false;"><span class="material-symbols-outlined">dashboard</span>Dashboard</a>
        <a href="#" onclick="navigateTo('inspecoes'); return false;"><span class="material-symbols-outlined">table_view</span>Inspeções</a>
        <a href="#" onclick="navigateTo('parecer'); return false;" class="active"><span class="material-symbols-outlined">edit_note</span>Parecer</a>
    </nav>

    <main class="container-main">
        <div class="header-box">
            <span class="material-symbols-outlined mobile-toggle" onclick="toggleSidebar()">menu</span>
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo" class="header-logo">
            <div class="header-text">
                <h1>SOLICITAÇÃO DE PARECER</h1>
            </div>
        </div>

        <div class="container-form">
            <form id="myForm" autocomplete="off">
                <div class="form-group">
                    <label>ESPECIALIDADE:</label>
                    <div class="specialty-grid-container">
                        <div><input type="radio" id="spec_psiquiatria" name="ESPECIALIDADE" value="Psiquiatria" checked><label for="spec_psiquiatria">Psiquiatria</label></div>
                        <div><input type="radio" id="spec_psicologia" name="ESPECIALIDADE" value="Psicologia"><label for="spec_psicologia">Psicologia</label></div>
                        <div><input type="radio" id="spec_hepatologia" name="ESPECIALIDADE" value="Hepatologia"><label for="spec_hepatologia">Hepatologia</label></div>
                        <div><input type="radio" id="spec_cardiologia" name="ESPECIALIDADE" value="Cardiologia"><label for="spec_cardiologia">Cardiologia</label></div>
                        <div><input type="radio" id="spec_ortopedia" name="ESPECIALIDADE" value="Ortopedia"><label for="spec_ortopedia">Ortopedia</label></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>OM DO MILITAR</label>
                    <div class="om-selector">
                        <input type="radio" id="om_hnre" name="om_selection" value="hnre" checked><label for="om_hnre">HNRe</label>
                        <input type="radio" id="om_outras" name="om_selection" value="outras"><label for="om_outras">Outras OM</label>
                    </div>
                </div>

                <div id="name-container" class="form-group"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="GRAU_HIERARQUICO">GRAU HIERÁRQUICO:</label>
                        <select id="GRAU_HIERARQUICO" name="GRAU_HIERARQUICO" required>
                            <option value="">Selecione...</option>
                            <option value="CMG">CMG</option><option value="CF">CF</option><option value="CC">CC</option><option value="CT">CT</option>
                            <option value="1TEN">1TEN</option><option value="2TEN">2TEN</option><option value="GM">GM</option><option value="SO">SO</option>
                            <option value="1SG">1SG</option><option value="2SG">2SG</option><option value="3SG">3SG</option><option value="CB">CB</option>
                            <option value="SD">SD</option><option value="MN">MN</option><option value="MNRC">MNRC</option><option value="SERVIDOR CIVIL">SERVIDOR CIVIL</option>
                            <option value="DEPENDENTE">DEPENDENTE</option><option value="PENSIONISTA">PENSIONISTA</option><option value="CANDIDATO">CANDIDATO</option>
                            <option value="EX-MILITAR">EX-MILITAR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="NIP_MAT">NIP / MAT:</label>
                        <input type="text" id="NIP_MAT" name="NIP_MAT" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="FINALIDADE_INSP">FINALIDADE:</label>
                    <select id="FINALIDADE_INSP" name="FINALIDADE_INSP" required>
                        <option value="">Selecione...</option>
                        <option value="TÉRMINO DE INCAPACIDADE">TÉRMINO DE INCAPACIDADE</option>
                        <option value="TÉRMINO DE RESTRIÇÕES">TÉRMINO DE RESTRIÇÕES</option>
                        <option value="VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL">VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL</option>
                        <option value="INGRESSO NO SERVIÇO MILITAR VOLUNTÁRIO">INGRESSO NO SERVIÇO MILITAR VOLUNTÁRIO</option>
                        <option value="DEIXAR O SMI">DEIXAR O SMI</option>
                        <option value="CONTROLE TRIENAL">CONTROLE TRIENAL</option>
                        <!-- Adicione mais opções conforme necessário -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="INFO_COMPLEMENTARES">INFORMAÇÕES COMPLEMENTARES:</label>
                    <textarea id="INFO_COMPLEMENTARES" name="INFO_COMPLEMENTARES"></textarea>
                </div>

                <div class="form-group">
                    <label for="PERITO_SELECAO">PERITO RESPONSÁVEL:</label>
                    <select id="PERITO_SELECAO" name="PERITO_SELECAO" required>
                        <option value="">Selecione...</option>
                        <option value="CT Mauriston">CT Mauriston</option>
                        <option value="CT Júlio César">CT Júlio César</option>
                        <option value="1T Salyne">1T Salyne</option>
                        <option value="1T Luz">1T Luz</option>
                        <option value="2T Trindade">2T Trindade</option>
                    </select>
                </div>

                <div class="form-actions" id="formActionsContainer">
                    <!-- Botões injetados via JS -->
                </div>
            </form>
            <div id="status"></div>
        </div>
    </main>

    <div id="emailModal" class="modal-overlay">
        <div class="modal-content">
            <h2>ENVIAR PDF</h2>
            <div id="modalStatus"></div>
            <div class="modal-actions">
                <button type="button" id="sendToZimbra" class="btn btn-primary"><span class="material-symbols-outlined">upload</span> Receber por Zimbra</button>
                <button type="button" id="sendToSecretaria" class="btn btn-secondary"><span class="material-symbols-outlined">download</span> Enviar p/ Secretaria</button>
            </div>
            <button class="btn btn-outline" style="margin-top:15px;" onclick="hideModal()">Fechar</button>
        </div>
    </div>

    <script>
        let BASE_URL = '';
        function navigateTo(page) { if (BASE_URL) window.top.location.href = BASE_URL + '?page=' + page; }
        function toggleSidebar() { document.getElementById("mySidenav").classList.toggle('active'); }
        
        // Lógica do Parecer
        let hnreData = [], cachedPdfId = null, cachedFormData = null;
        const form = document.getElementById("myForm");
        const statusDiv = document.getElementById("status");
        const actionsContainer = document.getElementById("formActionsContainer");
        const emailModal = document.getElementById("emailModal");
        const modalStatus = document.getElementById("modalStatus");

        document.addEventListener("DOMContentLoaded", () => {
            google.script.run.withSuccessHandler(url => BASE_URL = url).getWebAppUrl();
            restoreFormToInitialState();
        });

        // Autocomplete e Lógica de Form
        function handleNipInput(e){ let t=e.target.value.replace(/\D/g,""); if(t.length>8)t=t.slice(0,8); if(t.length>6)t=t.replace(/^(\d{2})(\d{4})(\d{1,2})/,"$1.$2.$3"); else if(t.length>2)t=t.replace(/^(\d{2})(\d{1,4})/,"$1.$2"); e.target.value=t; }
        
        function toggleNipMask(){
            const grau = document.getElementById("GRAU_HIERARQUICO").value;
            const nipInput = document.getElementById("NIP_MAT");
            const isCivil = ["SERVIDOR CIVIL","CANDIDATO","DEPENDENTE"].includes(grau);
            
            nipInput.required = grau !== "CANDIDATO";
            
            if(isCivil) {
                nipInput.removeEventListener("input", handleNipInput);
                nipInput.placeholder = "Identificador";
                nipInput.maxLength = 50;
            } else {
                nipInput.addEventListener("input", handleNipInput);
                nipInput.placeholder = "Ex: 00.0000.00";
                nipInput.maxLength = 11;
            }
        }

        function resetToManual(){
            document.getElementById("name-container").innerHTML = '<label for="NOME">NOME:</label><input type="text" id="NOME" name="NOME" required>';
            document.getElementById("GRAU_HIERARQUICO").disabled = false;
            document.getElementById("NIP_MAT").disabled = false;
            document.getElementById("GRAU_HIERARQUICO").value = "";
            document.getElementById("NIP_MAT").value = "";
            toggleNipMask();
        }

        function setupHnreAutocomplete(){
            document.getElementById("name-container").innerHTML = '<label for="NOME">NOME:</label><div class="autocomplete-container"><input type="text" id="NOME" name="NOME" required placeholder="Buscar militar do HNRe..."><div id="autocomplete-list" class="autocomplete-items"></div></div>';
            const inp = document.getElementById("NOME");
            
            inp.addEventListener("input", function(){
                const val = this.value;
                closeAllLists();
                if(!val) return;
                
                hnreData.filter(m => m.name.toUpperCase().includes(val.toUpperCase())).forEach(m => {
                    let div = document.createElement("DIV");
                    div.innerHTML = m.name;
                    div.addEventListener("click", function(){
                        inp.value = m.name;
                        document.getElementById("GRAU_HIERARQUICO").value = m.posto;
                        document.getElementById("NIP_MAT").value = m.nip;
                        document.getElementById("GRAU_HIERARQUICO").disabled = true;
                        document.getElementById("NIP_MAT").disabled = true;
                        closeAllLists();
                    });
                    document.getElementById("autocomplete-list").appendChild(div);
                });
            });
        }

        function closeAllLists(){
            const el = document.getElementById("autocomplete-list");
            if(el) el.innerHTML = "";
        }
        
        document.addEventListener("click", e => { if(e.target.id !== "NOME") closeAllLists(); });

        function handleOmSelection(val){
            if(val === "hnre") {
                if(hnreData.length === 0) {
                    statusDiv.textContent = "Carregando lista HNRe...";
                    google.script.run.withSuccessHandler(data => {
                        statusDiv.textContent = "";
                        if(data.error) { statusDiv.className="error"; statusDiv.textContent = data.error; }
                        else { hnreData = data; setupHnreAutocomplete(); }
                    }).getHnreMilitaryDataForParecer();
                } else { setupHnreAutocomplete(); }
            } else { resetToManual(); }
        }

        function restoreFormToInitialState(){
            statusDiv.innerHTML = "";
            form.reset();
            document.getElementById("om_hnre").checked = true;
            handleOmSelection("hnre");
            actionsContainer.innerHTML = '<button type="submit" id="submitButton" class="btn btn-primary"><span class="material-symbols-outlined">description</span> Gerar PDF</button>';
        }

        // Modais
        function showModal(){ emailModal.style.display="flex"; modalStatus.innerHTML=""; }
        function hideModal(){ emailModal.style.display="none"; }
        
        function triggerEmailSend(target){
            modalStatus.innerHTML = "Enviando...";
            google.script.run.withSuccessHandler(res => {
                modalStatus.innerHTML = `<span class="${res.success?'success':'error'}">${res.message}</span>`;
                if(res.success) setTimeout(hideModal, 2000);
            }).sendPdfByEmail(cachedPdfId, cachedFormData, target);
        }

        document.getElementById("sendToZimbra").onclick = () => triggerEmailSend("zimbra");
        document.getElementById("sendToSecretaria").onclick = () => triggerEmailSend("secretaria");
        
        document.querySelectorAll('input[name="om_selection"]').forEach(el => {
            el.addEventListener("change", e => handleOmSelection(e.target.value));
        });
        
        document.getElementById("GRAU_HIERARQUICO").addEventListener("change", toggleNipMask);

        form.addEventListener("submit", function(e){
            e.preventDefault();
            const btn = document.getElementById("submitButton");
            if(document.getElementById("om_outras").checked) {
                document.getElementById("NOME").value = document.getElementById("NOME").value.toUpperCase();
            }
            btn.disabled = true;
            statusDiv.textContent = "Gerando PDF...";
            
            // Coleta dados (incluindo disabled)
            const data = {};
            new FormData(form).forEach((v, k) => data[k] = v);
            data.GRAU_HIERARQUICO = document.getElementById("GRAU_HIERARQUICO").value;
            data.NIP_MAT = document.getElementById("NIP_MAT").value;
            cachedFormData = data;

            google.script.run.withSuccessHandler(res => {
                if(res.success){
                    cachedPdfId = res.pdfId;
                    statusDiv.innerHTML = "<span class='success'>PDF Gerado!</span>";
                    actionsContainer.innerHTML = "";
                    
                    const btnNovo = document.createElement("button");
                    btnNovo.className = "btn btn-secondary";
                    btnNovo.innerHTML = '<span class="material-symbols-outlined">refresh</span> Novo';
                    btnNovo.onclick = restoreFormToInitialState;
                    
                    const btnAbrir = document.createElement("a");
                    btnAbrir.className = "btn btn-success";
                    btnAbrir.innerHTML = '<span class="material-symbols-outlined">open_in_new</span> Abrir PDF';
                    btnAbrir.href = res.pdfUrl;
                    btnAbrir.target = "_blank";
                    
                    const btnEmail = document.createElement("button");
                    btnEmail.className = "btn btn-outline";
                    btnEmail.innerHTML = '<span class="material-symbols-outlined">mail</span> Enviar';
                    btnEmail.type = "button";
                    btnEmail.onclick = showModal;
                    
                    actionsContainer.append(btnNovo, btnAbrir, btnEmail);
                } else {
                    statusDiv.className = "error";
                    statusDiv.textContent = "Erro: " + res.message;
                    btn.disabled = false;
                }
            }).processForm(data);
        });
    </script>
</body>
</html>
