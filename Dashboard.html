<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Oswald:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Link Google Fonts como Fonte Variável -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #050f41;
        --danger-color: #990000; /* Usado para Cancelada, Faltou */
        --danger-color-vivid: #d9534f; /* Usado para pendências: Conclusão, Votação, Assinatura */
        --danger-color-light: #fef5f5;
        --success-color: #146c43; /* Usado para TIS Assinado */
        --link-color: #0d6efd;
        --warning-color: #FAB932; /* Cor amarela para Auditoria, JSD, Remarcada, Restituída */
        --info-color: #6c757d; /* Cinza escuro médio para Agendada */
        --secondary-color: #adb5bd; /* Cinza claro para AGU Exames (Se necessário) */
        --font-oswald: 'Oswald', sans-serif;
        --font-carlito: 'Carlito', sans-serif;
        --light-gray-1: #fcfcfc;
        --dark-gray-3: #6c757d; 
        --card-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); /* Sombra para card elevado */
        --card-shadow-hover: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23); /* Sombra mais pronunciada no hover */
      }
      body {
        font-family: var(--font-carlito);
        background-color: #f4f4f9; /* Fundo cinza claro */
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container-main { 
        max-width: 1400px; 
        margin: 20px auto; 
        background-color: transparent; 
        border-radius: 0; 
        box-shadow: none; 
        overflow: visible; 
      }
      .header-box { 
        display: flex; 
        align-items: center; 
        background-color: var(--primary-color); 
        color: #fff; 
        padding: 20px 30px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        box-shadow: var(--card-shadow); 
      }
      .header-logo { height: 65px; margin-right: 25px; }
      .header-text h1 { font-family: var(--font-oswald); font-size: 32px; margin: 0; font-weight: 700; line-height: 1.1; }
      .header-text p { font-family: var(--font-carlito); font-size: 18px; margin: 5px 0 0; opacity: .9; }
      
      .header-actions{display:flex;margin-left:auto;gap:15px}
      .IconButton{display:flex;align-items:center;justify-content:center;width:55px;height:55px;border-radius:50%;background-color:rgba(255,255,255,0.1);color:#fff;cursor:pointer;transition:background-color .2s ease-in-out; text-decoration: none;}
      .IconButton:hover{background-color:rgba(255,255,255,0.2)}
      .IconButton .material-symbols-outlined { 
        font-size: 30px; 
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
        vertical-align: middle;
      } 

      .dashboard-content { padding: 0; }
      
      .title-filter-card {
        padding: 20px 20px 10px 20px;
      }
      .dashboard-title-wrapper { 
        display: flex; 
        justify-content: center; 
        width: 100%; 
        margin-bottom: 20px; 
        padding: 0; 
        background-color: transparent; 
        box-shadow: none; 
      } 
      .dashboard-title, .section-title { 
        display: flex; align-items: center; justify-content: center;
        font-family: var(--font-oswald); font-size: 32px; font-weight: 700; 
        text-transform: uppercase; gap: 15px; color: #333;
      }
      .dashboard-title { margin-bottom: 0; }
      .section-title { margin-top: 40px; margin-bottom: 25px; }
      .dashboard-title .material-symbols-outlined,
      .section-title .material-symbols-outlined { 
        font-size: 38px !important; 
        font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 48; 
        vertical-align: middle;
      }

      .kpi-value { margin-bottom: 0.5rem !important; }
      #loader { text-align: center; padding: 50px; }
      
      .card-elevated {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        border: 1px solid #e9e9e9; 
        transition: box-shadow .3s cubic-bezier(.25,.8,.25,1); 
        margin-bottom: 20px; 
        overflow: hidden; 
      }

      /* Regras de altura e flex para os blocos de KPI */
      .kpi-block { 
        border: none; 
        padding: 1.2rem; 
        height: 100%; 
        box-shadow: none; 
        border-radius: 0; 
        margin-bottom: 0; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-around; /* Distribui o conteúdo */
      }
      .kpi-block-alert { 
        background-color: var(--danger-color-light); 
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        justify-content: space-around; /* Distribui o conteúdo */
      }
      .kpi-item { margin-bottom: 0.5rem; }
      .kpi-title { font-family: var(--font-oswald); text-transform: uppercase; font-weight: 800; color: #555; display: flex; align-items: center; gap: 8px; }
      .kpi-value { font-family: var(--font-oswald); font-weight: 700; line-height: 1; margin: 0; }
      .kpi-title .material-symbols-outlined {
          font-size: 1.1em; 
          vertical-align: middle;
          font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
      }
      
      .kpi-item.level-1 .kpi-title { font-size: 1.2rem; }
      .kpi-item.level-1 .kpi-value { font-size: 5rem; }
      .kpi-item.level-2 .kpi-title { font-size: 1.1rem; }
      .kpi-item.level-2 .kpi-value { font-size: 3.5rem; }
      .kpi-item.level-3 .kpi-title { font-size: 0.9rem; }
      .kpi-item.level-3 .kpi-value { font-size: 2.2rem; }

      .kpi-block-alert .kpi-title, .kpi-block-alert .kpi-value { color: var(--danger-color); }
      .kpi-block-alert .kpi-title { color: var(--danger-color-vivid); }
      .text-alert-vivid .kpi-title,
      .text-alert-vivid .kpi-value,
      .text-alert-vivid .material-symbols-outlined { color: var(--danger-color-vivid) !important; }
      
      /* Fontes aumentadas para o card de alerta */
      .kpi-block-alert .kpi-item.level-2 .kpi-title { 
        font-size: 1.3rem; /* Aumentado */
      }
      .kpi-block-alert .kpi-item.level-2 .kpi-value { 
        font-size: 4.5rem; /* Aumentado */
      }

      .chart-container { background-color: transparent; padding: 20px; height: 400px; border: none; box-shadow: none; border-radius: 0; margin-bottom: 0; } 
      .table-container { background-color: transparent; padding: 20px; box-shadow: none; border-radius: 0; margin-bottom: 0; } 
      
      /* .status-pendente { font-weight: bold; } */ /* Não mais necessário */
      
      .table-cell-main { font-weight: bold; color: #333; }
      .table-cell-sub { font-size: 0.8em; color: var(--dark-gray-3); }
      
      .table-row-alert td, 
      .table-row-alert .table-cell-main,
      .table-row-alert .table-cell-sub {
        background-color: var(--danger-color-light) !important;
        color: var(--danger-color) !important;
        font-weight: bold !important;
      }
      .table-hover > tbody > tr.table-row-alert:hover > * {
        --bs-table-hover-bg: #f5e3e3;
        background-color: var(--bs-table-hover-bg) !important;
        color: var(--danger-color) !important;
      }
      
      /* Estilo para ícone de ação na tabela */
      .actions-cell-content { display: flex; justify-content: space-between; align-items: center; }
      td .actions-cell-content .actions-icon { flex-shrink: 0; } 
      .actions-icon { cursor: pointer; color: #777; }
      .actions-icon:hover { color: #000; }
      .actions-icon.material-symbols-outlined {
         font-size: 1.3em; 
         font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; 
         vertical-align: middle;
      }
      
      /* Estilo para ícones de status na tabela */
      .status-icon {
          font-size: 1.8em; /* Tamanho do ícone aumentado */
          vertical-align: middle;
          margin-right: 8px; /* Espaço entre ícone de status e ícone de ação */
          font-variation-settings: 'FILL' 1, 'wght' 400; /* Preenchido, peso normal por padrão */
      }
      
      .modal-header { background-color: var(--primary-color); color: white; }
      .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
      .modal-body span { font-family: var(--font-oswald); text-transform: uppercase; color: #050f41; font-size: 1.2rem;}
      .modal-body p { margin-bottom: 1rem; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
      #modalDetailsInspecionado { font-size: 1.5rem; font-weight: bold; font-family: var(--font-oswald); background-color: transparent; padding-left: 0; }
      .modal-body .d-none { display: none !important; }

      .global-filter-bar { 
        background-color: transparent; 
        padding: 0 1rem 1rem 1rem; 
        border: none; 
        box-shadow: none; 
        border-radius: 0; 
        margin-bottom: 0; 
      } 
      .global-filter-bar .form-label { font-family: var(--font-oswald); font-weight: 700; text-transform: uppercase; font-size: 0.9rem; color: #555; }
      
      /* --- ESTILO PARA CHIP FILTER (ATUALIZADO) --- */
      .chip-filter {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        font-family: var(--font-oswald);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: var(--card-shadow);
        user-select: none; /* Impede seleção de texto */
        background-color: #e9ecef; /* Cor inativa CINZA */
        color: #495057;
        border: 1px solid #e9ecef;
      }
      .chip-filter .material-symbols-outlined {
        font-size: 1.2em;
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        vertical-align: middle;
        transition: all 0.3s ease;
        color: #495057; /* Cor do ícone inativo */
      }
      .chip-filter.active {
        background-color: var(--dark-gray-3); /* Cor ativa CINZA */
        color: #fff;
        box-shadow: var(--card-shadow-hover);
      }
      .chip-filter.active .material-symbols-outlined {
        font-variation-settings: 'FILL' 1, 'wght' 700;
        color: #fff; /* Cor do ícone ativo */
      }
      
      /* Estilo para o chip de PERIGO (IS Pendentes) */
      .chip-filter.chip-danger {
        background-color: var(--danger-color-light);
        color: var(--danger-color-vivid);
        border: 1px solid var(--danger-color-vivid);
      }
      .chip-filter.chip-danger .material-symbols-outlined {
        color: var(--danger-color-vivid);
      }
      .chip-filter.chip-danger.active {
        background-color: var(--danger-color-vivid); /* Cor ativa VERMELHA */
        color: #fff;
      }
      .chip-filter.chip-danger.active .material-symbols-outlined {
        color: #fff;
      }

    </style>
</head>
<body>
    <div class="container-main">
      <div class="header-box"> 
        <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
        <div class="header-text">
          <h1>JUNTA REGULAR DE SAÚDE</h1>
          <p>HOSPITAL NAVAL DE RECIFE</p>
        </div>
        <div class="header-actions">
            <div class="IconButton" onclick="navigateTo('formulario')" title="Formulário de Inspeção"><span class="material-symbols-outlined">description</span></div>
            <div class="IconButton" onclick="navigateTo('parecer')" title="Gerar Parecer"><span class="material-symbols-outlined">edit_note</span></div>
        </div>
      </div>
      
      <div class="dashboard-content">
        <div class="card-elevated title-filter-card"> 
            <div class="dashboard-title-wrapper"> 
                <h2 class="dashboard-title">
                  <span class="material-symbols-outlined">medical_information</span>
                  INSPEÇÕES DE SAÚDE
                </h2>
            </div>
            <div class="global-filter-bar">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="yearFilter" class="form-label">Ano</label>
                        <select id="yearFilter" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="monthFilter" class="form-label">Mês</label>
                        <select id="monthFilter" class="form-select"></select>
                    </div>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center card-elevated" style="padding: 50px;"> 
            <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div>
            <p class="mt-2">A carregar dados...</p>
        </div>

        <div id="mainContent" class="d-none">
            
            <div class="row g-4 mb-4"> 
              <div class="col-lg-6">
                <div class="card-elevated h-100"> 
                  <div class="kpi-block">
                    <div class="kpi-item level-1 text-center"><p class="kpi-value" id="kpiTotal">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">summarize</span>Total de Inspeções</h6></div><hr>
                    <div class="row text-center"><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiTisSigned">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">check_circle</span>TIS Assinados</h6></div><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgEnviada" style="color:var(--success-color);">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">mark_email_read</span>MSG Enviadas</h6></div></div><hr>
                    <div class="row text-center"><div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiAuditoria">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">policy</span>Auditoria CPMM</h6></div><div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiJsd">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">manage_search</span>Revisão JSD</h6></div></div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card-elevated h-100"> 
                  <div class="kpi-block kpi-block-alert">
                    <div class="flex-fill d-flex align-items-center"><div class="row text-center w-100"><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">unsubscribe</span>MSG Pendentes</h6></div><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiExamesPendentes">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">lab_profile</span>Exames Pendentes</h6></div></div></div><hr class="my-0"><div class="flex-fill d-flex align-items-center"><div class="row text-center w-100"><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiConclusoesPendentes">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">help</span>Conclusões Pendentes</h6></div><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiVotacaoPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">gavel</span>Votações Pendentes</h6></div></div></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row g-4 mb-4 justify-content-center"> 
                <div class="col-md-6 col-lg-5">
                    <div class="card-elevated"> 
                      <div class="kpi-block">
                          <div class="row text-center">
                             <div class="col-6 kpi-item level-3" id="kpi-item-cancelada"><p class="kpi-value" id="kpiCancelada">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">cancel</span>Canceladas</h6></div>
                             <div class="col-6 kpi-item level-3" id="kpi-item-faltas"><p class="kpi-value" id="kpiFaltou">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">person_off</span>Faltas</h6></div>
                          </div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4"> 
              <div class="col-lg-4">
                  <div class="card-elevated"> 
                      <div class="chart-container">
                          <h4 class="text-center" style="font-family: 'Oswald', sans-serif;" id="finalidadeChartTitle"></h4>
                          <div id="purposeDonutChart"></div>
                      </div>
                  </div>
              </div>
              <div class="col-lg-4">
                  <div class="card-elevated"> 
                      <div class="chart-container">
                          <h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Entrevistas por Mês</h4>
                          <div id="interviewsBarChart"></div>
                      </div>
                  </div>
              </div>
              <div class="col-lg-4">
                  <div class="card-elevated"> 
                      <div class="chart-container">
                          <h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Tipo de Inspeção</h4>
                          <div id="tipoInspecaoPieChart"></div>
                      </div>
                  </div>
              </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card-elevated"> 
                        <div class="table-container">
                          <h2 class="section-title"><span class="material-symbols-outlined">patient_list</span> DETALHES DAS INSPEÇÕES</h2>
                          
                          <!-- BARRA DE FILTROS ATUALIZADA -->
                          <div class="row g-3 mb-3 align-items-end">
                            <div class="col-md-3"><input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome..."></div>
                            <div class="col-md-3"><select id="purposeFilter" class="form-select"></select></div>
                            <div class="col-md-3"><select id="statusFilter" class="form-select"></select></div> 
                            <div class="col-md-3 d-flex align-items-center justify-content-start pb-1 gap-2">
                                <!-- NOVO CHIP FILTER (IS PENDENTES) - Vermelho -->
                                <div class="chip-filter chip-danger" id="isPendenteFilter" title="Filtrar IS com pendência de status">
                                  <span class="material-symbols-outlined">pending_actions</span>
                                  IS Pendentes
                                </div>
                                <!-- CHIP FILTER (MSG PENDENTE) - Cinza/Padrão -->
                                <div class="chip-filter" id="pendingMsgFilter" title="Filtrar mensagens pendentes">
                                  <span class="material-symbols-outlined">unsubscribe</span>
                                  MSG Pendente
                                </div>
                            </div>
                          </div>

                          <div class="table-responsive">
                            <table class="table table-hover">
                              <thead>
                                <tr>
                                  <!-- COLUNAS REORDENADAS -->
                                  <th>Status</th>
                                  <th>MSG</th>
                                  <th>Data / IS</th>
                                  <th>Inspecionado / OM</th> 
                                  <th>Finalidade</th>
                                </tr>
                              </thead>
                              <tbody id="dataTableBody"></tbody>
                            </table>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="detailsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Detalhes da Inspeção</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="modalDetailsInspecionado"></p><p id="modalDetailsFinalidade"></p><hr><div id="laudo-section"><span>Laudo</span><p id="modalDetailsLaudo"></p></div><div id="restricoes-section"><span>Restrições</span><p id="modalDetailsRestricoes"></p></div><div class="row"><div class="col-md-4" id="dataLaudo-section"><span>Data do Laudo</span><p id="modalDetailsDataLaudo"></p></div><div class="col-md-4" id="tis-section"><span>TIS</span><p id="modalDetailsTis"></p></div><div class="col-md-4" id="ds1a-section"><span>DS-1a</span><p id="modalDetailsDs1a"></p></div></div><div id="minuta-msg-section" class="accordion mt-3 d-none"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMinuta">MINUTA MSG</button></h2><div id="collapseMinuta" class="accordion-collapse collapse"><div class="accordion-body"><p id="modalMinutaMsgText" style="white-space: pre-wrap;"></p></div></div></div></div></div></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let allDashboardData = []; let allTableData = []; let filteredData = []; let detailsModalInstance;
        let tooltipList = []; // Para armazenar instâncias de tooltip

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => { 
            console.log("DOM Carregado. Inicializando..."); 
            detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal')); 
            document.getElementById('loader').classList.remove('d-none'); 
            document.getElementById('mainContent').classList.add('d-none'); 
            initializeTooltips(); 
            google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataError).getDashboardData(); 
            console.log("Chamada para getDashboardData enviada."); 
        });

        // --- FUNÇÃO PARA INICIALIZAR TOOLTIPS ---
        function initializeTooltips() {
            console.log("Inicializando tooltips...");
            tooltipList.forEach(tooltip => tooltip.dispose());
            tooltipList = [];
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                // Adiciona configuração para permitir HTML no tooltip
                return new bootstrap.Tooltip(tooltipTriggerEl, {html: true}); 
            });
            console.log(`${tooltipList.length} tooltips inicializados.`);
        }

        // --- CALLBACKS DE CARREGAMENTO DE DADOS ---
        function onDataLoaded(response) { console.log("Dados recebidos do backend:", response); try { if (!response || !Array.isArray(response.dashboardData) || !Array.isArray(response.tableData)) { throw new Error("Formato de dados recebido do backend é inválido."); } allDashboardData = response.dashboardData.map(row => { const date = parseDate(row.EventDate); if (!date && row.EventDate) { console.warn("Data inválida encontrada em dashboardData:", row.EventDate, row); } return {...row, year: date ? date.getFullYear() : null, month: date ? date.getMonth() : null}; }); allTableData = response.tableData; console.log("Dados processados:", { allDashboardData, allTableData }); document.getElementById('loader').classList.add('d-none'); document.getElementById('mainContent').classList.remove('d-none'); console.log("Loader escondido, conteúdo principal mostrado."); populateGlobalFilters(allDashboardData); applyGlobalFilters(); populateFilters(allTableData); applyFilters(); addEventListeners(); console.log("Listeners de eventos adicionados."); } catch(e) { console.error("Erro fatal dentro de onDataLoaded: ", e); onDataError(e); } }
        function onDataError(error) { console.error('Falha ao carregar ou processar os dados:', error); const loader = document.getElementById('loader'); loader.innerHTML = `<div class="alert alert-danger">Erro ao carregar dados: ${error.message || 'Erro desconhecido'}. Verifique o console para mais detalhes.</div>`; loader.classList.remove('d-none'); document.getElementById('mainContent').classList.add('d-none'); }
        // --- FUNÇÕES DE LÓGICA DO DASHBOARD ---
        function updateKPIs(data) { try { const countIn = (arr, column, value) => arr.filter(row => row && row[column] === value).length; const validData = data.filter(row => row && row.StatusIS !== 'Faltou'); document.getElementById('kpiTotal').textContent = validData.length; document.getElementById('kpiTisSigned').textContent = countIn(validData, 'StatusIS', 'TIS assinado'); document.getElementById('kpiExamesPendentes').textContent = countIn(validData, 'StatusIS', 'AGU exames'); document.getElementById('kpiConclusoesPendentes').textContent = countIn(validData, 'StatusIS', 'Conclusão Pendente'); document.getElementById('kpiVotacaoPendente').textContent = countIn(validData, 'StatusIS', 'Concluída'); document.getElementById('kpiFaltou').textContent = data.length - validData.length; const rotinaData = data.filter(row => row && row.type === 'Rotina'); document.getElementById('kpiMsgEnviada').textContent = countIn(rotinaData, 'MSG', 'ENVIADA'); document.getElementById('kpiAuditoria').textContent = countIn(rotinaData, 'StatusIS', 'Auditoria'); document.getElementById('kpiJsd').textContent = countIn(rotinaData, 'StatusIS', 'JSD'); document.getElementById('kpiMsgPendente').textContent = countIn(rotinaData, 'MSG', 'PENDENTE'); document.getElementById('kpiCancelada').textContent = countIn(rotinaData, 'StatusIS', 'Cancelada'); document.getElementById('kpi-item-cancelada').classList.toggle('text-alert-vivid', countIn(rotinaData, 'StatusIS', 'Cancelada') > 0); document.getElementById('kpi-item-faltas').classList.toggle('text-alert-vivid', (data.length - validData.length) > 0); } catch (e) { console.error("Erro ao atualizar KPIs:", e); } }
        
        function populateFilters(tableData) { 
            try { 
                const purposes = ['Todas as Finalidades', ...new Set(tableData.map(row => row.Finalidade).filter(Boolean).sort())]; 
                const purposeFilter = document.getElementById('purposeFilter'); 
                purposeFilter.innerHTML = ''; 
                purposes.forEach(p => purposeFilter.add(new Option(p, p))); 
                
                const statusMapDisplay = { 'Concluída': 'Votação Pendente' }; 
                const rawStatuses = [...new Set(tableData.map(row => row.StatusIS).filter(Boolean).sort())];
                
                const statusFilter = document.getElementById('statusFilter'); 
                statusFilter.innerHTML = ''; 
                statusFilter.add(new Option('Todos os Status', 'Todos os Status')); 
                
                rawStatuses.forEach(s => {
                    const displayText = statusMapDisplay[s] || s; 
                    const value = s; 
                    statusFilter.add(new Option(displayText, value));
                }); 
                
                console.log("Filtros da tabela populados."); 
            } catch (e) { 
                console.error("Erro ao popular filtros da tabela:", e); 
            } 
        }
        
        // --- FUNÇÃO applyFilters ATUALIZADA ---
        function applyFilters() { 
            console.log("Aplicando filtros da tabela..."); 
            try { 
                const search = document.getElementById('searchInput').value.toLowerCase(); 
                const purpose = document.getElementById('purposeFilter').value; 
                // Lê o estado dos dois chip filters
                const pendingOnly = document.getElementById('pendingMsgFilter').classList.contains('active'); 
                const isPendenteOnly = document.getElementById('isPendenteFilter').classList.contains('active');
                const status = document.getElementById('statusFilter').value; 
                
                console.log("Valores dos filtros:", { search, purpose, status, pendingOnly, isPendenteOnly }); 
                if (!Array.isArray(allTableData)) { throw new Error("allTableData não é um array válido."); } 
                
                const pendingStatusList = ['Conclusão Pendente', 'Concluída', 'Votada JRS']; // 'Concluída' = Votação Pendente, 'Votada JRS' = Assinatura Pendente

                filteredData = allTableData.filter(r => { 
                    const inspecionadoLower = (r && r.Inspecionado) ? r.Inspecionado.toLowerCase() : ''; 
                    const finalidadeMatch = (purpose === 'Todas as Finalidades' || (r && r.Finalidade === purpose)); 
                    const statusMatch = (status === 'Todos os Status' || (r && r.StatusIS === status)); 
                    const pendingMatch = (!pendingOnly || (r && r.MSG === 'PENDENTE')); 
                    // Novo filtro de IS Pendente
                    const isPendenteMatch = (!isPendenteOnly || (r && pendingStatusList.includes(r.StatusIS))); 
                    const searchMatch = (!search || inspecionadoLower.includes(search)); 

                    return searchMatch && finalidadeMatch && statusMatch && pendingMatch && isPendenteMatch; 
                }); 
                
                console.log("Dados filtrados:", filteredData); 
                renderTable(filteredData); 
                initializeTooltips(); 

            } catch(e) { 
                console.error("Erro ao aplicar filtros: ", e); 
                document.getElementById('dataTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">Erro ao filtrar dados: ${e.message}</td></tr>`; 
            } 
        }

        function drawCharts(kpiAndPieData, barChartData) { console.log("Tentando desenhar gráficos..."); google.charts.load('current', {'packages':['corechart']}); google.charts.setOnLoadCallback(() => { console.log("Google Charts carregado."); try { const chartOptions = { backgroundColor: 'transparent', chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' }, animation: { startup: true, duration: 1000, easing: 'out' } }; document.getElementById('finalidadeChartTitle').textContent = 'Finalidades das IS de Rotina'; const rotinaData = kpiAndPieData.filter(r => r && r.type === 'Rotina'); const purposeCounts = rotinaData.reduce((acc, row) => { if(row && row.Finalidade) { acc[row.Finalidade] = (acc[row.Finalidade] || 0) + 1; } return acc; }, {}); const sortedPurposes = Object.entries(purposeCounts).sort(([,a],[,b]) => b - a); let purposeDataArray; if (sortedPurposes.length > 4) { const top3 = sortedPurposes.slice(0, 3); const othersCount = sortedPurposes.slice(3).reduce((sum, [, count]) => sum + count, 0); purposeDataArray = [['Finalidade', 'Quantidade'], ...top3, ['OUTROS', othersCount]]; } else { purposeDataArray = [['Finalidade', 'Quantidade'], ...sortedPurposes]; } const purposeData = google.visualization.arrayToDataTable(purposeDataArray.length > 1 ? purposeDataArray : [['Finalidade', 'Quantidade']]); new google.visualization.PieChart(document.getElementById('purposeDonutChart')).draw(purposeData, { ...chartOptions, pieHole: 0.4 }); console.log("Gráfico de Finalidades desenhado."); const validDataForBarChart = barChartData.filter(row => row && row.StatusIS !== 'Faltou'); const interviewCountsByMonth = validDataForBarChart.reduce((acc, row) => { if (row && row.EventDate) { const monthYear = row.EventDate.substring(3); acc[monthYear] = (acc[monthYear] || 0) + 1; } return acc; }, {}); const sortedMonths = Object.keys(interviewCountsByMonth).sort((a,b) => { const [m1, y1] = a.split('/'); const [m2, y2] = b.split('/'); return new Date(y1, m1 - 1) - new Date(y2, m2 - 1); }); const palette = ['#050f41', '#3e4a85', '#6b74a1', '#98a0bd', '#c5c8da']; const interviewDataArray = [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]]; sortedMonths.forEach((month, index) => { const count = interviewCountsByMonth[month]; const color = palette[index % palette.length]; const shortMonth = new Date(month.split('/')[1], month.split('/')[0]-1).toLocaleString('pt-BR', { month: 'short' }).toUpperCase(); const year = month.split('/')[1]; const axisLabel = `${shortMonth}${year}`; interviewDataArray.push([axisLabel, count, `color: ${color};`, count.toString()]); }); const interviewData = google.visualization.arrayToDataTable(interviewDataArray.length > 1 ? interviewDataArray : [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]]); new google.visualization.ColumnChart(document.getElementById('interviewsBarChart')).draw(interviewData, { ...chartOptions, fontName: 'Carlito', legend: { position: 'none' }, bar: { groupWidth: '60%' }, annotations: { alwaysOutside: true, textStyle: { fontName: 'Oswald', fontSize: 16, bold: true, color: '#212529' }}, hAxis: { textStyle: { fontSize: 14, fontName: 'Oswald', bold: true }}, vAxis: { minValue: 0, gridlines: { color: 'transparent' }, baselineColor: '#ccc', textPosition: 'none'}, chartArea: { width: '90%', height: '70%', top: 40, bottom: 50 }}); console.log("Gráfico de Entrevistas desenhado."); const validDataForPie = kpiAndPieData.filter(row => row && row.StatusIS !== 'Faltou'); const typeCounts = validDataForPie.reduce((acc, row) => { if (row) { const typeName = row.type === 'Rotina' ? 'IS de Rotina' : 'Concursos'; acc[typeName] = (acc[typeName] || 0) + 1; } return acc; }, {}); const tipoInspecaoDataArray = [['Tipo', 'Quantidade'], ...Object.entries(typeCounts)]; const tipoInspecaoData = google.visualization.arrayToDataTable(tipoInspecaoDataArray.length > 1 ? tipoInspecaoDataArray : [['Tipo', 'Quantidade']]); new google.visualization.PieChart(document.getElementById('tipoInspecaoPieChart')).draw(tipoInspecaoData, chartOptions); console.log("Gráfico de Tipo de Inspeção desenhado."); } catch (e) { console.error("Erro ao desenhar os gráficos:", e); document.getElementById('purposeDonutChart').innerHTML = `<div class="alert alert-danger">Erro ao renderizar gráfico.</div>`; document.getElementById('interviewsBarChart').innerHTML = `<div class="alert alert-danger">Erro ao renderizar gráfico.</div>`; document.getElementById('tipoInspecaoPieChart').innerHTML = `<div class="alert alert-danger">Erro ao renderizar gráfico.</div>`; } }); }
        
        // --- FUNÇÃO renderTable ATUALIZADA ---
        function renderTable(dataToRender) { 
            console.log("Iniciando renderTable com ícones de status...");
            const tBody = document.getElementById('dataTableBody'); 
            tBody.innerHTML = ''; 
            if (!Array.isArray(dataToRender)) { console.error("renderTable foi chamada com dados inválidos:", dataToRender); tBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro interno ao processar dados da tabela.</td></tr>'; return; }
            if (dataToRender.length === 0) { console.log("Nenhum dado para renderizar."); tBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum resultado encontrado para os filtros aplicados.</td></tr>'; return; } 
            
            // Mapeamento de Status para Ícone, Cor e Tooltip (ATUALIZADO)
            const statusConfig = {
                'Agendada':             { icon: 'event_available',      color: 'info-color',        tooltipText: 'Agendada'},
                'Auditoria':            { icon: 'quick_reference_all', color: 'warning-color',     tooltipText: 'Em Auditoria'},
                'Cancelada':            { icon: 'event_busy',          color: 'danger-color',      tooltipText: 'Cancelada'},
                'Conclusão Pendente':   { icon: 'help',                color: 'danger-color',      tooltipText: 'Conclusão Pendente'},
                'Concluída':            { icon: 'gavel',               color: 'danger-color',      tooltipText: 'Votação Pendente'}, 
                'Faltou':               { icon: 'disabled_by_default', color: 'danger-color',      tooltipText: 'Faltou'},
                'JSD':                  { icon: 'quick_reference_all', color: 'warning-color',     tooltipText: 'Revisão JSD'},
                'Remarcada':            { icon: 'event_repeat',        color: 'warning-color',     tooltipText: 'Remarcada'},
                'Restituída Auditoria': { icon: 'arrow_circle_left',   color: 'warning-color',     tooltipText: 'Restituída (Auditoria)'},
                'Restituída JSD':       { icon: 'arrow_circle_left',   color: 'warning-color',     tooltipText: 'Restituída (JSD)'},
                'TIS assinado':         { icon: 'assignment_turned_in',color: 'success-color',     tooltipText: 'TIS Assinado'}, 
                'Votada JRS':           { icon: 'unknown_document',    color: 'danger-color',      tooltipText: 'Assinatura Pendente'} 
            };
            
            dataToRender.forEach((row, index) => { 
                try {
                    if (!row) { console.warn(`Item inválido encontrado no índice ${index} dos dados para renderizar.`); return; }
                    
                    const tr = tBody.insertRow(); 
                    
                    const pendingStatuses = ['AGU exames', 'Conclusão Pendente', 'Concluída', 'Votada JRS']; 
                    if (pendingStatuses.includes(row.StatusIS) || row.MSG === 'PENDENTE') { tr.classList.add('table-row-alert'); } 
                    
                    const rawStatus = row.StatusIS || ''; 
                    const config = statusConfig[rawStatus]; 
                    let statusHtml = '';

                    if (config) {
                        statusHtml = `<span class="material-symbols-outlined status-icon" 
                                           style="color: var(--${config.color});" 
                                           data-bs-toggle="tooltip" data-bs-placement="top" title="${config.tooltipText}">
                                           ${config.icon}
                                      </span>`;
                    } else {
                        statusHtml = `<span data-bs-toggle="tooltip" data-bs-placement="top" title="${rawStatus}">${rawStatus}</span>`;
                    }
                    
                    let msgHtml = ''; 
                    const iconMsgStyle = "font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48; font-size: 1.5em; vertical-align: middle;"; 
                    
                    if (row.MSG === 'ENVIADA') { 
                        msgHtml = `<span class="material-symbols-outlined" 
                                        style="${iconMsgStyle} color:var(--success-color);" 
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Mensagem Enviada">mark_email_read</span>`; 
                    } else if (row.MSG === 'PENDENTE') { 
                        msgHtml = `<span class="material-symbols-outlined" 
                                        style="${iconMsgStyle} color:var(--danger-color-vivid);"
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Mensagem Pendente">unsubscribe</span>`; 
                    } else { 
                        msgHtml = row.MSG || ''; 
                    } 
                    
                    const dateAndIsCell = `<td><div class="table-cell-main">${row.DataEntrevista || ''}</div><div class="table-cell-sub">${row.IS || ''}</div></td>`; 
                    
                    let inspecionadoNome = row.Inspecionado || '';
                    const pgq = row['P/G/Q'] || '';
                    const excecoes = ['CANDIDATO', 'DEPEND / PENS'];
                    if (pgq && !excecoes.includes(pgq)) {
                        inspecionadoNome = `${pgq} ${inspecionadoNome}`;
                    }
                    const inspecionadoAndOmCell = `<td><div><div class="table-cell-main">${inspecionadoNome}</div><div class="table-cell-sub">${row.OM || ''}</div></div></td>`; 
                    
                    // Célula de Finalidade agora contém o ícone de ação
                    const finalidadeCell = `<td><div class="actions-cell-content"><span>${row.Finalidade||''}</span><span class="material-symbols-outlined actions-icon" onclick="showDetailsModal(event, ${index})">more_vert</span></div></td>`; 
                    // Célula de Status agora contém apenas o ícone de status
                    const statusCell = `<td>${statusHtml}</td>`; 
                    const msgCell = `<td>${msgHtml}</td>`; 
                    
                    // COLUNAS REORDENADAS
                    tr.innerHTML = statusCell + msgCell + dateAndIsCell +  inspecionadoAndOmCell + finalidadeCell; 
                } catch(e) { 
                    console.error("Erro ao renderizar linha da tabela:", e, "Índice:", index, "Dados da linha:", row); 
                    try { const errorRow = tBody.insertRow(); errorRow.innerHTML = `<td colspan="5" class="text-center text-danger">Erro ao renderizar linha ${index + 1}.</td>`; } 
                    catch (innerError) { console.error("Erro ao inserir linha de erro na tabela:", innerError); }
                }
            }); 
            console.log("renderTable concluída.");
        }

        function showDetailsModal(event, index) { 
            try { 
                if (event) event.stopPropagation(); 
                
                const data = filteredData[index]; 
                if (!data) { throw new Error("Dados não encontrados para o índice: " + index); } 
                
                let inspecionadoNome = data.Inspecionado || '';
                const pgq = data['P/G/Q'] || '';
                const excecoes = ['CANDIDATO', 'DEPEND / PENS'];
                if (pgq && !excecoes.includes(pgq)) {
                    inspecionadoNome = `${pgq} ${inspecionadoNome}`;
                }
                const subtitulo = [inspecionadoNome, data.NIP, data.OM ? `(${data.OM})` : ''].filter(String).join(' - '); 

                document.getElementById('modalDetailsInspecionado').textContent = subtitulo; 
                const finalidadeStatus = [data.Finalidade, data.StatusIS].filter(String).join(' - '); 
                const finalidadeElement = document.getElementById('modalDetailsFinalidade'); 
                finalidadeElement.textContent = finalidadeStatus; 
                if (data.MSG === 'ENVIADA') { finalidadeElement.style.color = 'var(--success-color)'; } 
                else { finalidadeElement.style.color = 'var(--danger-color-vivid)'; } 
                const fields = [ { id: 'modalDetailsLaudo', value: data.Laudo, sectionId: 'laudo-section' }, { id: 'modalDetailsRestricoes', value: data.Restrições, sectionId: 'restricoes-section' }, { id: 'modalDetailsDataLaudo', value: data.DataLaudo, sectionId: 'dataLaudo-section' }, { id: 'modalDetailsTis', value: data.TIS, sectionId: 'tis-section' }, { id: 'modalDetailsDs1a', value: data['DS-1a'], sectionId: 'ds1a-section' } ]; 
                fields.forEach(field => { const element = document.getElementById(field.id); const section = document.getElementById(field.sectionId); if (field.value) { element.textContent = field.value; section.classList.remove('d-none'); } else { element.textContent = ''; section.classList.add('d-none'); } }); 
                const minutaSection = document.getElementById('minuta-msg-section'); 
                if (data.MSG === 'ENVIADA' || data.MSG === 'Enviada') { 
                    const subtituloMinuta = [data['P/G/Q'], data.NIP, data.Inspecionado, data.OM ? `(${data.OM})` : ''].filter(String).join(' '); 
                    let minutaText = `INSPEÇÃO DE SAÚDE FIM ${data.Finalidade || 'não informada'} - ${subtituloMinuta} \n\nALFA - PTC que a JRS/HNRe concluiu em ${data.DataLaudo || 'data não informada'} a IS FIM ${data.Finalidade || 'não informada'} atinente ao ${subtituloMinuta} e exarou o seguinte laudo: "${data.Laudo || 'não informado'}"`; 
                    if (data.Restrições && data.Restrições.toUpperCase() !== 'LTS') { minutaText += ` Deverá ser afastado de: ${data.Restrições}. `; } 
                    minutaText += ` ACD TIS nº ${data.TIS || 'não informado'}; e \n\nBRAVO - O REF TIS (modelo DS-1A) pode ser verificado digitalmente por meio do acesso ao sítio "https://sinais.dsm.mb/tisonline", informando o código de validação "${data['DS-1a'] || 'não informado'}" e selecionando a opção “Download do TIS” BT`; 
                    document.getElementById('modalMinutaMsgText').textContent = minutaText; 
                    minutaSection.classList.remove('d-none'); 
                } else { 
                    minutaSection.classList.add('d-none'); 
                } 
                detailsModalInstance.show(); 
            } catch (e) { 
                console.error("Erro ao mostrar detalhes no modal:", e); 
                alert("Não foi possível carregar os detalhes desta inspeção."); 
            } 
        }

        
        function populateGlobalFilters(data) { 
            try { 
                const yearFilter = document.getElementById('yearFilter'); 
                const monthFilter = document.getElementById('monthFilter'); 
                const years = [...new Set(data.map(r => r && r.year).filter(Boolean))].sort((a,b) => b - a); 
                yearFilter.innerHTML = '<option value="todos">Todos os Anos</option>'; 
                years.forEach(y => yearFilter.add(new Option(y, y))); 
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; 
                monthFilter.innerHTML = '<option value="todos">Todos os Meses</option>'; 
                monthNames.forEach((name, index) => monthFilter.add(new Option(name, index))); 
                
                const currentDate = new Date(); 
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); 
                
                if (years.length > 0) { 
                    if (years.includes(currentYear)) {
                        yearFilter.value = currentYear;
                    } else {
                        yearFilter.value = years[0]; 
                    }
                } 
                
                monthFilter.value = currentMonth; 
                console.log("Filtros globais populados."); 
            } catch (e) { 
                console.error("Erro ao popular filtros globais:", e); 
            } 
        }

        function applyGlobalFilters() { console.log("Aplicando filtros globais..."); try { const year = document.getElementById('yearFilter').value; const month = document.getElementById('monthFilter').value; const yearFilteredData = allDashboardData.filter(row => row && (year === 'todos' || row.year == year)); const fullyFilteredData = yearFilteredData.filter(row => row && (month === 'todos' || row.month == month)); console.log("Dados filtrados globalmente:", fullyFilteredData); updateKPIs(fullyFilteredData); drawCharts(fullyFilteredData, yearFilteredData); } catch (e) { console.error("Erro ao aplicar filtros globais:", e); } }
        function parseDate(dateString) { try { if (!dateString || typeof dateString !== 'string' || !dateString.includes('/')) return null; const parts = dateString.split('/'); if (parts.length !== 3) return null; const year = parseInt(parts[2], 10) < 100 ? 2000 + parseInt(parts[2], 10) : parseInt(parts[2], 10); const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; if (isNaN(day) || isNaN(month) || isNaN(year)) return null; const date = new Date(year, month, day); if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null; return date; } catch (e) { console.error("Erro ao parsear data:", dateString, e); return null; } }
        
        // --- FUNÇÃO addEventListeners ATUALIZADA ---
        function addEventListeners() { 
            try { 
                document.getElementById('yearFilter').addEventListener('change', applyGlobalFilters); 
                document.getElementById('monthFilter').addEventListener('change', applyGlobalFilters); 
                document.getElementById('searchInput').addEventListener('keyup', applyFilters); 
                document.getElementById('purposeFilter').addEventListener('change', applyFilters); 
                document.getElementById('statusFilter').addEventListener('change', applyFilters); 
                
                // Listener para o chip IS PENDENTES (NOVO)
                const isPendenteChip = document.getElementById('isPendenteFilter');
                isPendenteChip.addEventListener('click', () => {
                    isPendenteChip.classList.toggle('active'); 
                    applyFilters(); 
                });
                
                // Listener para o chip MSG PENDENTE (Atualizado)
                const pendingFilterChip = document.getElementById('pendingMsgFilter');
                pendingFilterChip.addEventListener('click', () => {
                    pendingFilterChip.classList.toggle('active'); 
                    applyFilters(); 
                });
            } catch (e) { 
                console.error("Erro ao adicionar event listeners:", e); 
                onDataError(new Error("Não foi possível configurar os filtros interativos.")); 
            } 
        }
    </script>
    <script>
      let BASE_URL = '';
      function navigateTo(page) { if (BASE_URL) { console.log(`Navegando para: ${BASE_URL}?page=${page}`); window.top.location.href = BASE_URL + '?page=' + page; } else { console.warn("BASE_URL ainda não carregada, não foi possível navegar."); alert("Aguarde o carregamento completo da página e tente novamente."); } }
      document.addEventListener('DOMContentLoaded', () => { google.script.run.withSuccessHandler((url) => { console.log("URL base do Web App recebida:", url); BASE_URL = url; }).withFailureHandler((error) => { console.error("Falha ao obter URL base do Web App:", error); alert("Erro crítico: Não foi possível configurar a navegação entre páginas."); }).getWebAppUrl(); });
    </script>
</body>
</html>
