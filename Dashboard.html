<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Controle JRS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <script type="module" src="https://cdn.jsdelivr.net/npm/@material/web/all.js/+esm"></script>
  
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <style>
    /* --- Material Design 3 Tokens & Globals --- */
    :root {
      /* Paleta de Cores (Tokens) */
      --md-sys-color-primary: #050F41;
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-secondary: #5A5D72;
      --md-sys-color-on-secondary: #FFFFFF;
      --md-sys-color-background: #F5F5F5;
      --md-sys-color-surface: #FFFFFF;
      --md-sys-color-surface-container-high: #F0F0F0;
      --md-sys-color-on-surface: #1C1B1F;
      --md-sys-color-on-surface-variant: #49454F;
      --md-sys-color-outline: #79747E;
      --md-sys-color-error: #B3261E;

      /* Tipografia (Tokens) */
      --md-sys-font-family-headline: 'Montserrat', sans-serif;
      --md-sys-font-family-body: 'Carlito', sans-serif;

      /* Shape */
      --md-sys-shape-corner-medium: 12px;
      --md-sys-shape-corner-large: 16px;
    }

    /* Estilos Globais */
    body {
      font-family: var(--md-sys-font-family-body);
      background-color: var(--md-sys-color-background);
      color: var(--md-sys-color-on-surface);
      margin: 0;
      padding: 24px;
      box-sizing: border-box;
    }

    /* Tipografia */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--md-sys-font-family-headline);
      color: var(--md-sys-color-primary);
      font-weight: 500;
    }
    
    h1 { font-size: 2rem; margin-bottom: 16px; }
    h2 { font-size: 1.5rem; margin-bottom: 12px; }
    h3 { font-size: 1.25rem; margin: 20px 0 10px 0; }
    
    /* Componente Principal */
    md-elevated-card {
      background-color: var(--md-sys-color-surface);
      border-radius: var(--md-sys-shape-corner-medium);
      padding: 24px;
      margin-bottom: 24px;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Layout Helpers */
    .button-container {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 24px;
    }
    
    /* Icon styling */
    .material-symbols-outlined {
      vertical-align: middle;
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    /* Navegação */
    .header-actions {
      display: flex;
      justify-content: flex-end;
      gap: 16px;
      margin-bottom: 16px;
    }
    .IconButton {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-primary);
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      text-decoration: none;
    }
    .IconButton:hover {
      background-color: rgba(5, 15, 65, 0.1);
    }
    .IconButton .material-symbols-outlined {
      font-size: 24px;
    }

    /* --- Estilos Específicos do Dashboard --- */

    /* Filtros Globais */
    .filters-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }
    
    .filters-container md-outlined-select {
      min-width: 150px;
      flex: 1;
      margin-bottom: 0; /* Remover margem inferior no container flex */
      --md-outlined-select-container-shape: var(--md-sys-shape-corner-medium);
    }
    
    .filters-container md-filled-button {
      flex-shrink: 0;
    }

    /* KPIs */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .kpi-card {
      padding: 16px;
      margin-bottom: 0; /* Gerenciado pelo grid gap */
      text-align: center;
    }
    
    .kpi-card h3 {
      font-size: 1rem;
      color: var(--md-sys-color-on-surface-variant);
      margin: 0 0 8px 0;
    }
    
    .kpi-card p {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--md-sys-color-primary);
      margin: 0;
    }

    /* Gráficos */
    .chart-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .chart-card {
      padding: 16px;
      margin-bottom: 0;
      box-sizing: border-box;
    }
    
    .chart-card h3 {
      text-align: center;
      margin-top: 0;
    }
    
    /* Estilos da Tabela (Mantidos conforme original) */
    .table-container {
      /* O wrapper .table-container vira o card */
      padding: 24px;
    }
    
    .chip-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .chip {
      padding: 5px 12px;
      border-radius: 16px;
      background-color: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-on-surface-variant);
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.3s;
    }
    
    .chip.active {
      background-color: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      font-weight: 500;
    }

    .data-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    #data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    #data-table th, #data-table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    
    #data-table th {
      background-color: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-primary);
      font-family: var(--md-sys-font-family-headline);
    }
    
    /* Estilos dos ícones de ação (Mantidos) */
    .action-icon {
      cursor: pointer;
      color: var(--md-sys-color-secondary);
      font-size: 20px;
    }
    .action-icon:hover {
      color: var(--md-sys-color-primary);
    }
    .status-icon {
      font-size: 20px;
    }
    /* Cores de status (Mantidas) */
    .status-Agendada { color: #FFA500; } /* Laranja */
    .status-Concluída { color: #4CAF50; } /* Verde */
    .status-Cancelada { color: #F44336; } /* Vermelho */
    .status-Faltou { color: #9E9E9E; } /* Cinza */
    .status-Remarcada { color: #2196F3; } /* Azul */
    
    /* Loader */
    #loader {
      display: flex; /* Alterado para flex para centralizar */
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 1000;
    }
    md-circular-progress {
      --md-circular-progress-size: 64px;
    }

    /* Modais (Estilizados para parecer M3, mas mantendo a lógica JS) */
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      /* Aplicando o estilo de card aqui */
      background-color: var(--md-sys-color-surface);
      border-radius: var(--md-sys-shape-corner-large); /* Dialogs usam shape maior */
      padding: 24px;
      margin: 15% auto;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .modal-content h3 {
      margin-top: 0;
      color: var(--md-sys-color-primary);
    }
    
    /* Inputs do Modal */
    .modal-content md-outlined-text-field,
    .modal-content md-outlined-select {
       width: 100%;
       margin-bottom: 16px;
      --md-outlined-text-field-container-shape: var(--md-sys-shape-corner-medium);
      --md-outlined-select-container-shape: var(--md-sys-shape-corner-medium);
    }
    
    /* Botões do Modal */
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 24px;
    }

  </style>
</head>
<body>

  <div class="header-actions">
      <div class="IconButton" onclick="navigateTo('formulario')" title="Formulário de Inspeção">
        <span class="material-symbols-outlined">description</span>
      </div>
      <div class="IconButton" onclick="navigateTo('parecer')" title="Gerar Parecer">
        <span class="material-symbols-outlined">edit_note</span>
      </div>
  </div>

  <h1>Dashboard de Inspeções</h1>

  <md-elevated-card class="filters-container">
    <md-outlined-select label="Ano" id="yearFilter">
      </md-outlined-select>
    <md-outlined-select label="Mês" id="monthFilter">
      </md-outlined-select>
    <md-filled-button id="applyFilterButton">
      Aplicar Filtros
      <span class="material-symbols-outlined" slot="icon">filter_alt</span>
    </md-filled-button>
  </md-elevated-card>

  <div class="kpi-container">
    <md-elevated-card class="kpi-card">
      <h3>Total Agendado</h3>
      <p id="kpi-total">0</p>
    </md-elevated-card>
    <md-elevated-card class="kpi-card">
      <h3>Concluídas</h3>
      <p id="kpi-concluidas">0</p>
    </md-elevated-card>
    <md-elevated-card class="kpi-card">
      <h3>Pendentes</h3>
      <p id="kpi-pendentes">0</p>
    </md-elevated-card>
    <md-elevated-card class="kpi-card">
      <h3>Faltas</h3>
      <p id="kpi-faltas">0</p>
    </md-elevated-card>
  </div>

  <div class="chart-container">
    <md-elevated-card class="chart-card">
      <h3>Inspeções por Status (Concursos)</h3>
      <div id="concursosChartContainer" style="width: 100%; height: 300px;"></div>
    </md-elevated-card>
    <md-elevated-card class="chart-card">
      <h3>Inspeções por Finalidade (Controle)</h3>
      <div id="finalidadeChartContainer" style="width: 100%; height: 300px;"></div>
    </md-elevated-card>
  </div>

  <md-elevated-card class="table-container">
    <h2>Lista de Inspeções</h2>
    
    <div class="chip-filters" id="chip-filters">
      <div class="chip active" data-filter="Agendada">Agendadas</div>
      <div class="chip" data-filter="Remarcada">Remarcadas</div>
      <div class="chip" data-filter="Concluída">Concluídas</div>
      <div class="chip" data-filter="Faltou">Faltas</div>
      <div class="chip" data-filter="Cancelada">Canceladas</div>
    </div>
    
    <div class="data-table-wrapper">
      <table id="data-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Data</th>
            <th>NIP</th>
            <th>Inspecionado</th>
            <th>OM</th>
            <th>Finalidade</th>
            <th>MSG</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="table-body">
          </tbody>
      </table>
    </div>
  </md-elevated-card>

  <div id="loader" style="display: none;">
    <md-circular-progress indeterminate></md-circular-progress>
  </div>

  <div id="remarcarModal" class="modal">
    <div class="modal-content">
      <h3>Remarcar Inspeção</h3>
      <p>Selecione a nova data para <strong id="remarcarNome"></strong>.</p>
      <md-outlined-text-field
        label="Nova Data"
        type="date"
        id="novaData">
      </md-outlined-text-field>
      <div class="modal-buttons">
        <md-text-button onclick="closeRemarcarModal()">Cancelar</md-text-button>
        <md-filled-button id="confirmRemarcarButton">Remarcar</md-filled-button>
      </div>
    </div>
  </div>

  <div id="statusModal" class="modal">
    <div class="modal-content">
      <h3>Alterar Status da Mensagem</h3>
      <p>Alterar status da MSG para <strong id="statusNome"></strong>.</p>
      <md-outlined-select label="Novo Status" id="statusSelect">
        <md-menu-item value="ENVIADA">ENVIADA</md-menu-item>
        <md-menu-item value="LIDA">LIDA</md-menu-item>
        <md-menu-item value="RESPONDIDA">RESPONDIDA</md-menu-item>
        <md-menu-item value="">Limpar</md-menu-item>
      </md-outlined-select>
      <div class="modal-buttons">
        <md-text-button onclick="closeStatusModal()">Cancelar</md-text-button>
        <md-filled-button id="confirmStatusButton">Confirmar</md-filled-button>
      </div>
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let allDashboardData = []; let allTableData = []; let filteredData = []; 
        let detailsModalInstance;
        let editModalInstance; // Variável global existente
        let remarcarModalInstance; // <-- NOVA VARIÁVEL GLOBAL
        let allRestricoes = []; // Nova variável global
        let tooltipList = []; 

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => { 
            console.log("DOM Carregado. Inicializando..."); 
            detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal')); 
            editModalInstance = new bootstrap.Modal(document.getElementById('editModal')); // Inicializa o modal de edição
            remarcarModalInstance = new bootstrap.Modal(document.getElementById('remarcarModal')); // <-- INICIALIZA O NOVO MODAL

            document.getElementById('loader').classList.remove('d-none'); 
            document.getElementById('mainContent').classList.add('d-none'); 
            initializeTooltips(); 
            
            // Adiciona listener para o formulário do modal de edição
            document.getElementById('editForm').addEventListener('submit', handleEditFormSubmit);
            // Adiciona listener para o formulário do novo modal de remarcação
            document.getElementById('remarcarForm').addEventListener('submit', handleRemarcarFormSubmit); // <-- ADICIONA LISTENER

            google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataError).getDashboardData(); 
            console.log("Chamada para getDashboardData enviada."); 
        });

        // --- FUNÇÃO PARA INICIALIZAR TOOLTIPS ---
        function initializeTooltips() {
            console.log("Inicializando tooltips...");
            tooltipList.forEach(tooltip => tooltip.dispose());
            tooltipList = [];
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {html: true}); 
            });
            console.log(`${tooltipList.length} tooltips inicializados.`);
        }

        // --- CALLBACKS DE CARREGAMENTO DE DADOS (ATUALIZADO) ---
        function onDataLoaded(response) { 
            console.log("Dados recebidos do backend:", response); 
            try { 
                if (!response || !Array.isArray(response.dashboardData) || !Array.isArray(response.tableData) || !Array.isArray(response.restricoesOptions)) { 
                    throw new Error("Formato de dados recebido do backend é inválido (faltando dashboardData, tableData ou restricoesOptions)."); 
                } 
                allDashboardData = response.dashboardData.map(row => { const date = parseDate(row.EventDate); if (!date && row.EventDate) { console.warn("Data inválida encontrada em dashboardData:", row.EventDate, row); } return {...row, year: date ? date.getFullYear() : null, month: date ? date.getMonth() : null}; }); 
                allTableData = response.tableData; 
                allRestricoes = response.restricoesOptions; // Salva a lista de restrições
                
                console.log("Dados processados:", { allDashboardData, allTableData, allRestricoes }); 
                document.getElementById('loader').classList.add('d-none'); 
                document.getElementById('mainContent').classList.remove('d-none'); 
                console.log("Loader escondido, conteúdo principal mostrado."); 
                
                populateGlobalFilters(allDashboardData); 
                applyGlobalFilters(); 
                populateFilters(allTableData);
                populateEditModalOptions(allRestricoes); // Popula o novo modal
                applyFilters(); 
                addEventListeners(); 
                console.log("Listeners de eventos adicionados."); 
            } catch(e) { 
                console.error("Erro fatal dentro de onDataLoaded: ", e); 
                onDataError(e); 
            } 
        }
        function onDataError(error) { console.error('Falha ao carregar ou processar os dados:', error); const loader = document.getElementById('loader'); loader.innerHTML = `<div class="alert alert-danger">Erro ao carregar dados: ${error.message || 'Erro desconhecido'}. Verifique o console para mais detalhes.</div>`; loader.classList.remove('d-none'); document.getElementById('mainContent').classList.add('d-none'); }
        
        // --- FUNÇÕES DE LÓGICA DO DASHBOARD ---
        function updateKPIs(data) { try { const countIn = (arr, column, value) => arr.filter(row => row && row[column] === value).length; const validData = data.filter(row => row && row.StatusIS !== 'Faltou'); document.getElementById('kpiTotal').textContent = validData.length; document.getElementById('kpiTisSigned').textContent = countIn(validData, 'StatusIS', 'TIS assinado'); document.getElementById('kpiExamesPendentes').textContent = countIn(validData, 'StatusIS', 'AGU exames'); document.getElementById('kpiConclusoesPendentes').textContent = countIn(validData, 'StatusIS', 'Conclusão Pendente'); document.getElementById('kpiVotacaoPendente').textContent = countIn(validData, 'StatusIS', 'Concluída'); document.getElementById('kpiFaltou').textContent = data.length - validData.length; const rotinaData = data.filter(row => row && row.type === 'Rotina'); document.getElementById('kpiMsgEnviada').textContent = countIn(rotinaData, 'MSG', 'ENVIADA'); document.getElementById('kpiAuditoria').textContent = countIn(rotinaData, 'StatusIS', 'Auditoria'); document.getElementById('kpiJsd').textContent = countIn(rotinaData, 'StatusIS', 'JSD'); document.getElementById('kpiMsgPendente').textContent = countIn(rotinaData, 'MSG', 'PENDENTE'); document.getElementById('kpiCancelada').textContent = countIn(rotinaData, 'StatusIS', 'Cancelada'); document.getElementById('kpi-item-cancelada').classList.toggle('text-alert-vivid', countIn(rotinaData, 'StatusIS', 'Cancelada') > 0); document.getElementById('kpi-item-faltas').classList.toggle('text-alert-vivid', (data.length - validData.length) > 0); } catch (e) { console.error("Erro ao atualizar KPIs:", e); } }
        
        // --- FUNÇÃO populateFilters (CORRIGIDA) ---
        function populateFilters(tableData) { 
            try { 
                const purposeMenu = document.getElementById('purposeFilterMenu');
                purposeMenu.innerHTML = ''; // Limpa
                const purposes = [...new Set(tableData.map(row => row.Finalidade).filter(Boolean).sort())]; 
                
                purposeMenu.innerHTML += '<li><button class="dropdown-item" type="button" id="clearPurposeFilter">Limpar Seleção</button></li>';
                purposeMenu.innerHTML += '<li><hr class="dropdown-divider"></li>';

                purposes.forEach((p, index) => {
                  const li = document.createElement('li');
                  const uniqueId = 'check-purpose-' + index; 
                  li.innerHTML = `
                    <div class="purpose-item-wrapper form-check">
                      <input type="checkbox" class="form-check-input purpose-filter-item" value="${p}" id="${uniqueId}">
                      <label class="form-check-label" for="${uniqueId}">${p}</label>
                    </div>
                  `;
                  purposeMenu.appendChild(li);
                });
                
                console.log("Filtros da tabela populados (Finalidade com checkboxes corrigido)."); 
            } catch (e) { 
                console.error("Erro ao popular filtros da tabela:", e); 
            } 
        }

        // --- NOVA FUNÇÃO PARA POPULAR O MODAL DE EDIÇÃO ---
        function populateEditModalOptions(restricoes) {
          try {
            const container = document.getElementById('editRestricoesBody');
            container.innerHTML = ''; // Limpa
            
            restricoes.forEach((item, index) => {
              const uniqueId = 'edit-check-' + index;
              const isOutros = item === 'Outros';
              
              const div = document.createElement('div');
              div.className = 'form-check';
              div.innerHTML = `
                <input class="form-check-input edit-restricao-item" type="checkbox" value="${item}" id="${uniqueId}">
                <label class="form-check-label" for="${uniqueId}">${item}</label>
              `;
              
              // Adiciona o listener de 'Outros'
              if (isOutros) {
                div.querySelector('input').addEventListener('click', function() {
                  toggleEditOutros(this.checked);
                });
              }
              
              container.appendChild(div);
            });
            console.log("Modal de edição populado com restrições.");
          } catch(e) {
            console.error("Erro ao popular restrições do modal de edição:", e);
          }
        }
        
        // --- NOVA FUNÇÃO AUXILIAR PARA O MODAL DE EDIÇÃO ---
        function toggleEditOutros(checked) {
          document.getElementById('editOutrosRestricaoContainer').classList.toggle('d-none', !checked);
        }

        // --- NOVA FUNÇÃO AUXILIAR PARA MÁSCARA TIS ---
        function applyTISMask(input) {
          let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
          if (value.length > 11) value = value.substring(0, 11); // Limita a 11 dígitos
          
          let maskedValue = '';
          if (value.length > 6) {
            maskedValue = `${value.substring(0, 3)}.${value.substring(3, 6)}.${value.substring(6)}`;
          } else if (value.length > 3) {
            maskedValue = `${value.substring(0, 3)}.${value.substring(3)}`;
          } else {
            maskedValue = value;
          }
          input.value = maskedValue;
        }
        
        // --- FUNÇÃO applyFilters ATUALIZADA ---
        function applyFilters() { 
            console.log("Aplicando filtros da tabela..."); 
            try { 
                const search = document.getElementById('searchInput').value.toLowerCase(); 
                
                const selectedPurposes = Array.from(document.querySelectorAll('.purpose-filter-item:checked'))
                                               .map(cb => cb.value);
                
                const pendingMsgOnly = document.getElementById('pendingMsgFilter').classList.contains('active'); 
                const isPendenteOnly = document.getElementById('isPendenteFilter').classList.contains('active');
                const revisaoOnly = document.getElementById('revisaoFilter').classList.contains('active');
                const restituidaOnly = document.getElementById('restituidaFilter').classList.contains('active');
                const agendadasOnly = document.getElementById('agendadasFilter').classList.contains('active');
                const faltasOnly = document.getElementById('faltasFilter').classList.contains('active');
                const canceladasOnly = document.getElementById('canceladasFilter').classList.contains('active');

                if (!Array.isArray(allTableData)) { throw new Error("allTableData não é um array válido."); } 
                
                const pendingStatusList = ['Conclusão Pendente', 'Concluída', 'Votada JRS']; 

                filteredData = allTableData.filter(r => { 
                    if (!r) return false;
                    const inspecionadoLower = (r.Inspecionado || '').toLowerCase(); 
                    const finalidadeMatch = (selectedPurposes.length === 0 || selectedPurposes.includes(r.Finalidade));
                    const searchMatch = (!search || inspecionadoLower.includes(search)); 
                    const pendingMsgMatch = (!pendingMsgOnly || r.MSG === 'PENDENTE'); 
                    const isPendenteMatch = (!isPendenteOnly || pendingStatusList.includes(r.StatusIS));
                    const emRevisaoMatch = (!revisaoOnly || (r.StatusIS === 'Auditoria' || r.StatusIS === 'JSD'));
                    const restituidaMatch = (!restituidaOnly || (r.StatusIS === 'Restituída Auditoria' || r.StatusIS === 'Restituída JSD'));
                    const agendadasMatch = (!agendadasOnly || r.StatusIS === 'Agendada');
                    const faltasMatch = (!faltasOnly || r.StatusIS === 'Faltou');
                    const canceladasMatch = (!canceladasOnly || r.StatusIS === 'Cancelada');
                    return searchMatch && finalidadeMatch && pendingMsgMatch && isPendenteMatch && emRevisaoMatch && restituidaMatch && agendadasMatch && faltasMatch && canceladasMatch; 
                }); 
                
                renderTable(filteredData); 
                initializeTooltips(); 

            } catch(e) { 
                console.error("Erro ao aplicar filtros: ", e); 
                document.getElementById('dataTableBody').innerHTML = `<tr><td colspan="4" class="text-center text-danger">Erro ao filtrar dados: ${e.message}</td></tr>`; 
            } 
        }

        // --- FUNÇÃO AUXILIAR (Texto Botão Finalidade) ---
        function updatePurposeButtonText() {
          try {
            const button = document.getElementById('purposeFilterButton');
            const selectedCount = document.querySelectorAll('.purpose-filter-item:checked').length;
            if (selectedCount === 0) {
              button.textContent = 'Finalidades';
            } else {
              button.textContent = `Finalidades (${selectedCount})`;
            }
          } catch(e) {
            console.error("Erro ao atualizar texto do botão de finalidade:", e);
          }
        }

        function drawCharts(kpiAndPieData, barChartData) { console.log("Tentando desenhar gráficos..."); google.charts.load('current', {'packages':['corechart']}); google.charts.setOnLoadCallback(() => { console.log("Google Charts carregado."); try { const chartOptions = { backgroundColor: 'transparent', chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' }, animation: { startup: true, duration: 1000, easing: 'out' } }; document.getElementById('finalidadeChartTitle').textContent = 'Finalidades das IS de Rotina'; const rotinaData = kpiAndPieData.filter(r => r && r.type === 'Rotina'); const purposeCounts = rotinaData.reduce((acc, row) => { if(row && row.Finalidade) { acc[row.Finalidade] = (acc[row.Finalidade] || 0) + 1; } return acc; }, {}); const sortedPurposes = Object.entries(purposeCounts).sort(([,a],[,b]) => b - a); let purposeDataArray; if (sortedPurposes.length > 4) { const top3 = sortedPurposes.slice(0, 3); const othersCount = sortedPurposes.slice(3).reduce((sum, [, count]) => sum + count, 0); purposeDataArray = [['Finalidade', 'Quantidade'], ...top3, ['OUTROS', othersCount]]; } else { purposeDataArray = [['Finalidade', 'Quantidade'], ...sortedPurposes]; } const purposeData = google.visualization.arrayToDataTable(purposeDataArray.length > 1 ? purposeDataArray : [['Finalidade', 'Quantidade']]); new google.visualization.PieChart(document.getElementById('purposeDonutChart')).draw(purposeData, { ...chartOptions, pieHole: 0.4 }); console.log("Gráfico de Finalidades desenhado."); const validDataForBarChart = barChartData.filter(row => row && row.StatusIS !== 'Faltou'); const interviewCountsByMonth = validDataForBarChart.reduce((acc, row) => { if (row && row.EventDate) { const monthYear = row.EventDate.substring(3); acc[monthYear] = (acc[monthYear] || 0) + 1; } return acc; }, {}); const sortedMonths = Object.keys(interviewCountsByMonth).sort((a,b) => { const [m1, y1] = a.split('/'); const [m2, y2] = b.split('/'); return new Date(y1, m1 - 1) - new Date(y2, m2 - 1); }); const palette = ['#050f41', '#3e4a85', '#6b74a1', '#98a0bd', '#c5c8da']; const interviewDataArray = [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]]; sortedMonths.forEach((month, index) => { const count = interviewCountsByMonth[month]; const color = palette[index % palette.length]; const shortMonth = new Date(month.split('/')[1], month.split('/')[0]-1).toLocaleString('pt-BR', { month: 'short' }).toUpperCase(); const year = month.split('/')[1]; const axisLabel = `${shortMonth}${year}`; interviewDataArray.push([axisLabel, count, `color: ${color};`, count.toString()]); }); const interviewData = google.visualization.arrayToDataTable(interviewDataArray.length > 1 ? interviewDataArray : [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]]); new google.visualization.ColumnChart(document.getElementById('interviewsBarChart')).draw(interviewData, { ...chartOptions, fontName: 'Carlito', legend: { position: 'none' }, bar: { groupWidth: '60%' }, annotations: { alwaysOutside: true, textStyle: { fontName: 'Oswald', fontSize: 16, bold: true, color: '#212529' }}, hAxis: { textStyle: { fontSize: 14, fontName: 'Oswald', bold: true }}, vAxis: { minValue: 0, gridlines: { color: 'transparent' }, baselineColor: '#ccc', textPosition: 'none'}, chartArea: { width: '90%', height: '70%', top: 40, bottom: 50 }}); console.log("Gráfico de Entrevistas desenhado."); const validDataForPie = kpiAndPieData.filter(row => row && row.StatusIS !== 'Faltou'); const typeCounts = validDataForPie.reduce((acc, row) => { if (row) { const typeName = row.type === 'Rotina' ? 'IS de Rotina' : 'Concursos'; acc[typeName] = (acc[typeName] || 0) + 1; } return acc; }, {}); const tipoInspecaoDataArray = [['Tipo', 'Quantidade'], ...Object.entries(typeCounts)]; const tipoInspecaoData = google.visualization.arrayToDataTable(tipoInspecaoDataArray.length > 1 ? tipoInspecaoDataArray : [['Tipo', 'Quantidade']]); new google.visualization.PieChart(document.getElementById('tipoInspecaoPieChart')).draw(tipoInspecaoData, chartOptions); console.log("Gráfico de Tipo de Inspeção desenhado."); } catch (e) { console.error("Erro ao desenhar os gráficos:", e); document.getElementById('purposeDonutChart').innerHTML = `<div class="alert alert-danger">Erro ao renderizar gráfico.</div>`; document.getElementById('interviewsBarChart').innerHTML = `<div class="alert alert-danger">Erro ao renderizar gráfico.</div>`; document.getElementById('tipoInspecaoPieChart').innerHTML = `<div class="alert alert-danger">Erro ao renderizar gráfico.</div>`; } }); }
        
        // --- FUNÇÃO renderTable (ATUALIZADA) ---
        function renderTable(dataToRender) { 
            console.log("Iniciando renderTable com ícones de status...");
            const tBody = document.getElementById('dataTableBody'); 
            tBody.innerHTML = ''; 
            if (!Array.isArray(dataToRender)) { console.error("renderTable foi chamada com dados inválidos:", dataToRender); tBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Erro interno ao processar dados da tabela.</td></tr>`; return; } 
            if (dataToRender.length === 0) { console.log("Nenhum dado para renderizar."); tBody.innerHTML = `<tr><td colspan="4" class="text-center">Nenhum resultado encontrado para os filtros aplicados.</td></tr>`; return; } 
            
            const statusConfig = {
                'Agendada':             { icon: 'event_available',      color: 'info-color',        tooltipText: 'Agendada'},
                'Auditoria':            { icon: 'quick_reference_all', color: 'warning-color',     tooltipText: 'Em Auditoria'},
                'Cancelada':            { icon: 'event_busy',          color: 'danger-color',      tooltipText: 'Cancelada'},
                'Conclusão Pendente':   { icon: 'help',                color: 'danger-color',      tooltipText: 'Conclusão Pendente'},
                'Concluída':            { icon: 'gavel',               color: 'danger-color',      tooltipText: 'Votação Pendente'}, 
                'Faltou':               { icon: 'disabled_by_default', color: 'danger-color',      tooltipText: 'Faltou'},
                'JSD':                  { icon: 'quick_reference_all', color: 'warning-color',     tooltipText: 'Revisão JSD'},
                'Remarcada':            { icon: 'event_repeat',        color: 'warning-color',     tooltipText: 'Remarcada'}, // <-- COR ATUALIZADA PARA WARNING
                'Restituída Auditoria': { icon: 'arrow_circle_left',   color: 'warning-color',     tooltipText: 'Restituída (Auditoria)'},
                'Restituída JSD':       { icon: 'arrow_circle_left',   color: 'warning-color',     tooltipText: 'Restituída (JSD)'},
                'TIS assinado':         { icon: 'assignment_turned_in',color: 'success-color',     tooltipText: 'TIS Assinado'}, 
                'Votada JRS':           { icon: 'unknown_document',    color: 'danger-color',      tooltipText: 'Assinatura Pendente'} 
            };
            
            dataToRender.forEach((row, index) => { 
                try {
                    if (!row) { console.warn(`Item inválido encontrado no índice ${index} dos dados para renderizar.`); return; }
                    
                    const tr = tBody.insertRow(); 
                    
                    const pendingStatuses = ['AGU exames', 'Conclusão Pendente', 'Concluída', 'Votada JRS']; 
                    if (pendingStatuses.includes(row.StatusIS) || row.MSG === 'PENDENTE') { tr.classList.add('table-row-alert'); } 
                    
                    const rawStatus = row.StatusIS || ''; 
                    const config = statusConfig[rawStatus]; 
                    let statusHtml = '';

                    if (config) {
                        statusHtml = `<span class="material-symbols-outlined status-icon" 
                                           style="color: var(--${config.color});" 
                                           data-bs-toggle="tooltip" data-bs-placement="top" title="${config.tooltipText}">
                                           ${config.icon}
                                      </span>`;
                    } else {
                        statusHtml = `<span data-bs-toggle="tooltip" data-bs-placement="top" title="${rawStatus}">${rawStatus}</span>`;
                    }
                    
                    let msgHtml = '';
                    const iconMsgStyle = "font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48; font-size: 1.4em; vertical-align: middle;"; 
                    
                    if (row.MSG === 'ENVIADA') { 
                        msgHtml = `<span class="material-symbols-outlined" 
                                        style="${iconMsgStyle} color:var(--success-color);" 
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Mensagem Enviada">mark_email_read</span>`; 
                    } else if (row.MSG === 'PENDENTE') { 
                        msgHtml = `<span class="material-symbols-outlined" 
                                        style="${iconMsgStyle} color:var(--danger-color-vivid);"
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Mensagem Pendente">unsubscribe</span>`; 
                    } else { 
                        msgHtml = row.MSG || ''; 
                    } 
                    
                    const dateAndIsCell = `<td><div class="table-cell-main">${row.DataEntrevista || ''}</div><div class="table-cell-sub">${row.IS || ''}</div></td>`; 
                    
                    let inspecionadoNome = row.Inspecionado || '';
                    const pgq = row['P/G/Q'] || '';
                    const excecoes = ['CANDIDATO', 'DEPEND / PENS'];
                    if (pgq && !excecoes.includes(pgq)) {
                        inspecionadoNome = `${pgq} ${inspecionadoNome}`;
                    }
                    const inspecionadoAndOmCell = `<td><div><div class="table-cell-main">${inspecionadoNome}</div><div class="table-cell-sub">${row.OM || ''}</div></div></td>`; 
                    
                    let syncIconHtml = ''; 
                    if (row.MSG === 'PENDENTE') {
                      syncIconHtml = `<span class="material-symbols-outlined actions-icon" 
                                            title="Marcar MSG como Enviada" 
                                            onclick="updateMsgStatus(event, '${row.IS}', ${index})">
                                            sync
                                      </span>`; 
                    }

                    let editIconHtml = '';
                    if (row.MSG !== 'ENVIADA') {
                      editIconHtml = `<span class="material-symbols-outlined actions-icon" 
                                            title="Editar Conclusão" 
                                            onclick="openEditModal(event, ${index})">
                                            edit
                                      </span>`;
                    }
                    
                    // --- NOVO ÍCONE DE REMARCAR ---
                    let remarcarIconHtml = '';
                    if (row.StatusIS === 'Agendada' || row.StatusIS === 'Remarcada') {
                      remarcarIconHtml = `<span class="material-symbols-outlined actions-icon" 
                                                title="Remarcar Inspeção" 
                                                onclick="openRemarcarModal(event, ${index})">
                                                event_repeat
                                          </span>`;
                    }
                    
                    const finalidadeCell = `<td><div class="actions-cell-content">
                                              <span>${row.Finalidade||''}</span>
                                              <span style="display: flex; align-items: center; gap: 8px;">
                                                ${syncIconHtml}
                                                ${editIconHtml}
                                                ${remarcarIconHtml} <span class="material-symbols-outlined actions-icon" onclick="showDetailsModal(event, ${index})">more_vert</span>
                                              </span>
                                            </div></td>`; 

                    const statusMsgCell = `<td>
                                             <div style="display: flex; align-items: center; gap: 10px;">
                                               ${statusHtml}
                                               ${msgHtml}
                                             </div>
                                           </td>`; 
                    
                    tr.innerHTML = statusMsgCell + dateAndIsCell +  inspecionadoAndOmCell + finalidadeCell; 

                } catch(e) { 
                    console.error("Erro ao renderizar linha da tabela:", e, "Índice:", index, "Dados da linha:", row); 
                    try { const errorRow = tBody.insertRow(); errorRow.innerHTML = `<td colspan="4" class="text-center text-danger">Erro ao renderizar linha ${index + 1}.</td>`; } 
                    catch (innerError) { console.error("Erro ao inserir linha de erro na tabela:", innerError); }
                }
            }); 
            console.log("renderTable concluída.");
        }

        // --- FUNÇÃO showDetailsModal (ATUALIZADA) ---
        function showDetailsModal(event, index) { 
            try { 
                if (event) event.stopPropagation(); 
                
                const data = filteredData[index]; 
                if (!data) { throw new Error("Dados não encontrados para o índice: " + index); } 
                
                let inspecionadoNome = data.Inspecionado || '';
                const pgq = data['P/G/Q'] || '';
                const excecoes = ['CANDIDATO', 'DEPEND / PENS'];
                if (pgq && !excecoes.includes(pgq)) {
                    inspecionadoNome = `${pgq} ${inspecionadoNome}`;
                }
                const subtitulo = [inspecionadoNome, data.NIP, data.OM ? `(${data.OM})` : ''].filter(String).join(' - '); 

                document.getElementById('modalDetailsInspecionado').textContent = subtitulo; 
                const finalidadeStatus = [data.Finalidade, data.StatusIS].filter(String).join(' - '); 
                const finalidadeElement = document.getElementById('modalDetailsFinalidade'); 
                finalidadeElement.textContent = finalidadeStatus; 
                if (data.MSG === 'ENVIADA') { finalidadeElement.style.color = 'var(--success-color)'; } 
                else { finalidadeElement.style.color = 'var(--danger-color-vivid)'; } 
                const fields = [ { id: 'modalDetailsLaudo', value: data.Laudo, sectionId: 'laudo-section' }, { id: 'modalDetailsRestricoes', value: data.Restrições, sectionId: 'restricoes-section' }, { id: 'modalDetailsDataLaudo', value: data.DataLaudo, sectionId: 'dataLaudo-section' }, { id: 'modalDetailsTis', value: data.TIS, sectionId: 'tis-section' }, { id: 'modalDetailsDs1a', value: data['DS-1a'], sectionId: 'ds1a-section' } ]; 
                fields.forEach(field => { const element = document.getElementById(field.id); const section = document.getElementById(field.sectionId); if (field.value) { element.textContent = field.value; section.classList.remove('d-none'); } else { element.textContent = ''; section.classList.add('d-none'); } }); 
                
                const minutaSection = document.getElementById('minuta-msg-section');
                
                if (data['DS-1a']) { 
                    const subtituloMinuta = [data['P/G/Q'], data.NIP, data.Inspecionado, data.OM ? `(${data.OM})` : ''].filter(String).join(' '); 
                    let minutaText = `INSPEÇÃO DE SAÚDE FIM ${data.Finalidade || 'não informada'} - ${subtituloMinuta} \n\nALFA - PTC que a JRS/HNRe concluiu em ${data.DataLaudo || 'data não informada'} a IS FIM ${data.Finalidade || 'não informada'} atinente ao ${subtituloMinuta} e exarou o seguinte laudo: "${data.Laudo || 'não informado'}"`; 
                    if (data.Restrições && data.Restrições.toUpperCase() !== 'LTS') { minutaText += ` Deverá ser afastado de: ${data.Restrições}. `; } 
                    minutaText += ` ACD TIS nº ${data.TIS || 'não informado'}; e \n\nBRAVO - O REF TIS (modelo DS-1A) pode ser verificado digitalmente por meio do acesso ao sítio "https://sinais.dsm.mb/tisonline", informando o código de validação "${data['DS-1a'] || 'não informado'}" e selecionando a opção “Download do TIS” BT`; 
                    document.getElementById('modalMinutaMsgText').textContent = minutaText; 
                    minutaSection.classList.remove('d-none'); 
                } else { 
                    minutaSection.classList.add('d-none'); 
                } 
                detailsModalInstance.show(); 
            } catch (e) { 
                console.error("Erro ao mostrar detalhes no modal:", e); 
                alert("Não foi possível carregar os detalhes desta inspeção."); 
            } 
        }

        // --- FUNÇÃO PARA ATUALIZAR STATUS DA MSG (Estável) ---
        function updateMsgStatus(event, isNumber, rowIndex) {
          try {
            if (event) event.stopPropagation();
            
            const icon = event.target;
            icon.textContent = 'hourglass_top'; 
            icon.style.pointerEvents = 'none'; 
            icon.style.color = 'var(--info-color)'; 

            console.log(`Atualizando status da MSG para IS: ${isNumber}`);

            google.script.run
              .withSuccessHandler(response => {
                if (response.success) {
                  console.log("Status da MSG atualizado com sucesso.");
                  
                  const originalDataIndex = allTableData.findIndex(item => item.IS == isNumber);
                  if (originalDataIndex > -1) {
                    allTableData[originalDataIndex].MSG = 'ENVIADA';
                  }
                  
                  const filteredIndex = filteredData.findIndex(item => item.IS == isNumber);
                  if(filteredIndex > -1) filteredData[filteredIndex].MSG = 'ENVIADA';

                  renderTable(filteredData);
                  initializeTooltips();

                } else {
                  console.error("Falha ao atualizar no backend:", response.message);
                  alert("Erro ao atualizar status: " + response.message);
                  icon.textContent = 'sync'; 
                  icon.style.pointerEvents = 'auto';
                  icon.style.color = ''; 
                }
              })
              .withFailureHandler(error => {
                console.error("Erro fatal ao chamar updateMsgStatus:", error);
                alert("Erro de comunicação: " + error.message);
                icon.textContent = 'sync'; 
                icon.style.pointerEvents = 'auto';
                icon.style.color = ''; 
              })
              .updateMsgStatus(isNumber); 
          } catch(e) {
             console.error("Erro no lado do cliente em updateMsgStatus:", e);
             alert("Um erro inesperado ocorreu: " + e.message);
             if(event.target) {
               event.target.textContent = 'sync';
               event.target.style.pointerEvents = 'auto';
               event.target.style.color = '';
             }
          }
        }

        // --- NOVA FUNÇÃO PARA ABRIR O MODAL DE EDIÇÃO (ATUALIZADA) ---
        function openEditModal(event, filteredIndex) {
          try {
            if (event) event.stopPropagation();

            const data = filteredData[filteredIndex];
            if (!data) { throw new Error("Dados da linha não encontrados."); }

            // 1. Popula informações básicas
            
            const isNumber = data.IS || '';
            const finalidade = data.Finalidade || '';
            document.getElementById('editModalIsTitle').textContent = `${isNumber} - ${finalidade.toUpperCase()}`;
            
            document.getElementById('editIsNumber').value = data.IS;
            
            // Monta o nome formatado
            let inspecionadoNome = data.Inspecionado || '';
            const pgq = data['P/G/Q'] || '';
            const excecoes = ['CANDIDATO', 'DEPEND / PENS'];
            if (pgq && !excecoes.includes(pgq)) {
                inspecionadoNome = `${pgq} ${inspecionadoNome}`;
            }
            const om = data.OM ? ` (${data.OM})` : '';
            document.getElementById('editModalInspecionado').textContent = `${inspecionadoNome}${om}`;

            
            // --- ALTERAÇÃO APLICADA AQUI ---
            // Lógica para exibir/ocultar o bloco de Restrições
            const finalidadeUpper = (data.Finalidade || '').toUpperCase();
            const showRestricoesList = [
              'VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL',
              'TÉRMINO DE INCAPACIDADE',
              'TÉRMINO DE RESTRIÇÕES'
            ];
            const shouldShowRestricoes = showRestricoesList.includes(finalidadeUpper);
            
            const restricoesBlock = document.getElementById('editRestricoesContainer');
            restricoesBlock.style.display = shouldShowRestricoes ? 'block' : 'none';
            // --- FIM DA ALTERAÇÃO ---


            // 2. Popula o formulário com dados existentes
            document.getElementById('editLaudo').value = data.Laudo || '';
            document.getElementById('editTis').value = data.TIS || '';
            applyTISMask(document.getElementById('editTis')); // Aplica a máscara no TIS existente
            document.getElementById('editDs1a').value = data['DS-1a'] || '';

            // 3. Converte data pt-BR (dd/mm/yyyy) para formato date input (yyyy-mm-dd)
            let isoDate = '';
            if (data.DataLaudo) {
              const parts = data.DataLaudo.split('/');
              if (parts.length === 3) {
                isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
              }
            }
            document.getElementById('editDataLaudo').value = isoDate;
            
            // Se a data estiver vazia, pré-preenche com hoje
            if (!isoDate) {
              const today = new Date();
              const yyyy = today.getFullYear();
              const mm = String(today.getMonth() + 1).padStart(2, '0'); // Janeiro é 0
              const dd = String(today.getDate()).padStart(2, '0');
              document.getElementById('editDataLaudo').value = `${yyyy}-${mm}-${dd}`;
            }

            // 4. Popula as Restrições
            const allCheckboxes = document.querySelectorAll('.edit-restricao-item');
            allCheckboxes.forEach(cb => cb.checked = false); // Limpa todos
            document.getElementById('editOutrosRestricaoText').value = '';
            toggleEditOutros(false); // Garante que o campo 'Outros' esteja escondido

            const restricoesArray = data.Restrições ? data.Restrições.split(', ') : [];
            restricoesArray.forEach(restricao => {
              let match = false;
              allCheckboxes.forEach(cb => {
                if (cb.value === restricao) {
                  cb.checked = true;
                  match = true;
                }
              });
              
              // Verifica se é "Outros"
              if (!match && restricao.startsWith('Outros: ')) {
                const outrosCheckbox = Array.from(allCheckboxes).find(cb => cb.value === 'Outros');
                if (outrosCheckbox) {
                  outrosCheckbox.checked = true;
                  toggleEditOutros(true);
                  document.getElementById('editOutrosRestricaoText').value = restricao.substring('Outros: '.length);
                }
              }
            });

            // 5. Mostra o modal
            editModalInstance.show();

          } catch(e) {
            console.error("Erro ao abrir o modal de edição:", e);
            alert("Não foi possível abrir o modal: " + e.message);
          }
        }

        // --- NOVA FUNÇÃO PARA SALVAR O MODAL DE EDIÇÃO ---
        function handleEditFormSubmit(event) {
          try {
            event.preventDefault(); // Impede o recarregamento da página
            const saveButton = document.getElementById('saveEditButton');
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';

            // 1. Coleta os dados do formulário
            const formData = {
              isNumber: document.getElementById('editIsNumber').value,
              laudo: document.getElementById('editLaudo').value,
              dataLaudo: document.getElementById('editDataLaudo').value, // Vem como yyyy-mm-dd
              tis: document.getElementById('editTis').value,
              ds1a: document.getElementById('editDs1a').value,
              restricoes: [],
              outrosRestricao: ''
            };

            // 2. Coleta as restrições (lógica do Formulário.html)
            const checkboxes = document.querySelectorAll('.edit-restricao-item:checked');
            checkboxes.forEach(cb => {
              formData.restricoes.push(cb.value);
            });
            if (formData.restricoes.includes('Outros')) {
              formData.outrosRestricao = document.getElementById('editOutrosRestricaoText').value;
            }

            console.log("Enviando dados para atualização:", formData);

            // 3. Envia para o Google Apps Script
            google.script.run
              .withSuccessHandler(response => {
                if (response.success) {
                  console.log("Sucesso ao salvar:", response);
                  
                  // Atualiza os dados locais (allTableData e filteredData)
                  const updatedData = response.updatedData;
                  const isNumber = formData.isNumber;

                  const originalDataIndex = allTableData.findIndex(item => item.IS == isNumber);
                  if (originalDataIndex > -1) {
                    Object.assign(allTableData[originalDataIndex], updatedData);
                  }
                  
                  const filteredIndex = filteredData.findIndex(item => item.IS == isNumber);
                  if(filteredIndex > -1) {
                    Object.assign(filteredData[filteredIndex], updatedData);
                  }

                  // Fecha o modal e re-renderiza a tabela
                  editModalInstance.hide();
                  renderTable(filteredData);
                  initializeTooltips();

                } else {
                  console.error("Falha ao salvar no backend:", response.message);
                  alert("Erro ao salvar: " + response.message);
                }
                // Restaura o botão
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Alterações';
              })
              .withFailureHandler(error => {
                console.error("Erro fatal ao chamar updateInspectionConclusion:", error);
                alert("Erro de comunicação: " + error.message);
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Alterações';
              })
              .updateInspectionConclusion(formData); // Nome da nova função no Code.gs

          } catch(e) {
            console.error("Erro no lado do cliente em handleEditFormSubmit:", e);
            alert("Um erro inesperado ocorreu: " + e.message);
            const saveButton = document.getElementById('saveEditButton');
            saveButton.disabled = false;
            saveButton.innerHTML = 'Salvar Alterações';
          }
        }
        
        // --- NOVAS FUNÇÕES PARA REMARCAÇÃO ---
        function openRemarcarModal(event, filteredIndex) {
          try {
            if (event) event.stopPropagation();

            const data = filteredData[filteredIndex];
            if (!data) { throw new Error("Dados da linha não encontrados."); }

            // Popula o modal
            document.getElementById('remarcarModalInspecionado').textContent = data.Inspecionado || 'N/A';
            document.getElementById('remarcarModalIs').textContent = data.IS || 'N/A';
            document.getElementById('remarcarIsNumber').value = data.IS;
            
            // Limpa o campo de data
            document.getElementById('remarcarNovaData').value = ''; 
            
            // Pré-preenche com a data de amanhã como sugestão
            const today = new Date();
            today.setDate(today.getDate() + 1); // Sugere amanhã
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('remarcarNovaData').value = `${yyyy}-${mm}-${dd}`;

            remarcarModalInstance.show();

          } catch(e) {
            console.error("Erro ao abrir o modal de remarcação:", e);
            alert("Não foi possível abrir o modal: " + e.message);
          }
        }

        function handleRemarcarFormSubmit(event) {
          try {
            event.preventDefault(); 
            const saveButton = document.getElementById('saveRemarcarButton');
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';

            // 1. Coleta os dados
            const isNumber = document.getElementById('remarcarIsNumber').value;
            const novaData = document.getElementById('remarcarNovaData').value; // Formato yyyy-mm-dd

            if (!isNumber || !novaData) {
              throw new Error("IS ou Nova Data não preenchidos.");
            }

            const formData = {
              isNumber: isNumber,
              novaData: novaData
            };
            
            console.log("Enviando dados para remarcação:", formData);

            // 2. Envia para o Google Apps Script
            google.script.run
              .withSuccessHandler(response => {
                if (response.success) {
                  console.log("Sucesso ao remarcar:", response);
                  
                  // Atualiza os dados locais (allTableData e filteredData)
                  const updatedData = response.updatedData; // { DataEntrevista, StatusIS }

                  const originalDataIndex = allTableData.findIndex(item => item.IS == isNumber);
                  if (originalDataIndex > -1) {
                    allTableData[originalDataIndex].DataEntrevista = updatedData.DataEntrevista;
                    allTableData[originalDataIndex].StatusIS = updatedData.StatusIS;
                  }
                  
                  const filteredIndex = filteredData.findIndex(item => item.IS == isNumber);
                  if(filteredIndex > -1) {
                    filteredData[filteredIndex].DataEntrevista = updatedData.DataEntrevista;
                    filteredData[filteredIndex].StatusIS = updatedData.StatusIS;
                  }

                  // Fecha o modal e re-renderiza a tabela
                  remarcarModalInstance.hide();
                  renderTable(filteredData);
                  initializeTooltips();
                  
                  // Opcional: Atualizar KPIs se a data/status impactar
                  applyGlobalFilters(); 

                } else {
                  console.error("Falha ao remarcar no backend:", response.message);
                  alert("Erro ao salvar: " + response.message);
                }
                // Restaura o botão
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Nova Data';
              })
              .withFailureHandler(error => {
                console.error("Erro fatal ao chamar remarcarInspecao:", error);
                alert("Erro de comunicação: " + error.message);
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Nova Data';
              })
              .remarcarInspecao(formData); // Nova função no Code.gs

          } catch(e) {
            console.error("Erro no lado do cliente em handleRemarcarFormSubmit:", e);
            alert("Um erro inesperado ocorreu: " + e.message);
            const saveButton = document.getElementById('saveRemarcarButton');
            saveButton.disabled = false;
            saveButton.innerHTML = 'Salvar Nova Data';
          }
        }
        
        function populateGlobalFilters(data) { 
            try { 
                const yearFilter = document.getElementById('yearFilter'); 
                const monthFilter = document.getElementById('monthFilter'); 
                const years = [...new Set(data.map(r => r && r.year).filter(Boolean))].sort((a,b) => b - a); 
                yearFilter.innerHTML = '<option value="todos">Todos os Anos</option>'; 
                years.forEach(y => yearFilter.add(new Option(y, y))); 
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; 
                monthFilter.innerHTML = '<option value="todos">Todos os Meses</option>'; 
                monthNames.forEach((name, index) => monthFilter.add(new Option(name, index))); 
                
                const currentDate = new Date(); 
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); 
                
                if (years.length > 0) { 
                    if (years.includes(currentYear)) {
                        yearFilter.value = currentYear;
                    } else {
                        yearFilter.value = years[0]; 
                    }
                } 
                
                monthFilter.value = currentMonth; 
                console.log("Filtros globais populados."); 
            } catch (e) { 
                console.error("Erro ao popular filtros globais:", e); 
            } 
        }

        function applyGlobalFilters() { console.log("Aplicando filtros globais..."); try { const year = document.getElementById('yearFilter').value; const month = document.getElementById('monthFilter').value; const yearFilteredData = allDashboardData.filter(row => row && (year === 'todos' || row.year == year)); const fullyFilteredData = yearFilteredData.filter(row => row && (month === 'todos' || row.month == month)); console.log("Dados filtrados globalmente:", fullyFilteredData); updateKPIs(fullyFilteredData); drawCharts(fullyFilteredData, yearFilteredData); } catch (e) { console.error("Erro ao aplicar filtros globais:", e); } }
        function parseDate(dateString) { try { if (!dateString || typeof dateString !== 'string' || !dateString.includes('/')) return null; const parts = dateString.split('/'); if (parts.length !== 3) return null; const year = parseInt(parts[2], 10) < 100 ? 2000 + parseInt(parts[2], 10) : parseInt(parts[2], 10); const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; if (isNaN(day) || isNaN(month) || isNaN(year)) return null; const date = new Date(year, month, day); if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null; return date; } catch (e) { console.error("Erro ao parsear data:", dateString, e); return null; } }
        
        // --- FUNÇÃO addEventListeners (CORRIGIDA) ---
        function addEventListeners() { 
            try { 
                document.getElementById('yearFilter').addEventListener('change', applyGlobalFilters); 
                document.getElementById('monthFilter').addEventListener('change', applyGlobalFilters); 
                document.getElementById('searchInput').addEventListener('keyup', applyFilters); 
                
                // Listener para o menu de Finalidades (CORRIGIDO)
                const purposeMenu = document.getElementById('purposeFilterMenu');
                if (purposeMenu) {
                  
                  // Listener para o botão "Limpar"
                  purposeMenu.addEventListener('click', (e) => {
                    if (e.target.id === 'clearPurposeFilter') {
                      e.preventDefault();
                      e.stopPropagation();
                      document.querySelectorAll('.purpose-filter-item:checked').forEach(cb => cb.checked = false);
                      applyFilters();
                      updatePurposeButtonText();
                    }
                  });

                  // Listener para as caixas de seleção
                  purposeMenu.addEventListener('change', (e) => {
                    if (e.target.classList.contains('purpose-filter-item')) {
                      // O evento 'change' dispara *depois* que o estado mudou
                      applyFilters();
                      updatePurposeButtonText();
                    }
                  });
                }
                
                // Função auxiliar para criar listeners dos chips
                const setupChipListener = (id) => {
                    const chip = document.getElementById(id);
                    if (chip) {
                        chip.addEventListener('click', () => {
                            chip.classList.toggle('active'); 
                            applyFilters(); 
                        });
                    }
                };
                
                // Configura os listeners para todos os chips
                setupChipListener('isPendenteFilter');
                setupChipListener('pendingMsgFilter');
                setupChipListener('revisaoFilter');
                setupChipListener('restituidaFilter');
                setupChipListener('agendadasFilter');
                setupChipListener('faltasFilter');
                setupChipListener('canceladasFilter');

            } catch (e) { 
                console.error("Erro ao adicionar event listeners:", e); 
                onDataError(new Error("Não foi possível configurar os filtros interativos.")); 
            } 
        }
    </script>
    <script>
      let BASE_URL = '';
      function navigateTo(page) { if (BASE_URL) { console.log(`Navegando para: ${BASE_URL}?page=${page}`); window.top.location.href = BASE_URL + '?page=' + page; } else { console.warn("BASE_URL ainda não carregada, não foi possível navegar."); alert("Aguarde o carregamento completo da página e tente novamente."); } }
      document.addEventListener('DOMContentLoaded', () => { google.script.run.withSuccessHandler((url) => { console.log("URL base do Web App recebida:", url); BASE_URL = url; }).withFailureHandler((error) => { console.error("Falha ao obter URL base do Web App:", error); alert("Erro crítico: Não foi possível configurar a navegação entre páginas."); }).getWebAppUrl(); });
    </script>
</body>
</html>
