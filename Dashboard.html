!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Oswald:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #050f41;
        --danger-color: #990000;
        --danger-color-vivid: #d9534f;
        --danger-color-light: #fef5f5;
        --success-color: #146c43;
        --link-color: #0d6efd;
        --font-oswald: 'Oswald', sans-serif;
        --font-carlito: 'Carlito', sans-serif;
        --light-gray-1: #fcfcfc;
        --dark-gray-3: #6c757d; 
      }
      body {
        font-family: var(--font-carlito);
        background-color: #f4f4f9;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container-main { max-width: 1400px; margin: 20px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, .1); overflow: hidden; }

      .header-box { display: flex; align-items: center; background-color: var(--primary-color); color: #fff; padding: 20px 30px; }
      .header-logo { height: 65px; margin-right: 25px; }
      .header-text h1 { font-family: var(--font-oswald); font-size: 32px; margin: 0; font-weight: 700; line-height: 1.1; }
      .header-text p { font-family: var(--font-carlito); font-size: 18px; margin: 5px 0 0; opacity: .9; }
      
      .icon-btn {
          margin-left: auto;
          color: white;
          text-decoration: none;
          background-color: rgba(255, 255, 255, 0.2);
          border-radius: 50%;
          width: 60px;
          height: 60px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background-color 0.3s;
      }
      .icon-btn:hover {
          background-color: rgba(255, 255, 255, 0.4);
          color: white;
      }
      .icon-btn .material-symbols-outlined {
          font-size: 32px;
      }

      .dashboard-content { padding: 30px; }
      .dashboard-title-wrapper { display: flex; justify-content: center; width: 100%; margin: 20px 0 40px 0; }
      .dashboard-title, .section-title { 
        display: flex; align-items: center; justify-content: center;
        font-family: var(--font-oswald); font-size: 32px; font-weight: 700; 
        text-transform: uppercase; gap: 15px; color: #333;
      }
      .dashboard-title { margin-bottom: 0; }
      .section-title { margin-top: 40px; margin-bottom: 25px; }
      .dashboard-title .material-symbols-outlined,
      .section-title .material-symbols-outlined { font-size: 38px !important; }

      .kpi-value { margin-bottom: 0.5rem !important; }
      #loader { text-align: center; padding: 50px; }
      
      .kpi-block { border-radius: 8px; border: 1px solid #e0e0e0; padding: 1.2rem; height: 100%; }
      .kpi-block-alert { background-color: var(--danger-color-light); border-color: var(--danger-color-vivid); display: flex; flex-direction: column; }
      .kpi-item { margin-bottom: 0.5rem; }
      .kpi-title { font-family: var(--font-oswald); text-transform: uppercase; font-weight: 800; color: #555; display: flex; align-items: center; gap: 8px; }
      .kpi-value { font-family: var(--font-oswald); font-weight: 700; line-height: 1; margin: 0; }
      
      .kpi-item.level-1 .kpi-title { font-size: 1.2rem; }
      .kpi-item.level-1 .kpi-value { font-size: 5rem; }
      .kpi-item.level-2 .kpi-title { font-size: 1.1rem; }
      .kpi-item.level-2 .kpi-value { font-size: 3.5rem; }
      .kpi-item.level-3 .kpi-title { font-size: 0.9rem; }
      .kpi-item.level-3 .kpi-value { font-size: 2.2rem; }

      .kpi-block-alert .kpi-title, .kpi-block-alert .kpi-value { color: var(--danger-color); }
      .kpi-block-alert .kpi-title { color: var(--danger-color-vivid); }
      .text-alert-vivid .kpi-title,
      .text-alert-vivid .kpi-value,
      .text-alert-vivid .material-symbols-outlined { color: var(--danger-color-vivid) !important; }
      
      .chart-container { background-color: var(--light-gray-1); padding: 20px; border-radius: 8px; border: 1px solid #e9e9e9; height: 400px; }
      .table-container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      
      .status-pendente { font-weight: bold; }
      
      .table-cell-main { font-weight: bold; color: #333; }
      .table-cell-sub { font-size: 0.8em; color: var(--dark-gray-3); }
      
      .table-row-alert td, 
      .table-row-alert .table-cell-main,
      .table-row-alert .table-cell-sub {
        background-color: var(--danger-color-light) !important;
        color: var(--danger-color) !important;
        font-weight: bold !important;
      }
      .table-hover > tbody > tr.table-row-alert:hover > * {
        --bs-table-hover-bg: #f5e3e3;
        background-color: var(--bs-table-hover-bg) !important;
        color: var(--danger-color) !important;
      }

      .actions-cell-content { display: flex; justify-content: space-between; align-items: center; }
      .actions-icon { cursor: pointer; color: #777; }
      .actions-icon:hover { color: #000; }
      .dropdown-menu .material-symbols-outlined {
        vertical-align: sub;
        margin-right: 10px;
        font-size: 1.2rem;
      }
      .dropdown-item.disabled, .dropdown-item:disabled {
        color: #adb5bd;
        pointer-events: none;
        background-color: transparent;
      }
      
      .modal-header { background-color: var(--primary-color); color: white; }
      .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
      .modal-body span { font-family: var(--font-oswald); text-transform: uppercase; color: #555; font-size: 0.9em;}
      .modal-body p { margin-bottom: 1rem; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container-main">
      <div class="header-box">
        <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
        <div class="header-text">
          <h1>JUNTA REGULAR DE SAÚDE</h1>
          <p>HOSPITAL NAVAL DE RECIFE</p>
        </div>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=form" class="icon-btn" title="Nova IS">
            <span class="material-symbols-outlined">person_add</span>
        </a>
      </div>

      <div class="dashboard-content">
        <div class="dashboard-title-wrapper">
            <h2 class="dashboard-title">
              <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">medical_information</span>
              INSPEÇÕES DE SAÚDE
            </h2>
        </div>

        <div id="loader" class="text-center">
          <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div>
          <p class="mt-2">A carregar dados...</p>
        </div>

        <div id="mainContent" class="d-none">
            <div class="row g-4 mb-4">
              <div class="col-lg-6">
                <div class="kpi-block">
                  <div class="kpi-item level-1 text-center"><p class="kpi-value" id="kpiTotal">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">summarize</span>Total de Inspeções</h6></div><hr>
                  <div class="row text-center">
                    <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiTisSigned">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">check_circle</span>TIS Assinados</h6></div>
                    <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgEnviada" style="color:var(--success-color);">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">send</span>MSG Enviadas</h6></div>
                  </div><hr>
                  <div class="row text-center">
                    <div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiAuditoria">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">policy</span>Auditoria CPMM</h6></div>
                    <div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiJsd">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">manage_search</span>Revisão JSD</h6></div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="kpi-block kpi-block-alert">
                  <div class="flex-fill d-flex align-items-center"><div class="row text-center w-100">
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">pending_actions</span>MSG Pendentes</h6></div>
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiExamesPendentes">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">lab_profile</span>Exames Pendentes</h6></div>
                  </div></div><hr class="my-0">
                  <div class="flex-fill d-flex align-items-center"><div class="row text-center w-100">
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiConclusoesPendentes">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">help</span>Conclusões Pendentes</h6></div>
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiVotacaoPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">gavel</span>Votações Pendentes</h6></div>
                  </div></div>
                </div>
              </div>
            </div>
            <div class="row g-4 mb-4 justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="kpi-block">
                        <div class="row text-center">
                           <div class="col-6 kpi-item level-3" id="kpi-item-cancelada"><p class="kpi-value" id="kpiCancelada">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">cancel</span>Canceladas</h6></div>
                           <div class="col-6 kpi-item level-3" id="kpi-item-faltas"><p class="kpi-value" id="kpiFaltou">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">person_off</span>Faltas</h6></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
              <div class="col-lg-6 mb-3"><div class="chart-container"><h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Inspeções por Finalidade</h4><div id="purposeDonutChart"></div></div></div>
              <div class="col-lg-6 mb-3"><div class="chart-container"><h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Entrevistas por Mês</h4><div id="interviewsBarChart"></div></div></div>
            </div>
            <div class="row"><div class="col-12"><div class="table-container">
              <h2 class="section-title">
                  <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">patient_list</span>
                  DETALHES DAS INSPEÇÕES
              </h2>
              <div class="row g-3 mb-3">
                <div class="col-md-4"><input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome do inspecionado..."></div>
                <div class="col-md-4"><select id="purposeFilter" class="form-select"></select></div>
                <div class="col-md-4"><select id="statusFilter" class="form-select"></select></div>
              </div>
              <div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>Data / IS</th><th>Finalidade</th><th>Status</th><th>Inspecionado / OM</th><th>MSG</th></tr></thead>
                <tbody id="dataTableBody"></tbody>
              </table></div>
            </div></div></div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="inspecionadoModal" tabindex="-1"> ... </div>
    <div class="modal fade" id="obsModal" tabindex="-1"> ... </div>
    <div class="modal fade" id="laudoModal" tabindex="-1"> ... </div>
    <div class="modal fade" id="editModal" tabindex="-1"> ... </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script>
        let allData = [];
        let filteredData = [];
        let inspecionadoModal, laudoModal, obsModal, editModal;

        document.addEventListener('DOMContentLoaded', () => {
            inspecionadoModal = new bootstrap.Modal(document.getElementById('inspecionadoModal'));
            laudoModal = new bootstrap.Modal(document.getElementById('laudoModal'));
            obsModal = new bootstrap.Modal(document.getElementById('obsModal'));
            editModal = new bootstrap.Modal(document.getElementById('editModal'));

            google.script.run
              .withSuccessHandler(onDataLoaded)
              .withFailureHandler(onDataError)
              .getDashboardData();
        });

        function onDataLoaded(data) {
            allData = data.map((row, index) => ({ ...row, originalIndex: index }));
            document.getElementById('loader').classList.add('d-none');
            document.getElementById('mainContent').classList.remove('d-none');
            
            // FUNÇÕES DE ATUALIZAÇÃO REINSERIDAS
            updateKPIs();
            populateFilters(); 
            drawCharts(); 
            applyFilters(); // Aplica filtros e renderiza a tabela inicial
            
            document.getElementById('searchInput').addEventListener('keyup', applyFilters);
            document.getElementById('purposeFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);

            $('#dataTableBody').on('click', '.dropdown-item', function(e) {
                e.preventDefault();
                const id = $(this).closest('.dropdown').find('button').data('id');
                const action = $(this).data('action');
                const dataItem = allData.find(row => row.IS == id);
                if (!dataItem) { console.error("Dados não encontrados para o ID: ", id); return; }

                switch(action) {
                    case 'inspecionado': showInspecionadoModal(dataItem); break;
                    case 'observacoes':  showObsModal(dataItem); break;
                    case 'laudo':        showLaudoModal(dataItem); break;
                    case 'editar':       abrirModalEdicao(id); break;
                }
            });
        }

        function onDataError(error) { 
            console.error('Falha ao carregar os dados:', error); 
            document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Erro ao carregar dados. Verifique o console.</div>`;
        }
      
        // FUNÇÕES DE KPIs, FILTROS E GRÁFICOS REINSERIDAS
        function updateKPIs() {
            const countOccurrences = (column, value) => allData.filter(row => row[column] === value).length;
            
            document.getElementById('kpiExamesPendentes').textContent = countOccurrences('StatusIS', 'AGU exames');
            document.getElementById('kpiConclusoesPendentes').textContent = countOccurrences('StatusIS', 'Conclusão Pendente');
            document.getElementById('kpiTotal').textContent = allData.length;
            document.getElementById('kpiTisSigned').textContent = countOccurrences('StatusIS', 'TIS assinado');
            document.getElementById('kpiMsgPendente').textContent = countOccurrences('MSG', 'PENDENTE');
            document.getElementById('kpiMsgEnviada').textContent = countOccurrences('MSG', 'ENVIADA');
            document.getElementById('kpiVotacaoPendente').textContent = countOccurrences('StatusIS', 'Concluída');
            document.getElementById('kpiAuditoria').textContent = countOccurrences('StatusIS', 'Auditoria');
            document.getElementById('kpiJsd').textContent = countOccurrences('StatusIS', 'JSD');
            document.getElementById('kpiCancelada').textContent = countOccurrences('StatusIS', 'Cancelada');
            document.getElementById('kpiFaltou').textContent = countOccurrences('StatusIS', 'Faltou');

            document.getElementById('kpi-item-cancelada').classList.toggle('text-alert-vivid', countOccurrences('StatusIS', 'Cancelada') > 0);
            document.getElementById('kpi-item-faltas').classList.toggle('text-alert-vivid', countOccurrences('StatusIS', 'Faltou') > 0);
        }

        function populateFilters() {
            const purposes = ['Todas as Finalidades', ...new Set(allData.map(row => row.Finalidade).filter(Boolean).sort())];
            const statuses = ['Todos os Status', ...new Set(allData.map(row => row.StatusIS).filter(Boolean).sort())];
            const purposeFilter = document.getElementById('purposeFilter');
            const statusFilter = document.getElementById('statusFilter');
            purposeFilter.innerHTML = '';
            statusFilter.innerHTML = '';
            purposes.forEach(p => purposeFilter.add(new Option(p, p)));
            statuses.forEach(s => statusFilter.add(new Option(s, s)));
        }

        function drawCharts() {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                const chartBackgroundColor = 'transparent';
                
                const purposeCounts = allData.reduce((acc, row) => {
                    if(row.Finalidade) { acc[row.Finalidade] = (acc[row.Finalidade] || 0) + 1; }
                    return acc;
                }, {});
                const purposeData = [['Finalidade', 'Quantidade'], ...Object.entries(purposeCounts)];
                new google.visualization.PieChart(document.getElementById('purposeDonutChart')).draw(
                    google.visualization.arrayToDataTable(purposeData), 
                    { pieHole: 0.4, backgroundColor: chartBackgroundColor, chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' } }
                );
                
                const interviewCountsByMonth = allData.reduce((acc, row) => {
                    if (row.DataEntrevista && row.DataEntrevista.includes('/')) {
                        const parts = row.DataEntrevista.split('/');
                        if(parts.length === 3) {
                           const monthYear = `${parts[1]}/${parts[2]}`;
                           acc[monthYear] = (acc[monthYear] || 0) + 1;
                        }
                    }
                    return acc;
                }, {});
                const interviewData = [['Mês/Ano', 'Nº de Inspeções']];
                Object.keys(interviewCountsByMonth).sort().forEach(month => {
                  interviewData.push([month, interviewCountsByMonth[month]]);
                });
                new google.visualization.ColumnChart(document.getElementById('interviewsBarChart')).draw(
                    google.visualization.arrayToDataTable(interviewData), 
                    { backgroundColor: chartBackgroundColor, legend: { position: 'none' }}
                );
            });
        }
        
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const purpose = document.getElementById('purposeFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            filteredData = allData.filter(r => 
                (!search || (r.Inspecionado||'').toLowerCase().includes(search)) &&
                (purpose === 'Todas as Finalidades' || r.Finalidade === purpose) &&
                (status === 'Todos os Status' || r.StatusIS === status)
            );
            renderTable(filteredData);
        }

        // ==========================================================
        //           FUNÇÕES DE MODAL (CORRIGIDAS E COMPLETAS)
        // ==========================================================
        function showInspecionadoModal(data) {
            $('#modalInspecionadoNome').text(data.Inspecionado || 'Não informado');
            $('#modalInspecionadoPg').text(data['P/G/Q'] || 'Não informado');
            $('#modalInspecionadoNip').text(data.NIP || 'Não informado');
            $('#modalInspecionadoOm').text(data.OM || 'Não informado');
            inspecionadoModal.show();
        }

        function showLaudoModal(data) {
            $('#modalTis').text(data.TIS || 'Não informado');
            $('#modalDs1a').text(data['DS-1a'] || 'Não informado');
            laudoModal.show();
        }
      
        function showObsModal(data) {
            $('#modalObsText').text(data.Laudo || 'Nenhuma observação encontrada.');
            obsModal.show();
        }
      
        function abrirModalEdicao(is) {
            $('#editForm')[0].reset(); // Limpa o formulário
            // Mostra um loader dentro do modal (opcional)
            $('#editModal .modal-body').prepend('<div id="editLoader" class="text-center"><div class="spinner-border" role="status"></div></div>');
            editModal.show();

            google.script.run
                .withSuccessHandler(function(recordData) {
                    $('#editLoader').remove(); // Remove o loader
                    // Preenche o formulário com os dados recebidos
                    $('#editOriginalIS').val(recordData.IS);
                    $('#editIS').val(recordData.IS);
                    $('#editInspecionado').val(recordData.Inspecionado);
                    $('#editFinalidade').val(recordData.Finalidade);
                    $('#editDataEntrevista').val(recordData.DataEntrevista); // Formato AAAA-MM-DD
                    $('#editStatusIS').val(recordData.StatusIS);
                    $('#editLaudo').val(recordData.Laudo);
                })
                .withFailureHandler(function(err) {
                    $('#editLoader').remove();
                    alert("Erro ao buscar dados para edição: " + err.message);
                    editModal.hide();
                })
                .getRecordById(is);
        }
    </script>
</body>
</html>
