<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Oswald:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      /* --- CSS PADRÃO E SIDEBAR FIXA --- */
      :root {
        --primary-color: #050f41;
        --danger-color: #990000;
        --danger-color-vivid: #d9534f;
        --danger-color-light: #fef5f5;
        --success-color: #146c43;
        --link-color: #0d6efd;
        --warning-color: #FAB932;
        --info-color: #6c757d;
        --secondary-color: #adb5bd;
        --font-oswald: 'Oswald', sans-serif;
        --font-carlito: 'Carlito', sans-serif;
        --light-gray-1: #fcfcfc;
        --dark-gray-3: #6c757d; 
        --card-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        --card-shadow-hover: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        --sidebar-width: 250px;
      }
      body {
        font-family: var(--font-carlito);
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
      }

      /* Sidebar Styles (FIXO) */
      .sidenav {
        height: 100%;
        width: var(--sidebar-width);
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        background-color: var(--primary-color);
        overflow-x: hidden;
        padding-top: 20px;
        transition: transform 0.3s ease;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      }
      .sidenav a {
        padding: 15px 25px;
        text-decoration: none;
        font-size: 18px;
        font-family: var(--font-oswald);
        color: #e0e0e0;
        display: flex;
        align-items: center;
        transition: 0.2s;
        border-left: 4px solid transparent;
      }
      .sidenav a:hover, .sidenav a.active {
        background-color: rgba(255,255,255,0.1);
        color: #fff;
        border-left: 4px solid var(--warning-color);
      }
      .sidenav a .material-symbols-outlined { margin-right: 15px; } /* Ícone ao lado do texto */

      .sidenav-header {
          text-align: center;
          color: white;
          margin-bottom: 30px;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100px;
      }
      .sidenav-header img {
          width: 100px; /* Reduzido de 140px (aprox 30%) */
          height: auto;
      }

      /* Main Layout (COM MARGEM PARA SIDEBAR) */
      .container-main { 
        margin-left: var(--sidebar-width); /* Margem fixa */
        padding: 20px;
        transition: margin-left 0.3s ease;
      }
      
      .header-box { 
        display: flex; 
        align-items: center; 
        background-color: var(--primary-color); 
        color: #fff; 
        padding: 20px 30px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        box-shadow: var(--card-shadow); 
      }
      .header-logo { height: 65px; margin-right: 25px; }
      .header-text { flex-grow: 1; text-align: center; }
      .header-text h1 { font-family: var(--font-oswald); font-size: 32px; margin: 0; font-weight: 700; line-height: 1.1; }
      
      .mobile-toggle { display: none; margin-right: 20px; cursor: pointer; color: white; }

      /* RESPONSIVIDADE */
      @media (max-width: 992px) {
        .sidenav { transform: translateX(-100%); } /* Esconde por padrão no mobile */
        .sidenav.active { transform: translateX(0); }
        .container-main { margin-left: 0; }
        .mobile-toggle { display: block; position: absolute; left: 20px; }
        .header-text { padding-left: 40px; }
        .sidenav .closebtn { display: block; position: absolute; top: 10px; right: 10px; color: white; font-size: 30px; cursor: pointer; }
      }
      @media (min-width: 993px) { .sidenav .closebtn { display: none; } }

      /* Dashboard Specifics (ORIGINAL) */
      .title-filter-card { padding: 20px 20px 10px 20px; }
      
      .card-elevated {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        border: 1px solid #e9e9e9; 
        transition: box-shadow .3s cubic-bezier(.25,.8,.25,1); 
        margin-bottom: 20px; 
        overflow: hidden; 
      }
      .kpi-block { border: none; padding: 1.2rem; height: 100%; display: flex; flex-direction: column; justify-content: space-around; }
      .kpi-block-alert { background-color: var(--danger-color-light); }
      .kpi-item { margin-bottom: 0.5rem; }
      .kpi-title { font-family: var(--font-oswald); text-transform: uppercase; font-weight: 800; color: #555; display: flex; align-items: center; gap: 8px; }
      .kpi-value { font-family: var(--font-oswald); font-weight: 700; line-height: 1; margin: 0; margin-bottom: 0.5rem !important; }
      
      .kpi-item.level-1 .kpi-title { font-size: 1.2rem; }
      .kpi-item.level-1 .kpi-value { font-size: 5rem; }
      .kpi-item.level-2 .kpi-title { font-size: 1.1rem; }
      .kpi-item.level-2 .kpi-value { font-size: 3.5rem; }
      .kpi-item.level-3 .kpi-title { font-size: 0.9rem; }
      .kpi-item.level-3 .kpi-value { font-size: 2.2rem; }

      .kpi-block-alert .kpi-title, .kpi-block-alert .kpi-value { color: var(--danger-color); }
      .kpi-block-alert .kpi-title { color: var(--danger-color-vivid); }
      .text-alert-vivid .kpi-title, .text-alert-vivid .kpi-value, .text-alert-vivid .material-symbols-outlined { color: var(--danger-color-vivid) !important; }
      
      .kpi-block-alert .kpi-item.level-2 .kpi-title { font-size: 1.3rem; }
      .kpi-block-alert .kpi-item.level-2 .kpi-value { font-size: 4.5rem; }

      .chart-container { background-color: transparent; padding: 20px; height: 400px; border: none; box-shadow: none; border-radius: 0; margin-bottom: 0; } 
      
      .global-filter-bar { background-color: transparent; padding: 0 1rem 1rem 1rem; border: none; box-shadow: none; border-radius: 0; margin-bottom: 0; } 
      .global-filter-bar .form-label { font-family: var(--font-oswald); font-weight: 700; text-transform: uppercase; font-size: 0.9rem; color: #555; }
    </style>
</head>
<body>

    <!-- MENU LATERAL FIXO -->
    <nav class="sidenav" id="mySidenav">
        <span class="closebtn" onclick="toggleSidebar()">&times;</span>
        <div class="sidenav-header">
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe">
        </div>
        <a href="#" onclick="navigateTo('dashboard'); return false;" class="active"><span class="material-symbols-outlined">dashboard</span>Dashboard</a>
        <a href="#" onclick="navigateTo('inspecoes'); return false;"><span class="material-symbols-outlined">table_view</span>Inspeções</a>
        <a href="#" onclick="navigateTo('parecer'); return false;"><span class="material-symbols-outlined">edit_note</span>Parecer</a>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="container-main" id="main">
        <div class="header-box"> 
            <span class="material-symbols-outlined mobile-toggle" onclick="toggleSidebar()">menu</span>
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
            <div class="header-text">
                <h1>DASHBOARD</h1>
            </div>
        </div>
      
        <div class="dashboard-content">
            <div class="card-elevated title-filter-card"> 
                <div class="global-filter-bar">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="yearFilter" class="form-label">Ano</label>
                            <select id="yearFilter" class="form-select"></select>
                        </div>
                        <div class="col-md-3">
                            <label for="monthFilter" class="form-label">Mês</label>
                            <select id="monthFilter" class="form-select"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loader" class="text-center card-elevated" style="padding: 50px;"> 
                <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div>
                <p class="mt-2">A carregar dados...</p>
            </div>

            <div id="mainContent" class="d-none">
                
                <div class="row g-4 mb-4"> 
                    <div class="col-lg-6">
                        <div class="card-elevated h-100"> 
                            <div class="kpi-block">
                                <div class="kpi-item level-1 text-center"><p class="kpi-value" id="kpiTotal">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">summarize</span>Total de Inspeções</h6></div><hr>
                                <div class="row text-center"><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiTisSigned">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">check_circle</span>TIS Assinados</h6></div><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgEnviada" style="color:var(--success-color);">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">mark_email_read</span>MSG Enviadas</h6></div></div><hr>
                                <div class="row text-center"><div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiAuditoria">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">policy</span>Auditoria CPMM</h6></div><div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiJsd">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">manage_search</span>Revisão JSD</h6></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card-elevated h-100"> 
                            <div class="kpi-block kpi-block-alert">
                                <div class="flex-fill d-flex align-items: center"><div class="row text-center w-100"><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">unsubscribe</span>MSG Pendentes</h6></div><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiExamesPendentes">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">lab_profile</span>Exames Pendentes</h6></div></div></div><hr class="my-0"><div class="flex-fill d-flex align-items: center"><div class="row text-center w-100"><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiConclusoesPendentes">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">help</span>Conclusões Pendentes</h6></div><div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiVotacaoPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">gavel</span>Votações Pendentes</h6></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-4 mb-4 justify-content-center"> 
                    <div class="col-md-6 col-lg-5">
                        <div class="card-elevated"> 
                            <div class="kpi-block">
                                <div class="row text-center">
                                    <div class="col-6 kpi-item level-3" id="kpi-item-cancelada"><p class="kpi-value" id="kpiCancelada">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">cancel</span>Canceladas</h6></div>
                                    <div class="col-6 kpi-item level-3" id="kpi-item-faltas"><p class="kpi-value" id="kpiFaltou">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">person_off</span>Faltas</h6></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4"> 
                    <div class="col-lg-4">
                        <div class="card-elevated"> 
                            <div class="chart-container">
                                <h4 class="text-center" style="font-family: 'Oswald', sans-serif;" id="finalidadeChartTitle"></h4>
                                <div id="purposeDonutChart"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card-elevated"> 
                            <div class="chart-container">
                                <h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Entrevistas por Mês</h4>
                                <div id="interviewsBarChart"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card-elevated"> 
                            <div class="chart-container">
                                <h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Tipo de Inspeção</h4>
                                <div id="tipoInspecaoPieChart"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        // --- NAVEGAÇÃO E SIDEBAR ---
        let BASE_URL = '';
        function navigateTo(page) { if (BASE_URL) window.top.location.href = BASE_URL + '?page=' + page; else alert("Aguarde o carregamento completo da página."); }
        function toggleSidebar() { document.getElementById("mySidenav").classList.toggle('active'); }

        // --- DADOS E LÓGICA (Original Restaurada) ---
        let allDashboardData = [];

        document.addEventListener('DOMContentLoaded', () => { 
            google.script.run.withSuccessHandler((url) => { BASE_URL = url; }).getWebAppUrl();
            
            document.getElementById('loader').classList.remove('d-none'); 
            document.getElementById('mainContent').classList.add('d-none'); 
            
            document.getElementById('yearFilter').addEventListener('change', applyGlobalFilters); 
            document.getElementById('monthFilter').addEventListener('change', applyGlobalFilters); 

            google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataError).getDashboardData(); 
        });

        function onDataLoaded(response) { 
            try { 
                if (!response || !Array.isArray(response.dashboardData)) throw new Error("Dados inválidos."); 
                
                allDashboardData = response.dashboardData.map(row => { 
                    const date = parseDate(row.EventDate); 
                    return {...row, year: date ? date.getFullYear() : null, month: date ? date.getMonth() : null}; 
                }); 
                
                document.getElementById('loader').classList.add('d-none'); 
                document.getElementById('mainContent').classList.remove('d-none'); 
                
                populateGlobalFilters(allDashboardData); 
                applyGlobalFilters(); 
            } catch(e) { 
                onDataError(e); 
            } 
        }
        
        function onDataError(error) { 
            document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`; 
        }

        function updateKPIs(data) { 
            try { 
                const countIn = (arr, column, value) => arr.filter(row => row && row[column] === value).length; 
                const validData = data.filter(row => row && row.StatusIS !== 'Faltou'); 
                
                document.getElementById('kpiTotal').textContent = validData.length; 
                document.getElementById('kpiTisSigned').textContent = countIn(validData, 'StatusIS', 'TIS assinado'); 
                document.getElementById('kpiExamesPendentes').textContent = countIn(validData, 'StatusIS', 'AGU exames'); 
                document.getElementById('kpiConclusoesPendentes').textContent = countIn(validData, 'StatusIS', 'Conclusão Pendente'); 
                document.getElementById('kpiVotacaoPendente').textContent = countIn(validData, 'StatusIS', 'Concluída'); 
                document.getElementById('kpiFaltou').textContent = data.length - validData.length; 
                
                const rotinaData = data.filter(row => row && row.type === 'Rotina'); 
                document.getElementById('kpiMsgEnviada').textContent = countIn(rotinaData, 'MSG', 'ENVIADA'); 
                document.getElementById('kpiAuditoria').textContent = countIn(rotinaData, 'StatusIS', 'Auditoria'); 
                document.getElementById('kpiJsd').textContent = countIn(rotinaData, 'StatusIS', 'JSD'); 
                document.getElementById('kpiMsgPendente').textContent = countIn(rotinaData, 'MSG', 'PENDENTE'); 
                document.getElementById('kpiCancelada').textContent = countIn(rotinaData, 'StatusIS', 'Cancelada'); 
                
                document.getElementById('kpi-item-cancelada').classList.toggle('text-alert-vivid', countIn(rotinaData, 'StatusIS', 'Cancelada') > 0); 
                document.getElementById('kpi-item-faltas').classList.toggle('text-alert-vivid', (data.length - validData.length) > 0); 
            } catch (e) { console.error("Erro KPIs:", e); } 
        }

        function drawCharts(kpiAndPieData, barChartData) { 
            google.charts.load('current', {'packages':['corechart']}); 
            google.charts.setOnLoadCallback(() => { 
                const chartOptions = { backgroundColor: 'transparent', chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' }, animation: { startup: true, duration: 1000, easing: 'out' } }; 
                document.getElementById('finalidadeChartTitle').textContent = 'Finalidades das IS de Rotina'; 
                
                // Donut Chart
                const rotinaData = kpiAndPieData.filter(r => r && r.type === 'Rotina'); 
                const purposeCounts = rotinaData.reduce((acc, row) => { if(row && row.Finalidade) { acc[row.Finalidade] = (acc[row.Finalidade] || 0) + 1; } return acc; }, {}); 
                const sortedPurposes = Object.entries(purposeCounts).sort(([,a],[,b]) => b - a); 
                let purposeDataArray = sortedPurposes.length > 4 ? [['Finalidade', 'Quantidade'], ...sortedPurposes.slice(0, 3), ['OUTROS', sortedPurposes.slice(3).reduce((sum, [, count]) => sum + count, 0)]] : [['Finalidade', 'Quantidade'], ...sortedPurposes];
                const purposeData = google.visualization.arrayToDataTable(purposeDataArray.length > 1 ? purposeDataArray : [['Finalidade', 'Quantidade']]); 
                new google.visualization.PieChart(document.getElementById('purposeDonutChart')).draw(purposeData, { ...chartOptions, pieHole: 0.4 }); 

                // Bar Chart
                const validDataForBarChart = barChartData.filter(row => row && row.StatusIS !== 'Faltou'); 
                const interviewCountsByMonth = validDataForBarChart.reduce((acc, row) => { if (row && row.EventDate) { const monthYear = row.EventDate.substring(3); acc[monthYear] = (acc[monthYear] || 0) + 1; } return acc; }, {}); 
                const sortedMonths = Object.keys(interviewCountsByMonth).sort((a,b) => { const [m1, y1] = a.split('/'); const [m2, y2] = b.split('/'); return new Date(y1, m1 - 1) - new Date(y2, m2 - 1); }); 
                const palette = ['#050f41', '#3e4a85', '#6b74a1', '#98a0bd', '#c5c8da']; 
                const interviewDataArray = [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]]; 
                sortedMonths.forEach((month, index) => { 
                    const count = interviewCountsByMonth[month]; 
                    const color = palette[index % palette.length]; 
                    const shortMonth = new Date(month.split('/')[1], month.split('/')[0]-1).toLocaleString('pt-BR', { month: 'short' }).toUpperCase(); 
                    const year = month.split('/')[1]; 
                    interviewDataArray.push([`${shortMonth}${year}`, count, `color: ${color};`, count.toString()]); 
                }); 
                const interviewData = google.visualization.arrayToDataTable(interviewDataArray.length > 1 ? interviewDataArray : [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]]); 
                new google.visualization.ColumnChart(document.getElementById('interviewsBarChart')).draw(interviewData, { ...chartOptions, fontName: 'Carlito', legend: { position: 'none' }, bar: { groupWidth: '60%' }, annotations: { alwaysOutside: true, textStyle: { fontName: 'Oswald', fontSize: 16, bold: true, color: '#212529' }}, hAxis: { textStyle: { fontSize: 14, fontName: 'Oswald', bold: true }}, vAxis: { minValue: 0, gridlines: { color: 'transparent' }, baselineColor: '#ccc', textPosition: 'none'}, chartArea: { width: '90%', height: '70%', top: 40, bottom: 50 }}); 

                // Pie Chart
                const validDataForPie = kpiAndPieData.filter(row => row && row.StatusIS !== 'Faltou'); 
                const typeCounts = validDataForPie.reduce((acc, row) => { if (row) { const typeName = row.type === 'Rotina' ? 'IS de Rotina' : 'Concursos'; acc[typeName] = (acc[typeName] || 0) + 1; } return acc; }, {}); 
                const tipoInspecaoDataArray = [['Tipo', 'Quantidade'], ...Object.entries(typeCounts)]; 
                const tipoInspecaoData = google.visualization.arrayToDataTable(tipoInspecaoDataArray.length > 1 ? tipoInspecaoDataArray : [['Tipo', 'Quantidade']]); 
                new google.visualization.PieChart(document.getElementById('tipoInspecaoPieChart')).draw(tipoInspecaoData, chartOptions); 
            }); 
        }

        function populateGlobalFilters(data) { 
            const yearFilter = document.getElementById('yearFilter'); 
            const monthFilter = document.getElementById('monthFilter'); 
            const years = [...new Set(data.map(r => r && r.year).filter(Boolean))].sort((a,b) => b - a); 
            yearFilter.innerHTML = '<option value="todos">Todos os Anos</option>'; 
            years.forEach(y => yearFilter.add(new Option(y, y))); 
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; 
            monthFilter.innerHTML = '<option value="todos">Todos os Meses</option>'; 
            monthNames.forEach((name, index) => monthFilter.add(new Option(name, index))); 
            
            const currentDate = new Date(); 
            if (years.length > 0) yearFilter.value = years.includes(currentDate.getFullYear()) ? currentDate.getFullYear() : years[0]; 
            monthFilter.value = currentDate.getMonth(); 
        }

        function applyGlobalFilters() { 
            const year = document.getElementById('yearFilter').value; 
            const month = document.getElementById('monthFilter').value; 
            const yearFilteredData = allDashboardData.filter(row => row && (year === 'todos' || row.year == year)); 
            const fullyFilteredData = yearFilteredData.filter(row => row && (month === 'todos' || row.month == month)); 
            updateKPIs(fullyFilteredData); 
            drawCharts(fullyFilteredData, yearFilteredData); 
        }

        function parseDate(dateString) { if (!dateString || typeof dateString !== 'string' || !dateString.includes('/')) return null; const parts = dateString.split('/'); if (parts.length !== 3) return null; const year = parseInt(parts[2], 10) < 100 ? 2000 + parseInt(parts[2], 10) : parseInt(parts[2], 10); const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; return new Date(year, month, day); }
    </script>
</body>
</html>
