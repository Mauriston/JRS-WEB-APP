<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
      :root { --primary-color: #050F41; --accent-color: #FAB932; --success-color: #079551; --danger-color: #B71C1C; --font-main: 'Montserrat', sans-serif; --sidebar-width-collapsed: 70px; --sidebar-width-expanded: 260px; }
      @font-face { font-family: 'Octin College Bold'; src: url('Octin College Bold.ttf') format('truetype'); font-weight: bold; font-style: normal; font-display: swap; }
      body { font-family: var(--font-main); background: #f4f4f9; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
      
      .sidenav { height: 100%; width: var(--sidebar-width-collapsed); position: fixed; z-index: 1000; top: 0; left: 0; background: var(--primary-color); transition: width 0.4s; display: flex; flex-direction: column; overflow: hidden; }
      .sidenav:hover { width: var(--sidebar-width-expanded); }
      .sidenav-header { display:flex;justify-content:center;align-items:center;height:80px;padding-top:15px; }
      .sidenav-header img { width: 40px; transition: 0.3s; }
      .sidenav:hover .sidenav-header img { width: 90px; }
      
      /* Links do Menu */
      .sidenav a { 
          padding: 0; text-decoration: none; font-size: 16px; font-weight: 600; color: #e0e0e0; 
          display: flex; align-items: center; border-left: 4px solid transparent; 
          height: 50px; overflow: hidden; white-space: nowrap; cursor: pointer; width: 100%; 
      }
      .sidenav a:hover, .sidenav a.active { background: rgba(255,255,255,0.1); color: #fff; border-left: 4px solid var(--accent-color); }
      
      /* ÍCONES MENU (SOLICITADO) */
      .sidenav a .material-symbols-outlined { 
          min-width: var(--sidebar-width-collapsed); text-align: center; font-size: 24px; margin-left: -4px; z-index: 2;
          font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 48 !important;
      }
      
      .nav-text { opacity: 0; transition: 0.3s; pointer-events: none; margin-left: 10px; }
      .sidenav:hover .nav-text { opacity: 1; }
      
      .sidenav-footer { margin-top: auto; padding-bottom: 20px; display: flex; justify-content: center; opacity: 0.7; }
      .sidenav:hover .sidenav-footer { opacity: 1; }
      .sidenav-footer img { width: 40px; transition: 0.3s; }
      .sidenav:hover .sidenav-footer img { width: 140px; }
      
      .container-main { margin-left: var(--sidebar-width-collapsed); padding: 20px; flex: 1; display: flex; flex-direction: column; transition: 0.4s; }
      .header-box { display: flex; justify-content: center; align-items: center; background: var(--primary-color); color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
      .header-text h1 { font-family: 'Octin College Bold', 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; font-size: 32px; margin: 0; }
      
      .filters-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
      .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
      .filter-group label { font-size: 12px; font-weight: 700; color: var(--primary-color); text-transform: uppercase; }
      .filter-group input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
      .btn-filter { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; height: 40px; display: flex; align-items: center; gap: 8px; }
      .btn-filter.clear-mode { background-color: #666; }
      
      .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
      .card { background: white; border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: space-between; border-left: 5px solid var(--primary-color); transition: 0.3s; }
      .card:hover { transform: translateY(-3px); }
      .card-info h3 { margin: 0; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: 700; }
      .card-info p { margin: 0; font-size: 28px; font-weight: 900; color: var(--primary-color); font-family: 'Montserrat', sans-serif; }
      .card-info small { font-size: 11px; color: #888; font-weight: 500; }
      .card-icon { background: rgba(5, 15, 65, 0.05); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-color); }
      .card.danger { border-left-color: var(--danger-color); } .card.danger .card-info p { color: var(--danger-color); } .card.danger .card-icon { background: rgba(183, 28, 28, 0.1); color: var(--danger-color); }
      .card.warning { border-left-color: var(--accent-color); } .card.warning .card-icon { background: rgba(250, 185, 50, 0.1); color: #d49600; }
      .card.info { border-left-color: #1976D2; } .card.info .card-icon { background: #E3F2FD; color: #1976D2; }
      
      .charts-container { display: grid; grid-template-columns: 1.5fr 1fr 1.5fr; gap: 20px; }
      .chart-box { background: white; padding: 20px; border-radius: 8px; min-height: 350px; display: flex; flex-direction: column; }
      .chart-header h3 { margin: 0 0 15px 0; color: var(--primary-color); font-size: 15px; font-weight: 700; text-transform: uppercase; }
      .chart-wrapper { flex: 1; position: relative; }
      
      /* RODAPÉ AJUSTADO */
      .main-footer { 
          margin-top: auto; padding: 20px; display: flex; justify-content: center; align-items: center; gap: 80px; 
          border-top: 1px solid #e0e0e0; 
      }
      .footer-logo { height: 70px; width: auto; object-fit: contain; }
      
      #error-banner { background: #ffebee; color: #c62828; padding: 10px; margin-bottom: 20px; border-radius: 4px; display: none; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="sidenav" id="mySidenav">
        <div class="sidenav-header"><img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe"></div>
        <!-- LINKS DE NAVEGAÇÃO -->
        <a href="<?= url ?>?page=dashboard" class="active"><span class="material-symbols-outlined">chart_data</span><span class="nav-text">Dashboard</span></a>
        <a href="<?= url ?>?page=inspecoes"><span class="material-symbols-outlined">clinical_notes</span><span class="nav-text">Inspeções</span></a>
        <a href="<?= url ?>?page=parecer"><span class="material-symbols-outlined">lab_profile</span><span class="nav-text">Parecer</span></a>
        <div class="sidenav-footer"><img src="https://i.imgur.com/XHPXHdt.png"></div>
    </nav>
    <main class="container-main">
        <div class="header-box"><div class="header-text"><h1>DASHBOARD</h1></div></div>
        <div id="error-banner"></div>
        <div class="filters-box">
            <div class="filter-group"><label>Data Início</label><input type="date" id="filter_start"></div>
            <div class="filter-group"><label>Data Fim</label><input type="date" id="filter_end"></div>
            <button class="btn-filter" id="btnFilterAction" onclick="applyFilters()"><span class="material-symbols-outlined" id="btnFilterIcon">filter_list</span> <span id="btnFilterText">FILTRAR</span></button>
        </div>
        <div class="dashboard-grid" id="kpiContainer">
            <div class="card"><div class="card-info"><h3>Total Inspeções</h3><p id="kpi_total">0</p><small id="kpi_total_desc">Total Histórico</small></div><div class="card-icon"><span class="material-symbols-outlined">assignment</span></div></div>
            <div class="card danger"><div class="card-info"><h3>MSG Pendentes</h3><p id="kpi_msg_pend">0</p><small id="kpi_msg_perc">0% do total</small></div><div class="card-icon"><span class="material-symbols-outlined">mark_email_unread</span></div></div>
            <div class="card warning"><div class="card-info"><h3>Pendentes</h3><p id="kpi_pendentes">0</p><small>Aguardando Conclusão</small></div><div class="card-icon"><span class="material-symbols-outlined">hourglass_top</span></div></div>
            <div class="card info"><div class="card-info"><h3>REVISÃO JSD</h3><p id="kpi_rev_jsd">0</p><small id="kpi_rest_jsd">Restituídas = 0</small></div><div class="card-icon"><span class="material-symbols-outlined">rate_review</span></div></div>
            <div class="card info"><div class="card-info"><h3>AUDITORIA CPMM</h3><p id="kpi_auditoria">0</p><small id="kpi_rest_audit">Restituídas = 0</small></div><div class="card-icon"><span class="material-symbols-outlined">fact_check</span></div></div>
            <div class="card"><div class="card-info"><h3>CANCELADAS</h3><p id="kpi_canceladas">0</p></div><div class="card-icon" style="background:#eee;color:#666"><span class="material-symbols-outlined">cancel</span></div></div>
            <div class="card"><div class="card-info"><h3>FALTAS</h3><p id="kpi_faltas">0</p></div><div class="card-icon" style="background:#eee;color:#666"><span class="material-symbols-outlined">event_busy</span></div></div>
            <div class="card info" id="card_concursos" style="display:none;"><div class="card-info"><h3>CONCURSOS</h3><p id="kpi_concursos">0</p><small>Período Selecionado</small></div><div class="card-icon"><span class="material-symbols-outlined">school</span></div></div>
        </div>
        <div class="charts-container">
            <div class="chart-box"><div class="chart-header"><h3>Evolução de Atendimentos</h3></div><div class="chart-wrapper"><canvas id="chartEvolucao"></canvas></div></div>
            <div class="chart-box"><div class="chart-header"><h3>Distribuição por OM</h3></div><div class="chart-wrapper"><canvas id="chartOM"></canvas></div></div>
            <div class="chart-box"><div class="chart-header"><h3>IS de ROTINA (Finalidade)</h3></div><div class="chart-wrapper"><canvas id="chartRotina"></canvas></div></div>
        </div>
        <footer class="main-footer">
            <img src="https://i.imgur.com/mPObmH0.png" class="footer-logo" alt="Logo HNRe">
            <img src="https://i.imgur.com/lYp37Ar.png" class="footer-logo" alt="Logo Marinha">
        </footer>
    </main>
    <script>
        let rawData=[], isFiltered=false;
        document.addEventListener("DOMContentLoaded",()=>{ google.script.run.withSuccessHandler(data=>{rawData=data;updateDashboard()}).getDashboardData(); });
        function applyFilters(){
            const s=document.getElementById('filter_start').value, e=document.getElementById('filter_end').value;
            if(isFiltered){ document.getElementById('filter_start').value='';document.getElementById('filter_end').value=''; isFiltered=false; document.getElementById('btnFilterAction').classList.remove('clear-mode'); }
            else if(s||e){ isFiltered=true; document.getElementById('btnFilterAction').classList.add('clear-mode'); }
            updateDashboard();
        }
        function updateDashboard(){
            let d=rawData;
            const s=document.getElementById('filter_start').value, e=document.getElementById('filter_end').value;
            if(isFiltered&&(s||e)) d=rawData.filter(r=>(!s||r.DataEntrevista>=s)&&(!e||r.DataEntrevista<=e));

            // KPIs com STRINGS EXATAS
            document.getElementById('kpi_total').innerText=d.length;
            document.getElementById('kpi_total_desc').innerText=isFiltered?"Período Selecionado":"Total Histórico";
            
            // MSG (PENDENTE ou ATRASADA)
            const msgP = d.filter(r=>r.MSG==='MSG PENDENTE' || r.MSG==='MSG ATRASADA').length;
            document.getElementById('kpi_msg_pend').innerText=msgP;
            
            // Pendentes
            document.getElementById('kpi_pendentes').innerText=d.filter(r=>['IS Agendada','IS Remarcada','Conclusão Pendente'].includes(r.StatusIS)).length;
            
            // Revisão JSD
            document.getElementById('kpi_rev_jsd').innerText=d.filter(r=>r.StatusIS==='REVISÃO JSD').length;
            document.getElementById('kpi_rest_jsd').innerText=`Restituídas = ${d.filter(r=>r.StatusIS==='Restituída JSD').length}`;
            
            // Auditoria
            document.getElementById('kpi_auditoria').innerText=d.filter(r=>r.StatusIS==='AUDITORIA CPMM').length;
            document.getElementById('kpi_rest_audit').innerText=`Restituídas = ${d.filter(r=>r.StatusIS==='Restituída AUDITORIA CPMM').length}`;
            
            // Canceladas e Faltas (Strings Exatas)
            document.getElementById('kpi_canceladas').innerText=d.filter(r=>r.StatusIS==='IS Cancelada').length;
            document.getElementById('kpi_faltas').innerText=d.filter(r=>r.StatusIS==='Faltou').length;
            
            // Concursos (Começa com INGRESSO)
            const conc=d.filter(r=>r.Finalidade&&r.Finalidade.startsWith('INGRESSO')).length;
            document.getElementById('card_concursos').style.display=(isFiltered&&conc>0)?'flex':'none';
            document.getElementById('kpi_concursos').innerText=conc;

            renderCharts(d, rawData);
        }
        
        let cEvol, cOM, cRot;
        function renderCharts(filt, all){
            const pal=['#050F41','#079551','#FAB932','#1976D2','#7CB342'];
            
            // 1. Evolução
            const grp={};
            all.forEach(r=>{
                if(!r.DataEntrevista)return;
                const p = r.DataEntrevista.split('-'); 
                const k = `${p[0]}-${p[1]}`; 
                const dt = new Date(p[0], p[1]-1, p[2]);
                const lbl = dt.toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}).toUpperCase().replace('.','');
                if(!grp[k])grp[k]={l:lbl,c:0,r:0};
                if(r.Finalidade&&r.Finalidade.startsWith('INGRESSO'))grp[k].c++; else grp[k].r++;
            });
            const ks=Object.keys(grp).sort();
            
            if(cEvol)cEvol.destroy();
            cEvol=new Chart(document.getElementById('chartEvolucao'),{
                type:'bar',
                data:{
                    labels:ks.map(k=>grp[k].l),
                    datasets:[
                        {label:'CONCURSOS',data:ks.map(k=>grp[k].c),backgroundColor:'#B71C1C',datalabels:{color:'white',font:{weight:'bold'},display:x=>x.dataset.data[x.dataIndex]>0}},
                        {label:'ROTINA',data:ks.map(k=>grp[k].r),backgroundColor:'#050F41',datalabels:{color:'white',font:{weight:'bold'},display:x=>x.dataset.data[x.dataIndex]>0}}
                    ]
                },
                options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}}},
                plugins:[ChartDataLabels]
            });

            // 2. OM
            const oms={}; filt.forEach(r=>{if(r.OM)oms[r.OM]=(oms[r.OM]||0)+1});
            if(cOM)cOM.destroy();
            cOM=new Chart(document.getElementById('chartOM'),{
                type:'doughnut',
                data:{labels:Object.keys(oms),datasets:[{data:Object.values(oms),backgroundColor:pal}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'},datalabels:{display:false}}}
            });

            // 3. Rotina
            const rot=filt.filter(r=>r.Finalidade&&!r.Finalidade.startsWith('INGRESSO'));
            const fins={}; rot.forEach(r=>{ if(r.Finalidade) fins[r.Finalidade]=(fins[r.Finalidade]||0)+1; });
            let srt=Object.entries(fins).sort((a,b)=>b[1]-a[1]);
            let top=srt.slice(0,5), oth=srt.slice(5).reduce((s,i)=>s+i[1],0);
            if(oth>0)top.push(['OUTRAS',oth]);
            
            if(cRot)cRot.destroy();
            cRot=new Chart(document.getElementById('chartRotina'),{
                type:'bar',
                data:{labels:top.map(i=>i[0]),datasets:[{label:'Qtd',data:top.map(i=>i[1]),backgroundColor:pal,indexAxis:'y'}]},
                options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false}}}
            });
        }
    </script>
</body>
</html>
