<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Oswald:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #050f41;
        --danger-color: #990000;
        --danger-color-vivid: #d9534f;
        --danger-color-light: #fef5f5;
        --success-color: #146c43;
        --link-color: #0d6efd;
        --font-oswald: 'Oswald', sans-serif;
        --font-carlito: 'Carlito', sans-serif;
        --light-gray-1: #fcfcfc;
      }
      body {
        font-family: var(--font-carlito);
        background-color: #f4f4f9;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container-main { max-width: 1400px; margin: 20px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, .1); overflow: hidden; }

      .header-box { display: flex; align-items: center; background-color: var(--primary-color); color: #fff; padding: 20px 30px; }
      .header-logo { height: 65px; margin-right: 25px; }
      .header-text h1 { font-family: var(--font-oswald); font-size: 32px; margin: 0; font-weight: 700; line-height: 1.1; }
      .header-text p { font-family: var(--font-carlito); font-size: 18px; margin: 5px 0 0; opacity: .9; }
      
      .icon-btn {
          margin-left: auto;
          color: white;
          text-decoration: none;
          background-color: rgba(255, 255, 255, 0.2);
          border-radius: 50%;
          width: 60px;
          height: 60px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background-color 0.3s;
      }
      .icon-btn:hover {
          background-color: rgba(255, 255, 255, 0.4);
          color: white;
      }
      .icon-btn .material-symbols-outlined {
          font-size: 32px;
      }

      .dashboard-content { padding: 30px; }
      .dashboard-title-wrapper { display: flex; justify-content: center; width: 100%; margin: 20px 0 40px 0; }
      .dashboard-title, .section-title { 
        display: flex; align-items: center; justify-content: center;
        font-family: var(--font-oswald); font-size: 32px; font-weight: 700; 
        text-transform: uppercase; gap: 15px; color: #333;
      }
      .dashboard-title { margin-bottom: 0; }
      .section-title { margin-top: 40px; margin-bottom: 25px; }
      .dashboard-title .material-symbols-outlined,
      .section-title .material-symbols-outlined { font-size: 38px !important; }

      .kpi-value { margin-bottom: 0.5rem !important; }
      #loader { text-align: center; padding: 50px; }
      
      .kpi-block { border-radius: 8px; border: 1px solid #e0e0e0; padding: 1.2rem; height: 100%; }
      .kpi-block-alert { background-color: var(--danger-color-light); border-color: var(--danger-color-vivid); display: flex; flex-direction: column; }
      .kpi-item { margin-bottom: 0.5rem; }
      .kpi-title { font-family: var(--font-oswald); text-transform: uppercase; font-weight: 800; color: #555; display: flex; align-items: center; gap: 8px; }
      .kpi-value { font-family: var(--font-oswald); font-weight: 700; line-height: 1; margin: 0; }
      .material-symbols-outlined { font-variation-settings: 'FILL' 1; }
      
      .kpi-item.level-1 .kpi-title { font-size: 1.2rem; }
      .kpi-item.level-1 .kpi-value { font-size: 5rem; }
      .kpi-item.level-2 .kpi-title { font-size: 1.1rem; }
      .kpi-item.level-2 .kpi-value { font-size: 3.5rem; }
      .kpi-item.level-3 .kpi-title { font-size: 0.9rem; }
      .kpi-item.level-3 .kpi-value { font-size: 2.2rem; }

      .kpi-block-alert .kpi-title, .kpi-block-alert .kpi-value { color: var(--danger-color); }
      .kpi-block-alert .kpi-title { color: var(--danger-color-vivid); }
      .text-alert-vivid .kpi-title,
      .text-alert-vivid .kpi-value,
      .text-alert-vivid .material-symbols-outlined { color: var(--danger-color-vivid) !important; }
      
      .chart-container { background-color: var(--light-gray-1); padding: 20px; border-radius: 8px; border: 1px solid #e9e9e9; height: 400px; }
      .table-container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      
      .status-pendente { font-weight: bold; color: var(--danger-color); }
      .read-more-icon, .info-icon { cursor: pointer; color: var(--link-color); vertical-align: bottom; margin-left: 5px; }
      .read-more-icon:hover, .info-icon:hover { filter: brightness(0.8); }
      
      .modal-header { background-color: var(--primary-color); color: white; }
      .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
      .laudo-details span { font-family: var(--font-oswald); text-transform: uppercase; color: #555; font-size: 0.9em;}
      .laudo-details p { margin-bottom: 1rem; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container-main">
      <div class="header-box">
        <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
        <div class="header-text">
          <h1>JUNTA REGULAR DE SAÚDE</h1>
          <p>HOSPITAL NAVAL DE RECIFE</p>
        </div>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=form" class="icon-btn" title="Nova IS">
            <span class="material-symbols-outlined">person_add</span>
        </a>
      </div>

      <div class="dashboard-content">
        <div class="dashboard-title-wrapper">
            <h2 class="dashboard-title">
              <span class="material-symbols-outlined">medical_information</span>
              INSPEÇÕES DE SAÚDE
            </h2>
        </div>

        <div id="loader" class="text-center">
          <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div>
          <p class="mt-2">A carregar dados...</p>
        </div>

        <div id="mainContent" class="d-none">
            <div class="row g-4 mb-4">
              <div class="col-lg-6">
                <div class="kpi-block">
                  <div class="kpi-item level-1 text-center"><p class="kpi-value" id="kpiTotal">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">summarize</span>Total de Inspeções</h6></div><hr>
                  <div class="row text-center">
                    <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiTisSigned">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">check_circle</span>TIS Assinados</h6></div>
                    <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgEnviada" style="color:var(--success-color);">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">send</span>MSG Enviadas</h6></div>
                  </div><hr>
                  <div class="row text-center">
                    <div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiAuditoria">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">policy</span>Auditoria CPMM</h6></div>
                    <div class="col-6 kpi-item level-3"><p class="kpi-value" id="kpiJsd">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">manage_search</span>Revisão JSD</h6></div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="kpi-block kpi-block-alert">
                  <div class="flex-fill d-flex align-items-center"><div class="row text-center w-100">
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiMsgPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">pending_actions</span>MSG Pendentes</h6></div>
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiConclusaoPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">help</span>Conclusões Pendentes</h6></div>
                  </div></div><hr class="my-0">
                  <div class="flex-fill d-flex align-items-center"><div class="row text-center w-100">
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiVotacaoPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">gavel</span>Votações Pendentes</h6></div>
                      <div class="col-6 kpi-item level-2"><p class="kpi-value" id="kpiAssinaturaPendente">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">draw</span>Assinaturas Pendentes</h6></div>
                  </div></div>
                </div>
              </div>
            </div>
            <div class="row g-4 mb-4 justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="kpi-block">
                        <div class="row text-center">
                           <div class="col-6 kpi-item level-3" id="kpi-item-cancelada"><p class="kpi-value" id="kpiCancelada">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">cancel</span>Canceladas</h6></div>
                           <div class="col-6 kpi-item level-3" id="kpi-item-faltas"><p class="kpi-value" id="kpiFaltou">0</p><h6 class="kpi-title justify-content-center"><span class="material-symbols-outlined">person_off</span>Faltas</h6></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-lg-6 mb-3"><div class="chart-container"><h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Inspeções por Finalidade</h4><div id="purposeDonutChart"></div></div></div>
              <div class="col-lg-6 mb-3"><div class="chart-container"><h4 class="text-center" style="font-family: 'Oswald', sans-serif;">Entrevistas por Mês</h4><div id="interviewsBarChart"></div></div></div>
            </div>
            <div class="row"><div class="col-12"><div class="table-container">
              <h2 class="section-title">
                  <span class="material-symbols-outlined">patient_list</span>
                  DETALHES DAS INSPEÇÕES
              </h2>
              <div class="row g-3 mb-3">
                <div class="col-md-4"><input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome do inspecionado..."></div>
                <div class="col-md-4"><select id="purposeFilter" class="form-select"></select></div>
                <div class="col-md-4"><select id="statusFilter" class="form-select"></select></div>
              </div>
              <div class="table-responsive"><table class="table table-hover">
                <thead><tr><th>IS</th><th>Data Entrevista</th><th>Finalidade</th><th>Status</th><th>Inspecionado</th><th>Laudo</th><th>MSG</th></tr></thead>
                <tbody id="dataTableBody"></tbody>
              </table></div>
            </div></div></div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="laudoModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Detalhes da Conclusão</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body laudo-details">
            <span>Laudo</span><p id="modalLaudo"></p>
            <div class="row">
              <div class="col-md-4"><span>Data</span><p id="modalDataLaudo"></p></div>
              <div class="col-md-4"><span>TIS</span><p id="modalTis"></p></div>
              <div class="col-md-4"><span>Código DS-1A</span><p id="modalDs1a"></p></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="obsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Observações</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><p id="modalObsText"></p></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      let allData = [];
      let filteredData = [];
      let laudoModalInstance, obsModalInstance;

      document.addEventListener('DOMContentLoaded', () => {
        laudoModalInstance = new bootstrap.Modal(document.getElementById('laudoModal'));
        obsModalInstance = new bootstrap.Modal(document.getElementById('obsModal'));

        google.script.run
          .withSuccessHandler(onDataLoaded)
          .withFailureHandler(onDataError)
          .getDashboardData();
      });

      function onDataLoaded(data) {
        allData = data;
        document.getElementById('loader').classList.add('d-none');
        document.getElementById('mainContent').classList.remove('d-none');
        updateKPIs();
        populateFilters(); 
        drawCharts(); 
        applyFilters();
        document.getElementById('searchInput').addEventListener('keyup', applyFilters);
        document.getElementById('purposeFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
      }

      function onDataError(error) { 
        console.error('Falha ao carregar os dados:', error); 
        document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Erro ao carregar dados. Verifique o console para mais detalhes.</div>`;
      }
      
      function updateKPIs() {
        const countOccurrences = (column, value) => allData.filter(row => row[column] === value).length;
        const tisSignedCount = countOccurrences('StatusIS', 'TIS assinado');
        const msgPendenteCount = countOccurrences('MSG', 'PENDENTE');
        const msgEnviadaCount = countOccurrences('MSG', 'ENVIADA');
        const conclusaoPendenteCount = countOccurrences('StatusIS', 'AGU exames');
        const votacaoPendenteCount = countOccurrences('StatusIS', 'Concluída');
        const assinaturaPendenteCount = countOccurrences('StatusIS', 'Votada JRS');
        const auditoriaCount = countOccurrences('StatusIS', 'Auditoria');
        const jsdCount = countOccurrences('StatusIS', 'JSD');
        const canceladaCount = countOccurrences('StatusIS', 'Cancelada');
        const faltouCount = countOccurrences('StatusIS', 'Faltou');

        document.getElementById('kpiTotal').textContent = allData.length;
        document.getElementById('kpiTisSigned').textContent = tisSignedCount;
        document.getElementById('kpiMsgPendente').textContent = msgPendenteCount;
        document.getElementById('kpiMsgEnviada').textContent = msgEnviadaCount;
        document.getElementById('kpiConclusaoPendente').textContent = conclusaoPendenteCount;
        document.getElementById('kpiVotacaoPendente').textContent = votacaoPendenteCount;
        document.getElementById('kpiAssinaturaPendente').textContent = assinaturaPendenteCount;
        document.getElementById('kpiAuditoria').textContent = auditoriaCount;
        document.getElementById('kpiJsd').textContent = jsdCount;
        document.getElementById('kpiCancelada').textContent = canceladaCount;
        document.getElementById('kpiFaltou').textContent = faltouCount;

        const canceladaItem = document.getElementById('kpi-item-cancelada');
        if (canceladaCount > 0) { canceladaItem.classList.add('text-alert-vivid'); } 
        else { canceladaItem.classList.remove('text-alert-vivid'); }

        const faltasItem = document.getElementById('kpi-item-faltas');
        if (faltouCount > 0) { faltasItem.classList.add('text-alert-vivid'); }
        else { faltasItem.classList.remove('text-alert-vivid'); }
      }

      function populateFilters() {
        const purposes = ['Todas as Finalidades', ...new Set(allData.map(row => row.Finalidade).filter(Boolean).sort())];
        const statuses = ['Todos os Status', ...new Set(allData.map(row => row.StatusIS).filter(Boolean).sort())];
        const purposeFilter = document.getElementById('purposeFilter');
        const statusFilter = document.getElementById('statusFilter');
        purposes.forEach(p => purposeFilter.add(new Option(p, p)));
        statuses.forEach(s => statusFilter.add(new Option(s, s)));
      }

      function drawCharts() {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => {
          const chartBackgroundColor = 'transparent';
          
          const purposeCounts = allData.reduce((acc, row) => {
              if(row.Finalidade) { acc[row.Finalidade] = (acc[row.Finalidade] || 0) + 1; }
              return acc;
          }, {});
          const sortedPurposes = Object.entries(purposeCounts).sort(([,a],[,b]) => b - a);
          let purposeData;
          if (sortedPurposes.length > 4) {
              const top3 = sortedPurposes.slice(0, 3);
              const othersCount = sortedPurposes.slice(3).reduce((sum, [, count]) => sum + count, 0);
              purposeData = [['Finalidade', 'Quantidade'], ...top3, ['OUTROS', othersCount]];
          } else {
              purposeData = [['Finalidade', 'Quantidade'], ...sortedPurposes];
          }
          new google.visualization.PieChart(document.getElementById('purposeDonutChart')).draw(
            google.visualization.arrayToDataTable(purposeData), 
            { pieHole: 0.4, backgroundColor: chartBackgroundColor, chartArea: { left: '5%', top: '5%', width: '90%', height: '90%' } }
          );
          
          const interviewCountsByMonth = allData.reduce((acc, row) => {
            if (row.DataEntrevista && row.DataEntrevista.includes('/')) {
              const parts = row.DataEntrevista.split('/');
              if(parts.length === 3) {
                 const monthYear = `${parts[1]}/${parts[2]}`;
                 acc[monthYear] = (acc[monthYear] || 0) + 1;
              }
            }
            return acc;
          }, {});
          const sortedMonths = Object.keys(interviewCountsByMonth).sort((a,b) => {
              const [m1, y1] = a.split('/'); const [m2, y2] = b.split('/');
              return new Date(y1, m1 - 1) - new Date(y2, m2 - 1);
          });
          const palette = ['#050f41', '#3e4a85', '#6b74a1', '#98a0bd', '#c5c8da'];
          const interviewData = [['Mês/Ano', 'Nº de Inspeções', { role: 'style' }, { role: 'annotation' }]];
          sortedMonths.forEach((month, index) => {
            const count = interviewCountsByMonth[month];
            const color = palette[index % palette.length];
            const shortMonth = new Date(month.split('/')[1], month.split('/')[0]-1).toLocaleString('pt-BR', { month: 'short' }).toUpperCase();
            const year = month.split('/')[1];
            const axisLabel = `${shortMonth}${year}`;
            interviewData.push([axisLabel, count, `color: ${color};`, count.toString()]);
          });
          new google.visualization.ColumnChart(document.getElementById('interviewsBarChart')).draw(
            google.visualization.arrayToDataTable(interviewData), 
            { fontName: 'Carlito', backgroundColor: chartBackgroundColor, legend: { position: 'none' }, bar: { groupWidth: '60%' }, annotations: { alwaysOutside: true, textStyle: { fontName: 'Oswald', fontSize: 16, bold: true, color: '#212529' }}, hAxis: { textStyle: { fontSize: 14, fontName: 'Oswald', bold: true }}, vAxis: { minValue: 0, gridlines: { color: 'transparent' }, baselineColor: '#ccc', textPosition: 'none'}, chartArea: { width: '90%', height: '70%', top: 40, bottom: 50 }}
          );
        });
      }

      function renderTable(dataToRender) {
        const tBody = document.getElementById('dataTableBody');
        tBody.innerHTML = '';
        if (dataToRender.length === 0) { tBody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum resultado encontrado.</td></tr>'; return; }
        
        const statusMap = {
            'AGU exames': '<span class="status-pendente">Conclusão Pendente</span>',
            'Concluída': '<span class="status-pendente">Votação Pendente</span>',
            'Votada JRS': '<span class="status-pendente">Assinatura Pendente</span>'
        };

        dataToRender.forEach((row, index) => {
          const tr = tBody.insertRow();
          
          let statusHtml = statusMap[row.StatusIS] || row.StatusIS || '';
          if (row.StatusIS === 'AGU exames' && row.Laudo) {
            statusHtml += `<span class="material-symbols-outlined info-icon" title="Observações" onclick="showObsModal(${index})">info</span>`;
          }
          
          let laudoHtml = '';
          if (row.Laudo && row.StatusIS !== 'AGU exames') {
              const laudoText = (row.Laudo || '').substring(0, 50);
              const displayText = row.Laudo.length > 50 ? laudoText + '...' : laudoText;
              const iconHtml = ` <span class="material-symbols-outlined read-more-icon" title="Detalhes" onclick="showLaudoModal(${index})">read_more</span>`;
              laudoHtml = displayText + iconHtml;
          }

          let msgHtml = '';
          if (row.MSG === 'ENVIADA') { msgHtml = `<span class="material-symbols-outlined" style="color:var(--success-color)">check_circle</span>`;
          } else if (row.MSG === 'PENDENTE') { msgHtml = `<span class="material-symbols-outlined" style="color:var(--danger-color-vivid)">schedule</span>`;
          } else { msgHtml = row.MSG || ''; }

          tr.innerHTML = `<td>${row.IS||''}</td><td>${row.DataEntrevista||''}</td><td>${row.Finalidade||''}</td><td>${statusHtml}</td><td>${row.Inspecionado||''}</td><td>${laudoHtml}</td><td>${msgHtml}</td>`;
        });
      }
      
      function showLaudoModal(index) {
        const data = filteredData[index];
        document.getElementById('modalLaudo').textContent = data.Laudo || 'Não informado';
        document.getElementById('modalDataLaudo').textContent = data.DataLaudo || 'Não informado';
        document.getElementById('modalTis').textContent = data.TIS || 'Não informado';
        document.getElementById('modalDs1a').textContent = data['DS-1a'] || 'Não informado';
        laudoModalInstance.show();
      }
      
      function showObsModal(index) {
        const data = filteredData[index];
        document.getElementById('modalObsText').textContent = data.Laudo || 'Nenhuma observação encontrada.';
        obsModalInstance.show();
      }

      function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const purpose = document.getElementById('purposeFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        filteredData = allData.filter(r => 
          (!search || (r.Inspecionado||'').toLowerCase().includes(search)) &&
          (purpose === 'Todas as Finalidades' || r.Finalidade === purpose) &&
          (status === 'Todos os Status' || r.StatusIS === status)
        );
        renderTable(filteredData);
      }
    </script>
</body>
</html>
