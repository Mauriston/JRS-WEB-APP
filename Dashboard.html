<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400..700,0..1,200" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script type="module" src="https://esm.run/@material/web/all.js"></script>

    <style>
      :root {
        --primary-color: #050F41;
        --background-color: #F5F5F5;
        --card-background-color: #FFFFFF;
        --filter-background-color: #E0E0E0;
        --text-color: #333333;
        --label-color: #555555;
        --danger-color: #D32F2F; /* Cor vermelha para KPI urgente */
        /* Cores de Destaque da Tabela */
        --highlight-bg: #fef5f5;
        --highlight-text: #990000;
        
        --primary-font: 'Montserrat', sans-serif;
        --body-font: 'Carlito', sans-serif;

        /* Override MWC Theme */
        --md-sys-color-primary: var(--primary-color);
        --md-sys-color-background: var(--background-color);
        --md-sys-color-surface: var(--card-background-color);
        --md-sys-color-on-surface: var(--text-color);
        --md-sys-color-on-surface-variant: var(--label-color);
        --md-ref-typeface-brand: var(--primary-font);
        --md-ref-typeface-plain: var(--body-font);
      }
      
      /* Padrão (KPIs, Status): Filled, Weight 700 */
      md-icon, .material-symbols-outlined {
        font-variation-settings: 'FILL' 1, 'wght' 700;
      }

      /* Ações da Tabela: Unfilled, Weight 700 */
      .actions-cell md-icon {
        font-variation-settings: 'FILL' 0, 'wght' 700;
      }

      .hidden { display: none !important; }

      body {
        font-family: var(--body-font);
        background-color: var(--background-color);
        margin: 0;
        padding: 16px;
        color: var(--text-color);
      }
      
      main {
        max-width: 1400px;
        margin: 20px auto;
      }

      /* --- Cabeçalho --- */
      .header-box {
        display: flex;
        align-items: center;
        background-color: var(--primary-color);
        color: #fff;
        padding: 20px 30px;
        border-radius: 12px;
        margin-bottom: 20px;
      }
      .header-logo { height: 65px; width: auto; margin-right: 25px; }
      .header-text h2 {
        font-family: var(--primary-font);
        font-size: 26px;
        margin: 0;
        font-weight: 700;
      }
      .header-text p {
        font-family: var(--body-font);
        font-size: 18px;
        margin: 5px 0 0;
        opacity: .9;
      }
      .header-actions { display: flex; margin-left: auto; gap: 10px; }
      
      .form-title {
        text-align: center;
        font-family: var(--primary-font);
        color: var(--primary-color);
        font-size: 22px;
        margin: 0 0 20px 0;
      }

      /* --- Barra de Filtros --- */
      .filter-bar {
        background-color: var(--filter-background-color);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }
      .filter-bar h3 {
        font-family: var(--primary-font);
        font-size: 14pt;
        color: var(--primary-color);
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        align-items: center; /* Alinha verticalmente */
      }
      md-outlined-select {
        width: 100%;
        font-family: var(--body-font);
        font-size: 12pt;
        color: var(--text-color);
      }
      md-outlined-button { /* Estilo para o botão Limpar */
        --md-outlined-button-container-shape: 20px;
      }
      
      /* --- Seção de KPIs --- */
      .kpi-grid {
        display: grid;
        /* 4 colunas */
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      md-elevated-card.kpi-card {
        padding: 20px;
        background-color: var(--card-background-color);
        border: 1px solid var(--primary-color);
        border-radius: 12px;
        text-align: center;
      }
      .kpi-title {
        font-family: var(--primary-font);
        font-size: 16pt;
        color: var(--primary-color);
        margin: 0 0 10px 0;
        /* Alinhamento com ícone */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .kpi-value {
        font-family: var(--primary-font);
        font-size: 28pt;
        color: var(--primary-color);
        font-weight: 700;
        margin: 0;
      }
      .kpi-desc {
        font-family: var(--body-font);
        font-size: 10pt;
        color: #666666;
        margin: 5px 0 0 0;
      }
      
      /* KPI URGENTE (MSG PENDENTE) */
      .kpi-card.urgent {
        border-color: var(--danger-color);
      }
      .kpi-card.urgent .kpi-title,
      .kpi-card.urgent .kpi-value {
        color: var(--danger-color);
      }
      /* Ajusta a cor do ícone urgente */
      .kpi-card.urgent .kpi-title md-icon {
        color: var(--danger-color);
      }


      /* --- Seção de Gráficos --- */
      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .chart-container {
        background-color: var(--card-background-color);
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .chart-title {
        font-family: var(--primary-font);
        font-size: 18pt;
        color: var(--primary-color);
        margin: 0 0 15px 0;
        text-align: center;
      }
      .chart-div {
        width: 100%;
        height: 400px;
      }

      /* --- Filtro Chip --- */
      .chip-filters {
        display: flex;
        gap: 8px;
        margin: 0 0 12px 10px; /* Alinha com o padding da tabela */
        justify-content: flex-start;
      }
      /* Estiliza o chip quando selecionado */
      md-filter-chip[selected] {
        --md-filter-chip-selected-container-color: var(--danger-color);
        --md-filter-chip-selected-label-color: #FFFFFF;
        --md-filter-chip-selected-icon-color: #FFFFFF;
      }


      /* --- Tabela de Dados (ATUALIZADA PARA ALINHAMENTO) --- */
      md-elevated-card.table-card {
        background-color: var(--card-background-color);
        border-radius: 12px;
        padding: 10px;
        overflow-x: auto;
      }
      #inspectionsTable {
        width: 100%;
        border-collapse: collapse;
        font-family: var(--body-font);
      }
      #inspectionsTable th, #inspectionsTable td {
        padding: 16px 20px; /* Padding aumentado */
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
        font-size: 14pt; /* Fonte aumentada */
        white-space: nowrap; 
        /* ALINHAMENTO AO TOPO */
        vertical-align: top; 
      }
      #inspectionsTable th {
        font-family: var(--primary-font);
        font-size: 13pt; /* Fonte aumentada */
        font-weight: 700;
        color: var(--primary-color);
        text-transform: uppercase;
      }
      #inspectionsTable tbody tr:hover {
        background-color: #f9f9f9;
      }
      
      /* --- ESTILOS PARA COLUNAS DA TABELA --- */
      
      /* Coluna 1: Status (Ícones) */
      .status-cell-icons {
        display: flex;
        gap: 8px; /* Gap aumentado */
        align-items: center;
      }
      .status-cell-icons md-icon {
        font-size: 28px; /* Ícone aumentado */
        width: 28px; 
        height: 28px;
      }
      
      /* Colunas 2 e 3: Células de Linha Dupla */
      .linha-principal {
          font-size: 14pt; /* Fonte aumentada */
          font-weight: 700;
          color: var(--text-color);
          line-height: 1.5; 
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 20px;
      }
      .linha-secundaria {
          font-size: 12pt; /* Fonte aumentada */
          color: var(--label-color); 
          display: block;
          margin-top: 4px; /* Margin aumentado */
          line-height: 1.5;
          /* GARANTE ALTURA MÍNIMA PARA A LINHA FANTASMA */
          min-height: 1.5em; 
      }

      /* Coluna 4: Finalidade + Ações */
      .finalidade-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Alinha texto e botões ao topo */
        gap: 20px;
      }
      .finalidade-texto {
        white-space: normal; /* Permite quebra de linha na finalidade */
        flex-grow: 1; /* Ocupa o espaço disponível */
      }
      .actions-cell {
        display: flex;
        gap: 6px; /* Gap aumentado */
        flex-shrink: 0; /* Impede que os botões encolham */
      }
      
      #inspectionsTable md-icon-button {
        --md-icon-button-icon-size: 26px; /* Ícone de ação aumentado */
        --md-icon-button-state-layer-size: 44px; /* Touch target aumentado */
      }
      
      /* --- ESTILO DE LINHA DESTACADA --- */
      #inspectionsTable tbody tr.row-highlight td {
        background-color: var(--highlight-bg);
        color: var(--highlight-text);
      }
      #inspectionsTable tbody tr.row-highlight .linha-principal {
        color: var(--highlight-text);
      }
      #inspectionsTable tbody tr.row-highlight .linha-secundaria {
        color: var(--highlight-text);
        opacity: 0.8; /* Mantém a hierarquia mesmo em vermelho */
      }
      /* Ícones de status na linha destacada ficam vermelhos... */
      #inspectionsTable tbody tr.row-highlight .status-cell-icons md-icon {
         color: var(--highlight-text) !important;
      }
      /* ...exceto o 'MSG ENVIADA', que deve permanecer verde */
      #inspectionsTable tbody tr.row-highlight .status-cell-icons md-icon[title="MSG ENVIADA"] {
         color: #146c43 !important;
      }
      
      /* Os ícones de ação mantêm as suas cores funcionais */
      #inspectionsTable tbody tr.row-highlight .actions-cell md-icon[style*="#6c757d"] {
         color: #6c757d !important;
      }
      #inspectionsTable tbody tr.row-highlight .actions-cell md-icon[style*="#FAB932"] {
         color: #FAB932 !important;
      }
      #inspectionsTable tbody tr.row-highlight .actions-cell md-icon[style*="#990000"] {
         color: #990000 !important;
      }
      /* --- FIM DO ESTILO DE LINHA DESTACADA --- */
      
      
      /* ============================================= */
      /* ATUALIZAÇÃO DOS ESTILOS DO MODAL              */
      /* ============================================= */
      md-dialog {
        --md-dialog-container-color: var(--card-background-color);
         min-width: 650px; /* Aumentado de 500px */
      }
      md-dialog [slot="headline"] {
        font-size: 1.75rem; /* Aumentado */
        font-family: var(--primary-font);
      }
      .dialog-form-body {
        display: flex;
        flex-direction: column;
        gap: 24px; /* Aumentado */
        font-size: 1.1rem; /* Fonte base aumentada */
      }
      .dialog-form-body .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      /* Observação 2: 2 colunas */
      .checkbox-grid { 
        column-count: 2; 
        column-gap: 20px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      .checkbox-item label {
        font-family: var(--body-font);
        margin-left: 6px;
        cursor: pointer;
        font-size: 1.1rem; /* Aumentado */
      }
      .checkbox-item md-outlined-text-field {
         margin-left: 8px;
      }
       .accordion-header {
        padding: 16px; /* Aumentado */
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: var(--primary-font);
        font-size: 1.2rem; /* Aumentado */
        font-weight: 700;
        text-transform: uppercase;
      }
      .accordion-header .material-symbols-outlined { transition: transform 0.2s; }
      .accordion-header.active .material-symbols-outlined { transform: rotate(180deg); }
      .accordion-panel { 
        padding: 20px; /* Aumentado */
        border: 1px solid #ccc; 
        border-top: none; 
        display: none; 
      }
      /* ============================================= */
      /* FIM DA ATUALIZAÇÃO DO MODAL                   */
      /* ============================================= */

      /* --- Loader --- */
      #loader {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 10px;
        padding: 50px;
        font-family: var(--primary-font);
        font-size: 18px;
        color: var(--primary-color);
      }
      
    </style>
</head>
<body>
    <main>
        <div class="header-box">
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
            <div class="header-text">
                <h2>HOSPITAL NAVAL DE RECIFE</h2>
                <p>DASHBOARD DE INSPEÇÕES</p>
            </div>
            <div class="header-actions">
                <md-icon-button onclick="navigateTo('form')" title="Novo Formulário">
                    <md-icon>assignment</md-icon>
                </md-icon-button>
                <md-icon-button onclick="navigateTo('parecer')" title="Gerar Parecer">
                    <md-icon>edit_note</md-icon>
                </md-icon-button>
            </div>
        </div>

        <div id="loader">
          <md-circular-progress indeterminate></md-circular-progress>
          Carregando dados...
        </div>

        <div id="dashboard-content" class="hidden">
            <md-elevated-card class="filter-bar">
                <h3><md-icon>filter_list</md-icon> FILTROS</h3>
                <div class="filter-row">
                    <md-outlined-select label="Ano" id="filter-ano">
                        </md-outlined-select>
                    <md-outlined-select label="Mês" id="filter-mes">
                        </md-outlined-select>
                    
                    <md-outlined-select label="Finalidade" id="filter-finalidade">
                        </md-outlined-select>

                    <md-outlined-select label="Status" id="filter-status">
                        </md-outlined-select>
                    
                    <md-outlined-button id="clearFilterBtn">
                        <md-icon slot="icon">delete_sweep</md-icon>
                        Limpar Filtros
                    </md-outlined-button>
                </div>
            </md-elevated-card>


            <div class="kpi-grid">
                <md-elevated-card class="kpi-card">
                    <div class="kpi-title">
                        <md-icon>summarize</md-icon>
                        <span>Total de Inspeções</span>
                    </div>
                    <div class="kpi-value" id="kpi-total">0</div>
                    <div class="kpi-desc">No período filtrado</div>
                </md-elevated-card>
                
                <md-elevated-card class="kpi-card">
                    <div class="kpi-title">
                        <md-icon>pending_actions</md-icon>
                        <span>Pendentes</span>
                    </div>
                    <div class="kpi-value" id="kpi-pendentes">0</div>
                    <div class="kpi-desc">Status "Agendada" ou "Conclusão Pendente"</div>
                </md-elevated-card>
                <md-elevated-card class="kpi-card">
                    <div class="kpi-title">
                        <md-icon>school</md-icon>
                        <span>Concursos</span>
                    </div>
                    <div class="kpi-value" id="kpi-concursos">0</div>
                    <div class="kpi-desc">Inspeções de Concurso</div>
                </md-elevated-card>
                <md-elevated-card class="kpi-card urgent">
                    <div class="kpi-title">
                        <md-icon>mark_email_unread</md-icon>
                        <span>MSG PENDENTE</span>
                    </div>
                    <div class="kpi-value" id="kpi-msg-pendente">0</div>
                    <div class="kpi-desc">Inspeções com MSG não enviada</div>
                </md-elevated-card>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <h3 class="chart-title">1. Tendência Mensal de Inspeções</h3>
                    <div id="chart-line-tendencia" class="chart-div"></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">2. Distribuição de Finalidades</h3>
                    <div id="chart-bar-finalidade" class="chart-div"></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">3. Distribuição de Status de Inspeção</h3>
                    <div id="chart-bar-status" class="chart-div"></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">4. Inspeções por OM (Top 10)</h3>
                    <div id="chart-bar-om" class="chart-div"></div>
                </div>
            </div>
            
            <h2 class="form-title">TABELA DE DADOS</h2>
            
            <div class="chip-filters">
                <md-filter-chip label="Mostrar Apenas MSG Pendente" id="chip-msg-pendente">
                    <md-icon slot="icon">mark_email_unread</md-icon>
                </md-filter-chip>
            </div>

            <md-elevated-card class="table-card">
              <table id="inspectionsTable">
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>Inspeção</th> <th>Inspecionado</th>
                    <th>Finalidade</th> </tr>
                </thead>
                <tbody id="table-body">
                  </tbody>
              </table>
              </md-elevated-card>
        </div>
    </main>

    <md-dialog id="editModal">
      <div slot="headline">Editar Conclusão da IS: <span id="modal-is-number"></span></div>
      <form id="editForm" slot="content" class="dialog-form-body">
        <input type="hidden" id="modal-is-hidden">
        
        <md-outlined-text-field label="Laudo" type="textarea" rows="4" id="modal-laudo"></md-outlined-text-field>
        
        <div class="form-row">
          <md-outlined-text-field label="Data do Laudo" type="date" id="modal-dataLaudo"></md-outlined-text-field>
          <md-outlined-text-field label="Nº TIS" id="modal-tis"></md-outlined-text-field>
        </div>
        
        <md-outlined-text-field label="CÓDIGO DS-1A" id="modal-ds1a"></md-outlined-text-field>
        
        <div id="modal-restricoes-section" class="form-group hidden">
            <button type="button" class="accordion-header">
                <span>Restrições</span>
                <span class="material-symbols-outlined">expand_more</span>
            </button>
            <div class="accordion-panel">
                <div id="modal-restricoes-grid" class="checkbox-grid">
                    </div>
            </div>
        </div>
      </form>
      <div slot="actions">
        <md-outlined-button type="button" id="cancelEditBtn">Cancelar</md-outlined-button>
        <md-filled-button type="button" id="saveEditBtn">Salvar</md-filled-button>
      </div>
    </md-dialog>

    <md-dialog id="remarcarModal">
      <div slot="headline">Remarcar Inspeção: <span id="modal-remarcar-is"></span></div>
      <form id="remarcarForm" slot="content" class="dialog-form-body">
        <input type="hidden" id="modal-remarcar-is-hidden">
        <p>Inspecionado: <strong id="modal-remarcar-nome"></strong></p>
        <md-outlined-text-field label="Nova Data da Entrevista" type="date" id="modal-novaData" required></md-outlined-text-field>
      </form>
      <div slot="actions">
        <md-outlined-button type="button" id="cancelRemarcarBtn">Cancelar</md-outlined-button>
        <md-filled-button type="button" id="saveRemarcarBtn">Remarcar</md-filled-button>
      </div>
    </md-dialog>


    <script>
      let BASE_URL = '';
      let allData = { dashboardData: [], tableData: [], restricoesOptions: [] };
      let allTableRows = []; // Para cachear as linhas da tabela
      let currentModalRowIndex = -1; 

      // --- 1. Inicialização ---
      
      google.charts.load('current', {'packages':['corechart']}); 
      google.charts.setOnLoadCallback(loadInitialData);

      function loadInitialData() {
        google.script.run.withSuccessHandler((url) => { BASE_URL = url; }).getWebAppUrl();
        google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataLoadError).getDashboardData();
      }

      function onDataLoadError(error) {
        alert(`Falha Crítica: ${error.message}`); // Revertido para alert()
        $('#loader').html(`<b>Falha Crítica:</b> Não foi possível carregar os dados. <br><small>Erro: ${error.message}</small>`);
      }

      function onDataLoaded(data) {
        allData = data;
        
        // Popula os filtros antes de mais nada
        populateFilters();
        
        // Popula o modal de restrições (só precisa fazer uma vez)
        populateRestricoes(allData.restricoesOptions);

        // Define a data padrão (ano e mês atual)
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = (today.getMonth() + 1).toString();
        $('#filter-ano').val(currentYear);
        $('#filter-mes').val(currentMonth);

        // Carrega o dashboard com os dados filtrados
        applyFilters();

        // Mostra o conteúdo e esconde o loader
        $('#loader').addClass('hidden');
        $('#dashboard-content').removeClass('hidden');

        // Bind de eventos de filtro automático (Dropdowns)
        $('#filter-ano, #filter-mes, #filter-status, #filter-finalidade').on('change', applyFilters);
        
        // Bind do novo botão Limpar
        $('#clearFilterBtn').on('click', clearFilters);

        // Bind do NOVO chip filter
        $('#chip-msg-pendente').on('change', applyFilters); 
        
        // Bind de eventos da Tabela (usando delegação)
        $('#table-body').on('click', '.edit-btn', handleEditClick);
        $('#table-body').on('click', '.remarcar-btn', handleRemarcarClick);
        $('#table-body').on('click', '.sync-btn', handleSyncClick);
        $('#table-body').on('click', '.falta-btn', handleFaltaClick); 
        
        // =============================================
        // NOVOS HANDLERS DE BOTÕES DO MODAL (Correção do Bug)
        // =============================================
        $('#saveEditBtn').on('click', handleEditSaveClick);
        $('#cancelEditBtn').on('click', () => document.getElementById('editModal').close());
        
        $('#saveRemarcarBtn').on('click', handleRemarcarSaveClick);
        $('#cancelRemarcarBtn').on('click', () => document.getElementById('remarcarModal').close());
        
        // Bind do accordion do Modal
        $(document).on('click', '#editModal .accordion-header', function() {
            $(this).toggleClass('active').next('.accordion-panel').slideToggle(200);
        });
        
        // =============================================
        // NOVO LISTENER PARA VISIBILIDADE DO ACCORDION
        // =============================================
        $(document).on('input', '#modal-laudo', updateModalVisibility);
      }

      // --- 2. Lógica de Filtros e UI ---

      function populateFilters() {
        // Extrai valores únicos dos dados da tabela
        const anos = [...new Set(allData.tableData.map(r => r.DataEntrevista.split('/')[2]))].sort((a,b) => b-a);
        const meses = [
          {v:"1", n:"Janeiro"}, {v:"2", n:"Fevereiro"}, {v:"3", n:"Março"}, {v:"4", n:"Abril"},
          {v:"5", n:"Maio"}, {v:"6", n:"Junho"}, {v:"7", n:"Julho"}, {v:"8", n:"Agosto"},
          {v:"9", n:"Setembro"}, {v:"10", n:"Outubro"}, {v:"11", n:"Novembro"}, {v:"12", n:"Dezembro"}
        ];
        // Popula dropdown de finalidade
        const finalidades = [...new Set(allData.tableData.map(r => r.Finalidade))].sort();
        
        const status = [...new Set(allData.tableData.map(r => r.StatusIS))].sort();

        populateMwcSelect('#filter-ano', anos, 'Todos os Anos', true);
        populateMwcSelect('#filter-mes', meses, 'Todos os Meses', true, true);
        populateMwcSelect('#filter-finalidade', finalidades, 'Todas as Finalidades', true); 
        populateMwcSelect('#filter-status', status, 'Todos os Status', true);
      }
      
      // Limpa os filtros
      function clearFilters() {
        // Reseta dropdowns
        $('#filter-ano').val('');
        $('#filter-mes').val('');
        $('#filter-status').val('');
        $('#filter-finalidade').val(''); 
        
        // Reseta o chip
        document.getElementById('chip-msg-pendente').selected = false;
        
        // Re-executa os filtros
        applyFilters();
      }

      // Função principal que redesenha o dashboard
      function applyFilters() {
        // Pega valores dos filtros
        const ano = $('#filter-ano').val();
        const mes = $('#filter-mes').val();
        const status = $('#filter-status').val();
        const finalidade = $('#filter-finalidade').val(); 
        
        // Pega valor do chip
        const chipMsgPendente = document.getElementById('chip-msg-pendente').selected;

        // Filtra os dados de KPI/Gráfico (dashboardData)
        // O filtro do chip NÃO afeta os gráficos, apenas a tabela.
        const filteredDashboardData = allData.dashboardData.filter(d => {
          if (!d.EventDate) return false;
          const [day, month, year] = d.EventDate.split('/');
          return (!ano || year === ano) &&
                 (!mes || month === mes) &&
                 (!finalidade || d.Finalidade === finalidade) && 
                 (!status || d.StatusIS === status);
        });

        // Filtra os dados da Tabela (tableData)
        const filteredTableData = allData.tableData.filter(r => {
          if (!r.DataEntrevista) return false;
          const [day, month, year] = r.DataEntrevista.split('/');
          return (!ano || year === ano) &&
                 (!mes || month === mes) &&
                 (!finalidade || r.Finalidade === finalidade) && 
                 // Filtro de OM removido
                 (!status || r.StatusIS === status) &&
                 // Lógica do Chip
                 (!chipMsgPendente || r.MSG !== 'ENVIADA');
        });

        updateKPIs(filteredDashboardData, filteredTableData);
        drawCharts(filteredDashboardData, filteredTableData);
        populateTable(filteredTableData);
      }

      // --- 3. Atualização de KPIs ---
      
      function updateKPIs(dashboardData, tableData) {
        // KPI "Concluídas" removido
        const pendentesStatus = ['Agendada', 'Conclusão Pendente'];

        $('#kpi-total').text(dashboardData.length);
        $('#kpi-pendentes').text(dashboardData.filter(d => pendentesStatus.includes(d.StatusIS)).length);
        $('#kpi-concursos').text(dashboardData.filter(d => d.type === 'Concurso').length);
        
        // KPI: Lógica para MSG PENDENTE (baseado na tabela FILTRADA pelos filtros principais)
        const msgPendentes = tableData.filter(r => r.MSG !== 'ENVIADA').length;
        $('#kpi-msg-pendente').text(msgPendentes);
      }

      // --- 4. Desenho dos Gráficos ---
      
      const chartOptions = (title) => ({
        titleTextStyle: { color: '#050F41', fontFamily: 'Montserrat', fontSize: 18 },
        backgroundColor: '#FFFFFF',
        fontName: 'Carlito',
        fontSize: 12,
        colors: ['#050F41', '#1A237E', '#3F51B5', '#6573C3', '#9FA8DA', '#C5CAE9', '#E8EAF6'], // Paleta Marinha expandida
        legend: { textStyle: { color: '#333333', fontSize: 10 } }
      });

      // 1. Gráfico de Linha: Tendência Mensal
      function drawTrendChart(data) {
        const monthlyCounts = {};
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        
        meses.forEach((mes, i) => {
          monthlyCounts[i] = { mes: mes, total: 0, rotina: 0, concurso: 0 };
        });

        data.forEach(d => {
          const monthIndex = parseInt(d.EventDate.split('/')[1]) - 1;
          if (monthlyCounts[monthIndex]) {
            monthlyCounts[monthIndex].total++;
            if (d.type === 'Concurso') monthlyCounts[monthIndex].concurso++;
            else monthlyCounts[monthIndex].rotina++;
          }
        });

        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Mês');
        dataTable.addColumn('number', 'Total');
        dataTable.addColumn('number', 'Rotina');
        dataTable.addColumn('number', 'Concurso');
        
        Object.values(monthlyCounts).forEach(m => {
          dataTable.addRow([m.mes, m.total, m.rotina, m.concurso]);
        });

        const options = chartOptions();
        options.legend = { position: 'bottom' };
        const chart = new google.visualization.LineChart(document.getElementById('chart-line-tendencia'));
        chart.draw(dataTable, options);
      }
      
      // Função genérica para gráficos de PIZZA
      function drawPieChart(data, groupByField, elementId, topN = 7) {
        const counts = data.reduce((acc, item) => {
          const key = item[groupByField] || 'Não Preenchido';
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});

        const sortedData = Object.entries(counts).sort(([,a], [,b]) => b - a);
        
        // Agrupa fatias pequenas em "Outros"
        const topData = sortedData.slice(0, topN - 1);
        const otherCount = sortedData.slice(topN - 1).reduce((acc, [, count]) => acc + count, 0);
        if (otherCount > 0) {
            topData.push(['Outros', otherCount]);
        }

        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', groupByField);
        dataTable.addColumn('number', 'Quantidade');
        dataTable.addRows(topData);

        const options = chartOptions();
        options.legend = { position: 'right', alignment: 'center', textStyle: { color: '#333333', fontSize: 11 } };
        options.pieHole = 0.4; // Formato Donut
        
        const chart = new google.visualization.PieChart(document.getElementById(elementId));
        chart.draw(dataTable, options);
      }

      // Chamadas dos gráficos
      function drawCharts(dashboardData, tableData) {
        drawTrendChart(dashboardData);
        drawPieChart(dashboardData, 'Finalidade', 'chart-bar-finalidade'); // Gráfico 2 (Pizza)
        drawPieChart(dashboardData, 'StatusIS', 'chart-bar-status');     // Gráfico 3 (Pizza)
        drawPieChart(tableData, 'OM', 'chart-bar-om');                   // Gráfico 4 (Pizza)
      }

      // --- 5. Tabela de Dados e Ações CRUD (ATUALIZADA) ---
      
      function getStatusIcons(row) {
          let statusIcon = '';
          let msgIcon = ''; // Começa vazio por defeito
          
          // 1. Ícone para StatusIS (Sempre aparece)
          switch (row.StatusIS) {
                case 'Agendada':
                    statusIcon = `<md-icon style="color: #6c757d;" title="Agendada">event_available</md-icon>`;
                    break;
                case 'Auditoria':
                    statusIcon = `<md-icon style="color: #FAB932;" title="Auditoria CPMM">quick_reference_all</md-icon>`;
                    break;
                case 'Cancelada':
                    statusIcon = `<md-icon style="color: #990000;" title="Cancelada">event_busy</md-icon>`;
                    break;
                case 'Conclusão Pendente':
                    statusIcon = `<md-icon style="color: #990000;" title="Conclusão Pendente">help</md-icon>`;
                    break;
                case 'Concluída': // User mapping
                    statusIcon = `<md-icon style="color: #990000;" title="Votação Pendente">gavel</md-icon>`;
                    break;
                case 'Faltou':
                    statusIcon = `<md-icon style="color: #990000;" title="Faltou">disabled_by_default</md-icon>`;
                    break;
                case 'JSD':
                    statusIcon = `<md-icon style="color: #FAB932;" title="Revisão JSD">quick_reference_all</md-icon>`;
                    break;
                case 'Remarcada':
                    statusIcon = `<md-icon style="color: #FAB932;" title="Remarcada">event_repeat</md-icon>`;
                    break;
                case 'Restituída Auditoria':
                    statusIcon = `<md-icon style="color: #FAB932;" title="Restituída Auditoria">arrow_circle_left</md-icon>`;
                    break;
                case 'Restituída JSD':
                    statusIcon = `<md-icon style="color: #FAB932;" title="Restituída JSD">arrow_circle_left</md-icon>`;
                    break;
                case 'TIS assinado':
                    statusIcon = `<md-icon style="color: #146c43;" title="TIS assinado">assignment_turned_in</md-icon>`;
                    break;
                case 'Votada JRS': // User mapping
                    statusIcon = `<md-icon style="color: #990000;" title="Assinaturas Pendentes">unknown_document</md-icon>`;
                    break;
              default:
                  statusIcon = `<md-icon style="color: #757575;" title="${row.StatusIS || 'Status Desconhecido'}">help_outline</md-icon>`;
          }

          // 2. Ícone para MSG (SÓ SE 'PENDENTE' ou 'ENVIADA')
          if (row.MSG === 'ENVIADA') {
              msgIcon = '<md-icon style="color: #146c43;" title="MSG ENVIADA">mark_email_read</md-icon>';
          } else if (row.MSG === 'PENDENTE') { 
              msgIcon = '<md-icon style="color: #990000;" title="MSG PENDENTE">unsubscribe</md-icon>';
          }

          return statusIcon + msgIcon;
      }


      function populateTable(tableData) {
        const tbody = $('#table-body');
        tbody.empty();
        allTableRows = []; // Limpa o cache
        
        if (tableData.length === 0) {
          // ATUALIZADO COLSPAN para 4
          tbody.html('<tr><td colspan="4" style="text-align:center; padding: 20px;">Nenhum registro encontrado para os filtros aplicados.</td></tr>');
          return;
        }

        tableData.forEach((row, index) => {
          allTableRows[index] = row; // Cacheia a linha
          
          // =============================================
          // LÓGICA CONDICIONAL DOS BOTÕES
          // =============================================
          
          // Regra: Ícone 'Editar' (Se MSG <> ENVIADA E StatusIS NÃO FOR 'Faltou' ou 'Cancelada')
          let editButtonHtml = '';
          if (row.MSG !== 'ENVIADA' && row.StatusIS !== 'Faltou' && row.StatusIS !== 'Cancelada') {
              editButtonHtml = `
                <md-icon-button class="edit-btn" title="Editar IS">
                  <md-icon style="color: #6c757d;">edit_square</md-icon>
                </md-icon-button>`;
          }

          // Regra: Ícone 'Remarcar' (Se Agendada ou Remarcada)
          let remarcarButtonHtml = '';
          if (row.StatusIS === 'Agendada' || row.StatusIS === 'Remarcada') {
              remarcarButtonHtml = `
                <md-icon-button class="remarcar-btn" title="Remarcar IS">
                  <md-icon style="color: #FAB932;">update</md-icon>
                </md-icon-button>`;
          }
        
          // Regra: Ícone 'Sync' (SÓ SE MSG = 'PENDENTE')
          let syncButtonHtml = '';
          if (row.MSG === 'PENDENTE') {
                syncButtonHtml = `
                  <md-icon-button class="sync-btn" title="Registrar MSG enviada">
                    <md-icon style="color: #990000;">send</md-icon>
                  </md-icon-button>`;
          }

          // Regra: Ícone 'Falta' (Se Agendada ou Remarcada)
          let faltaButtonHtml = '';
          if (row.StatusIS === 'Agendada' || row.StatusIS === 'Remarcada') {
              faltaButtonHtml = `
                <md-icon-button class="falta-btn" title="Registrar Falta">
                  <md-icon style="color: #990000;">person_off</md-icon>
                </md-icon-button>`;
          }

          // =============================================
          // LÓGICA DE DESTAQUE DA LINHA
          // =============================================
          const statusParaDestacar = ['Conclusão Pendente', 'Concluída', 'Votada JRS', 'Restituída Auditoria', 'Restituída JSD'];
          let highlightClass = '';
          if (statusParaDestacar.includes(row.StatusIS) || row.MSG === 'PENDENTE') {
              highlightClass = 'row-highlight';
          }

          // =============================================
          //           ATUALIZAÇÃO DA LINHA AQUI
          // =============================================
          const tr = `
            <tr data-index="${index}" data-is="${row.IS}" class="${highlightClass}">
              
              <td>
                  <div class="linha-principal status-cell-icons">
                      ${getStatusIcons(row)}
                  </div>
                  <span class="linha-secundaria">&nbsp;</span> </td>
              
              <td>
                  <span class="linha-principal">${row.DataEntrevista}</span>
                  <span class="linha-secundaria">IS: ${row.IS || 'N/A'}</span>
              </td>
              
              <td>
                  <span class="linha-principal">${row['P/G/Q'] || ''} ${row.Inspecionado}</span>
                  <span class="linha-secundaria">${row.OM} | ${row.NIP}</span>
              </td>

              <td>
                <div class="linha-principal finalidade-wrapper">
                  <span class="finalidade-texto">${row.Finalidade}</span>
                  <div class="actions-cell">
                    ${editButtonHtml}
                    ${remarcarButtonHtml}
                    ${faltaButtonHtml}
                    ${syncButtonHtml} 
                  </div>
                </div>
                <span class="linha-secundaria">&nbsp;</span> </td>
            </tr>
          `;
          // =============================================
          //              FIM DA ATUALIZAÇÃO
          // =============================================
          tbody.append(tr);
        });
      }
      
      // --- Handlers de Ações da Tabela (ATUALIZADOS) ---

      function handleEditClick(e) {
        currentModalRowIndex = $(e.currentTarget).closest('tr').data('index'); // GUARDA O ÍNDICE
        const rowData = allTableRows[currentModalRowIndex];
        
        $('#modal-is-number').text(rowData.IS);
        $('#modal-is-hidden').val(rowData.IS);
        $('#modal-laudo').val(rowData.Laudo);
        $('#modal-dataLaudo').val(rowData.DataLaudo ? convertDateToInput(rowData.DataLaudo) : '');
        $('#modal-tis').val(rowData.TIS);
        $('#modal-ds1a').val(rowData['DS-1a']);
        
        // Seta as restrições
        const restricoes = rowData.Restrições ? rowData.Restrições.split(', ') : [];
        $('md-checkbox[name="modal-restricoes"]').prop('checked', false); // Limpa
        $('md-checkbox[name="modal-restricoes"]').prop('disabled', false);
        $('#modal-restricao-outros-text').val('').parent().addClass('hidden');

        restricoes.forEach(r => {
          const checkbox = $(`md-checkbox[name="modal-restricoes"][value="${r}"]`);
          if (checkbox.length > 0) {
            checkbox.prop('checked', true);
          } else if (r.startsWith('Outros:')) {
            $('#modal-restricao-outros').prop('checked', true);
            $('#modal-restricao-outros-text').val(r.substring(7)).parent().removeClass('hidden');
          }
        });
        
        // =============================================
        // NOVA LÓGICA DE VISIBILIDADE DO MODAL (REINTRODUZIDA)
        // =============================================
        updateModalVisibility(); 
        document.getElementById('editModal').show();
      }
      
      // =============================================
      // NOVA FUNÇÃO DE VISIBILIDADE DO MODAL (SÓ PARA RESTRIÇÕES)
      // =============================================
      function updateModalVisibility() {
        if (currentModalRowIndex === -1) return; 

        const rowData = allTableRows[currentModalRowIndex];
        const finalidade = rowData.Finalidade;
        const laudo = $('#modal-laudo').val() || '';

        // Regra: 'RESTRIÇÕES'
        const finalidadesRestricao = ['VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL', 'TÉRMINO DE INCAPACIDADE', 'TÉRMINO DE RESTRIÇÕES'];
        const laudoContemRestricoes = laudo.toLowerCase().includes('restrições');
        const showRestricoes = finalidadesRestricao.includes(finalidade) && laudoContemRestricoes;
        $('#modal-restricoes-section').toggleClass('hidden', !showRestricoes);
        
        // Limpa campos se a regra principal for falsa
        if (!showRestricoes) {
            $('md-checkbox[name="modal-restricoes"]').prop('checked', false);
            $('#modal-restricao-outros-text').val('').parent().addClass('hidden');
            if ($('#modal-restricoes-section .accordion-header').hasClass('active')) {
                $('#modal-restricoes-section .accordion-header').trigger('click');
            }
        }
      }

      // =============================================
      // NOVOS HANDLERS DE CLICK (Correção do Bug)
      // =============================================

      function handleEditSaveClick() {
        const btn = $('#saveEditBtn');
        btn.prop('disabled', true).html('Salvando...'); // Mostra loading no botão
        
        // Recolhe os dados do formulário
        const formData = {
          isNumber: $('#modal-is-hidden').val(),
          laudo: $('#modal-laudo').val(),
          dataLaudo: $('#modal-dataLaudo').val(),
          tis: $('#modal-tis').val(),
          ds1a: $('#modal-ds1a').val(),
          restricoes: $('md-checkbox[name="modal-restricoes"]:checked').map(function() { return this.value; }).get(),
          outrosRestricao: $('#modal-restricao-outros-text').val()
        };

        // Envia para o backend (sem validação de campos obrigatórios)
        google.script.run.withSuccessHandler(onUpdateSuccess).withFailureHandler(onUpdateFailure).updateInspectionConclusion(formData);
      }

      function handleRemarcarSaveClick() {
        const btn = $('#saveRemarcarBtn');
        // Validação simples (apenas para data)
        if (!$('#modal-novaData').val()) {
            alert('Por favor, selecione uma nova data.'); // Revertido para alert()
            return;
        }
        
        btn.prop('disabled', true).html('Remarcando...'); // Mostra loading no botão

        const formData = {
          isNumber: $('#modal-remarcar-is-hidden').val(),
          novaData: $('#modal-novaData').val()
        };
        
        google.script.run.withSuccessHandler(onUpdateSuccess).withFailureHandler(onUpdateFailure).remarcarInspecao(formData);
      }
      
      
      function handleRemarcarClick(e) {
        currentModalRowIndex = $(e.currentTarget).closest('tr').data('index'); // Guarda o índice
        const rowData = allTableRows[currentModalRowIndex];

        $('#modal-remarcar-is').text(rowData.IS);
        $('#modal-remarcar-is-hidden').val(rowData.IS);
        $('#modal-remarcar-nome').text(rowData.Inspecionado);
        $('#modal-novaData').val('');
        
        document.getElementById('remarcarModal').show();
      }
      
      function handleSyncClick(e) {
        const button = $(e.currentTarget);
        const isNumber = button.closest('tr').data('is');
        if (!isNumber || button.prop('disabled')) return;

        // Simples confirmação do navegador
        if (confirm(`Deseja marcar a mensagem da IS ${isNumber} como ENVIADA?`)) {
          button.prop('disabled', true).find('md-icon').html('hourglass_top');
          google.script.run.withSuccessHandler(function(response) {
            if (response.success) {
              onUpdateSuccess({ 
                message: response.message, 
              });
            } else {
              onUpdateFailure(response);
              button.prop('disabled', false).find('md-icon').html('send'); // Restaura o ícone correto em caso de falha
            }
          }).withFailureHandler(onUpdateFailure).updateMsgStatus(String(isNumber));
        }
      }

      function handleFaltaClick(e) {
        const button = $(e.currentTarget);
        const isNumber = button.closest('tr').data('is');
        if (!isNumber || button.prop('disabled')) return;

        // Simples confirmação do navegador
        if (confirm(`Deseja registrar FALTA para a IS ${isNumber}?`)) {
          button.prop('disabled', true).find('md-icon').html('hourglass_top');
          google.script.run.withSuccessHandler(function(response) {
            if (response.success) {
              onUpdateSuccess({ 
                message: response.message, 
              });
            } else {
              onUpdateFailure(response);
              button.prop('disabled', false).find('md-icon').html('person_off'); // Restaura o ícone correto em caso de falha
            }
          }).withFailureHandler(onUpdateFailure).registrarFalta(String(isNumber));
        }
      }

      // --- Callbacks de Sucesso/Falha de Update ---

      function onUpdateSuccess(response) {
        // Fechamos os modais e reativamos os botões
        $('#saveEditBtn').prop('disabled', false).html('Salvar');
        $('#saveRemarcarBtn').prop('disabled', false).html('Remarcar');
        
        if (document.getElementById('editModal').open) document.getElementById('editModal').close();
        if (document.getElementById('remarcarModal').open) document.getElementById('remarcarModal').close();
        
        currentModalRowIndex = -1; // Limpa o índice do modal

        // =============================================
        // REVERTIDO PARA ALERT()
        // =============================================
        alert(response.message || 'Atualizado com sucesso!');
        
        // Recarrega os dados para refletir as mudanças
        $('#loader').removeClass('hidden');
        $('#dashboard-content').addClass('hidden');
        google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataLoadError).getDashboardData();
      }

      function onUpdateFailure(error) {
        // Reativa botões em caso de falha
        $('#saveEditBtn').prop('disabled', false).html('Salvar');
        $('#saveRemarcarBtn').prop('disabled', false).html('Remarcar');
        
        // =============================================
        // REVERTIDO PARA ALERT()
        // =============================================
        alert(`Falha na atualização: ${error.message}`);
      }

      // --- 6. Utilitários ---
      
      // Popula o modal de restrições (chamado uma vez no OnDataLoaded)
      function populateRestricoes(options) {
        const grid = $('#modal-restricoes-grid');
        grid.empty();
        grid.append(createCheckboxItem('LTS', 'modal-restricoes', 'LTS'));
        if(options) {
          options.forEach(opt => {
            if(opt !== 'LTS') grid.append(createCheckboxItem(opt, 'modal-restricoes', opt));
          });
        }
        const outrosHtml = `
          <div class="checkbox-item">
            <md-checkbox id="modal-restricao-outros" name="modal-restricoes" value="Outros"></md-checkbox>
            <label for="modal-restricao-outros">Outros:</label>
            <md-outlined-text-field id="modal-restricao-outros-text" class="hidden" placeholder="Descreva..."></md-outlined-text-field>
          </div>`;
        grid.append(outrosHtml);
        
        $('md-checkbox[name="modal-restricoes"]').on('change', function(e) {
            const checkbox = $(e.target)[0];
            const isChecked = checkbox.checked;
            const value = checkbox.value;
            
            if (value === 'LTS' && isChecked) {
                $('md-checkbox[name="modal-restricoes"]').not(checkbox).prop('checked', false).prop('disabled', true);
                $('#modal-restricao-outros-text').addClass('hidden').val('');
            } else if (value === 'LTS' && !isChecked) {
                $('md-checkbox[name="modal-restricoes"]').prop('disabled', false);
            } else if (value !== 'LTS' && isChecked) {
                $('md-checkbox[name="modal-restricoes"][value="LTS"]').prop('disabled', true);
            } else if (value !== 'LTS' && !isChecked) {
                if ($('md-checkbox[name="modal-restricoes"]:checked').not('[value="LTS"]').length === 0) {
                    $('md-checkbox[name="modal-restricoes"][value="LTS"]').prop('disabled', false);
                }
            }
            if (value === 'Outros') {
                $('#modal-restricao-outros-text').parent().toggleClass('hidden', !isChecked);
                if (!isChecked) $('#modal-restricao-outros-text').val('');
            }
        });
      }
      
      // Criador de checkbox (reutilizado)
      function createCheckboxItem(value, name, label) {
        const id = `modal-restricao-${value.replace(/[^a-zA-Z0-9]/g, "")}`;
        return `
          <div class="checkbox-item">
            <md-checkbox id="${id}" name="${name}" value="${value}"></md-checkbox>
            <label for="${id}">${label}</label>
          </div>`;
      }

      // Popula MWC Select (reutilizado)
      function populateMwcSelect(selector, options, placeholder, addAllOption = false, isObj = false) {
        const select = $(selector);
        select.empty();
        if (addAllOption) {
          select.append($('<md-select-option>', { value: "" }).append($('<div>', { slot: 'headline', text: placeholder })));
        }
        if (options && options.length > 0) {
          options.forEach(opt => {
            const value = isObj ? opt.v : opt;
            const text = isObj ? opt.n : opt;
            select.append($('<md-select-option>', { value: value }).append($('<div>', { slot: 'headline', text: text })));
          });
        }
      }
      
      function convertDateToInput(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('/');
        if (parts.length !== 3) return '';
        const [day, month, year] = parts;
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      }

      function navigateTo(page) {
        if (BASE_URL) {
          let targetPage = (page === 'form') ? '' : `?page=${page}`;
          window.top.location.href = BASE_URL + targetPage;
        }
      }

    </script>
</body>
</html>
