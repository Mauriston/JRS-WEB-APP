<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script type="module" src="https://esm.run/@material/web/all.js"></script>

    <style>
      /* --- Configuração de Cores e Fontes M3 --- */
      :root {
        --primary-color: #050F41;
        --background-color: #F5F5F5;
        --card-background-color: #FFFFFF;
        --text-color: #333333;
        --label-color: #555555;
        --primary-font: 'Montserrat', sans-serif;
        --body-font: 'Carlito', sans-serif;

        /* Override MWC Theme */
        --md-sys-color-primary: var(--primary-color);
        --md-sys-color-background: var(--background-color);
        --md-sys-color-surface: var(--card-background-color);
        --md-sys-color-on-surface: var(--text-color);
        --md-sys-color-on-surface-variant: var(--label-color);
        --md-ref-typeface-brand: var(--primary-font);
        --md-ref-typeface-plain: var(--body-font);
      }

      .hidden { display: none !important; }

      body {
        font-family: var(--body-font);
        background-color: var(--background-color);
        margin: 0;
        padding: 16px;
        color: var(--text-color);
      }

      /* --- Cabeçalho --- */
      .header-box {
        display: flex;
        align-items: center;
        background-color: var(--primary-color);
        color: #fff;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
      }
      .header-logo { height: 65px; width: auto; margin-right: 25px; }
      .header-text h2 {
        font-family: var(--primary-font);
        font-size: 26px;
        margin: 0;
        font-weight: 700;
      }
      .header-text p {
        font-family: var(--body-font);
        font-size: 18px;
        margin: 5px 0 0;
        opacity: .9;
      }
      .header-actions { display: flex; margin-left: auto; gap: 10px; }
      .header-actions md-icon-button {
        --md-sys-color-on-primary: #FFFFFF;
        --md-icon-button-icon-color: #FFFFFF;
        --md-icon-button-hover-icon-color: #FFFFFF;
        --md-icon-button-focus-icon-color: #FFFFFF;
        --md-icon-button-pressed-icon-color: #FFFFFF;
        --md-icon-button-hover-state-layer-color: #FFFFFF;
        --md-icon-button-focus-state-layer-color: #FFFFFF;
        --md-icon-button-pressed-state-layer-color: #FFFFFF;
        --md-icon-button-hover-state-layer-opacity: 0.1;
        --md-icon-button-focus-state-layer-opacity: 0.1;
        --md-icon-button-pressed-state-layer-opacity: 0.1;
      }

      /* --- Card Principal --- */
      main {
        max-width: 900px;
        margin: 20px auto;
      }
      
      md-elevated-card {
        background-color: var(--card-background-color);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,.1);
      }

      .form-title {
        text-align: center;
        font-family: var(--primary-font);
        color: var(--primary-color);
        font-size: 22px;
        margin: 25px 0 15px;
      }

      /* --- Formulário --- */
      form {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 30px;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      /* Rótulo customizado para Select2 */
      .form-group label {
        font-family: var(--primary-font);
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 4px;
        color: var(--label-color);
        text-transform: uppercase;
      }
      
      /* Ajusta todos os componentes MWC para largura total */
      md-outlined-text-field, 
      md-outlined-select {
        width: 100%;
      }

      .section-header {
        font-family: var(--primary-font);
        font-size: 18px;
        color: var(--primary-color);
        margin: 0;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--primary-color);
      }
      
      .divider { border: none; border-top: 1px solid #e0e0e0; margin: 0; }

      /* --- Seção Restrições (Checkboxes M3) --- */
      .accordion-header {
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: var(--primary-font);
        font-size: 15px;
        font-weight: 700;
        text-transform: uppercase;
      }
      .accordion-header .material-symbols-outlined { transition: transform 0.2s; }
      .accordion-header.active .material-symbols-outlined { transform: rotate(180deg); }
      .accordion-panel { padding: 15px; border: 1px solid #ccc; border-top: none; display: none; }
      
      .checkbox-grid {
        column-count: 3;
        column-gap: 15px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        break-inside: avoid-column;
      }
      .checkbox-item label {
        font-family: var(--body-font);
        font-size: 16px;
        font-weight: normal;
        text-transform: none;
        margin-left: 4px;
        cursor: pointer;
      }
      .checkbox-item md-outlined-text-field {
        margin-left: 8px;
        --md-outlined-text-field-container-shape: 4px;
      }

      /* --- Ações e Status --- */
      .form-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .form-actions md-filled-button {
        --md-filled-button-container-shape: 20px;
        --md-filled-button-label-text-font: var(--primary-font);
        font-size: 16px;
        font-weight: 700;
      }

      #status {
        margin: 0 30px 20px 30px;
        padding: 12px;
        border-radius: 8px;
        font-size: 1em;
        text-align: center;
      }
      .processing {
        --md-sys-color-surface-variant: #e6e8f0;
        --md-sys-color-on-surface-variant: #555;
        background-color: var(--md-sys-color-surface-variant);
        color: var(--md-sys-color-on-surface-variant);
        border: 1px solid #c9d0e8;
      }
      .success {
        --md-sys-color-tertiary-container: #e6f7e9;
        --md-sys-color-on-tertiary-container: #2e6035;
        background-color: var(--md-sys-color-tertiary-container);
        color: var(--md-sys-color-on-tertiary-container);
        border: 1px solid #5cb85c;
      }
      .error {
        --md-sys-color-error-container: #f7e6e6;
        --md-sys-color-on-error-container: #a94442;
        background-color: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
        border: 1px solid #d9534f;
        font-weight: bold;
      }

      /* --- Select2 Overrides --- */
      .select2-container .select2-selection--single {
        height: 56px !important;
        border: 1px solid var(--label-color) !important;
        border-radius: 4px !important;
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 54px !important;
        padding-left: 16px !important;
        font-family: var(--body-font);
        font-size: 16px;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 54px !important;
        top: 1px !important;
        right: 8px !important;
      }
      .select2-container--open .select2-dropdown--below {
        border-color: var(--primary-color) !important;
      }
    </style>
</head>
<body>
    <main>
        <md-elevated-card>
            <div class="header-box">
                <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
                <div class="header-text">
                    <h2>HOSPITAL NAVAL DE RECIFE</h2>
                    <p>JUNTA REGULAR DE SAÚDE</p>
                </div>
                <div class="header-actions">
                    <md-icon-button onclick="navigateTo('dashboard')" title="Dashboard">
                        <md-icon>dashboard</md-icon>
                    </md-icon-button>
                    <md-icon-button onclick="navigateTo('parecer')" title="Gerar Parecer">
                        <md-icon>edit_note</md-icon>
                    </md-icon-button>
                </div>
            </div>
            
            <h2 class="form-title">ADICIONAR NOVA INSPEÇÃO</h2>
            <div id="status" class="hidden"></div>
            
            <form id="inspectionForm">
                <h3 class="section-header">INSPECIONADO</h3>
                <div class="form-row">
                    <md-outlined-select label="OM" id="om" name="om" required>
                        </md-outlined-select>
                    
                    <div class="form-group" style="flex: 2;">
                        <label for="inspecionado">Inspecionado</label>
                        <div id="inspecionadoContainer">
                            <input type="text" id="inspecionado" name="inspecionado" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <md-outlined-text-field label="NIP" id="nip" name="nip"></md-outlined-text-field>
                    
                    <div class="form-group">
                        <label for="pg">Posto/Graduação</label>
                        <div id="pgContainer">
                            <select id="pg" name="pg" required></select>
                        </div>
                    </div>
                </div>
                
                <hr class="divider">
                <h3 class="section-header">IS</h3>
                
                <div class="form-row">
                    <md-outlined-text-field label="Nº IS" id="is" name="is"></md-outlined-text-field>
                    <md-outlined-text-field label="Data da Entrevista" type="date" id="dataEntrevista" name="dataEntrevista" required></md-outlined-text-field>
                </div>
                
                <div class="form-row">
                    <md-outlined-select label="Finalidade" id="finalidade" name="finalidade" required style="flex: 2;">
                        </md-outlined-select>
                    <md-outlined-select label="Status" id="statusIS" name="statusIS" required>
                        </md-outlined-select>
                </div>
                
                <hr class="divider">
                
                <div id="secao-conclusao" class="hidden">
                    <h3 class="section-header">CONCLUSÃO</h3>
                    
                    <md-outlined-text-field label="Laudo" type="textarea" rows="4" id="laudo" name="laudo"></md-outlined-text-field>
                    
                    <div id="restricoes-section" class="form-group hidden">
                        <button type="button" class="accordion-header">
                            <span>Restrições</span>
                            <span class="material-symbols-outlined">expand_more</span>
                        </button>
                        <div class="accordion-panel">
                            <div id="restricoes-grid" class="checkbox-grid">
                                </div>
                        </div>
                    </div>

                    <md-outlined-text-field label="Data do Laudo" type="date" id="dataLaudo" name="dataLaudo" class="hidden"></md-outlined-text-field>
                    
                    <div class="form-row">
                        <md-outlined-text-field label="Nº TIS" id="tis" name="tis" class="hidden"></md-outlined-text-field>
                        <md-outlined-text-field label="CÓDIGO DS-1A" id="ds1a" name="ds1a" class="hidden"></md-outlined-text-field>
                    </div>
                </div>
                
                <div class="form-actions">
                    <md-filled-button type="submit" id="submitBtn">
                        <md-icon slot="icon">add_circle</md-icon>
                        Adicionar Inspeção
                    </md-filled-button>
                </div>
            </form>
        </md-elevated-card>
    </main>

    <script>
      let hnreMilitaryData = [];
      let originalPgOptions = [];
      let BASE_URL = '';

      /* --- Inicialização --- */
      $(document).ready(function() {
        document.getElementById('dataEntrevista').valueAsDate = new Date();
        setStatus('processing', 'Carregando opções do formulário...');
        
        google.script.run.withSuccessHandler(onInitialLoadSuccess).withFailureHandler(onInitialLoadFailure).getDropdownData();
        google.script.run.withSuccessHandler((url) => { BASE_URL = url; }).getWebAppUrl();

        // Bind de eventos
        $('#nip').on('input', maskNip);
        $('#inspectionForm').on('submit', handleFormSubmit);
        $('#om').on('change', handleOmChange);
        $('#finalidade').on('change', checkRestricoesVisibility);
        $('#statusIS').on('change', handleStatusChange);
        $('#laudo').on('input', handleLaudoInput); // Usar 'input' para MWC
        $('.accordion-header').on('click', function() {
            $(this).toggleClass('active').next('.accordion-panel').slideToggle(200);
        });
      });

      function onInitialLoadFailure(error) {
        setStatus('error', `<b>Falha Crítica:</b> Não foi possível carregar os dados dos menus. <br><small>Erro: ${error.message}</small>`);
        $('#inspectionForm').find('md-outlined-text-field, md-outlined-select, md-filled-button, select').prop('disabled', true);
      }

      function onInitialLoadSuccess(data) {
        setStatus('clear');
        originalPgOptions = data.pgOptions;
        
        // Filtra status desnecessários no formulário
        const statusesToRemove = ['Auditoria', 'Cancelada', 'Faltou', 'JSD', 'Remarcada', 'Restituída JSD', 'Restituída Auditoria'];
        const filteredStatusOptions = data.statusOptions.filter(opt => !statusesToRemove.includes(opt));
        
        populateMwcSelect('#om', data.omOptions, 'Selecione a OM...');
        populateMwcSelect('#finalidade', data.finalidadeOptions, 'Selecione a finalidade...');
        populateMwcSelect('#statusIS', filteredStatusOptions, 'Selecione o status...');
        
        // Popula o select manual de P/G (usado no modo "Outras OMs")
        populateSimpleSelect('#pg', originalPgOptions, 'Selecione o P/G...');
        
        populateRestricoes(data.restricoesOptions);
        
        // Define padrões
        $('#om').val('HNRe').trigger('change');
        $('#statusIS').val('Agendada');
      }

      /* --- Populadores de Formulário --- */

      // Nova função para popular <md-outlined-select>
      function populateMwcSelect(selector, options, placeholder) {
        const select = $(selector);
        select.empty();
        if (placeholder) {
          select.append($('<md-select-option>', { value: "" }).append($('<div>', { slot: 'headline', text: placeholder })));
        }
        if (options && options.length > 0) {
          options.sort().forEach(opt => {
            select.append($('<md-select-option>', { value: opt }).append($('<div>', { slot: 'headline', text: opt })));
          });
        }
      }
      
      // Função mantida para o <select> manual de P/G
      function populateSimpleSelect(selector, options, placeholder) {
        const select = $(selector);
        select.empty();
        select.append(`<option value="" disabled selected>${placeholder}</option>`);
        if (options && options.length > 0) options.sort().forEach(opt => select.append(new Option(opt, opt)));
      }

      // Atualizado para usar <md-checkbox>
      function populateRestricoes(options) {
        const grid = $('#restricoes-grid');
        grid.empty();
        grid.append(createCheckboxItem('LTS', 'restricoes', 'LTS'));
        if(options) {
          options.forEach(opt => {
            if(opt !== 'LTS') grid.append(createCheckboxItem(opt, 'restricoes', opt));
          });
        }
        // Checkbox "Outros" com campo de texto MWC
        const outrosHtml = `
          <div class="checkbox-item">
            <md-checkbox id="restricao-outros" name="restricoes" value="Outros"></md-checkbox>
            <label for="restricao-outros">Outros:</label>
            <md-outlined-text-field id="restricao-outros-text" class="hidden" placeholder="Descreva..."></md-outlined-text-field>
          </div>`;
        grid.append(outrosHtml);
        
        // Adiciona listener para os novos md-checkbox
        $('md-checkbox[name="restricoes"]').on('change', handleRestricaoChange);
      }
      
      // Atualizado para <md-checkbox>
      function createCheckboxItem(value, name, label) {
        const id = `restricao-${value.replace(/[^a-zA-Z0-9]/g, "")}`;
        return `
          <div class="checkbox-item">
            <md-checkbox id="${id}" name="${name}" value="${value}"></md-checkbox>
            <label for="${id}">${label}</label>
          </div>`;
      }

      /* --- Lógica de UI Dinâmica --- */

      function handleOmChange() {
        if ($(this).val() === 'HNRe') {
          setupHnreMode();
        } else {
          setupManualMode();
        }
        checkRestricoesVisibility();
      }

      // Atualizado para MWC
      function handleStatusChange() {
        const status = $(this).val();
        const conclusaoStatuses = ['Concluída', 'TIS assinado', 'Votada JRS'];
        const showConclusao = conclusaoStatuses.includes(status);
        
        $('#secao-conclusao').toggleClass('hidden', !showConclusao);
        
        const showTis = ['TIS assinado', 'Votada JRS'].includes(status);
        const showDs1a = status === 'TIS assinado';
        
        $('#tis').parent('md-outlined-text-field').toggleClass('hidden', !showTis);
        $('#ds1a').parent('md-outlined-text-field').toggleClass('hidden', !showDs1a);
        
        if (!showConclusao) {
            $('#secao-conclusao').find('md-outlined-text-field, md-outlined-select').val('');
            handleLaudoInput();
        }
        
        $('#laudo, #tis, #ds1a').prop('required', false);
        switch(status) {
            case 'Concluída': $('#laudo').prop('required', true); break;
            case 'Votada JRS': $('#laudo, #tis').prop('required', true); break;
            case 'TIS assinado': $('#laudo, #tis, #ds1a').prop('required', true); break;
        }
      }

      // Atualizado para MWC
      function handleLaudoInput() {
        const laudoText = ($('#laudo').val() || '').trim();
        const showDataLaudo = laudoText !== '';
        const dataLaudoInput = $('#dataLaudo');
        
        dataLaudoInput.parent('md-outlined-text-field').toggleClass('hidden', !showDataLaudo);
        
        if(showDataLaudo && !dataLaudoInput.val()) {
          document.getElementById('dataLaudo').valueAsDate = new Date();
        }
        if(!showDataLaudo) {
          dataLaudoInput.val('');
        }
        checkRestricoesVisibility();
      }

      function checkRestricoesVisibility() {
        const laudoPreenchido = ($('#laudo').val() || '').trim() !== '';
        const omEhHNRe = $('#om').val() === 'HNRe';
        const finalidadesValidas = ['TÉRMINO DE RESTRIÇÕES', 'TÉRMINO DE INCAPACIDADE', 'VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL'];
        const finalidadeEhValida = finalidadesValidas.includes($('#finalidade').val());

        if (laudoPreenchido && omEhHNRe && finalidadeEhValida) {
            $('#restricoes-section').removeClass('hidden');
        } else {
            $('#restricoes-section').addClass('hidden');
            if ($('.accordion-header').hasClass('active')) {
                $('.accordion-header').trigger('click');
            }
            $('md-checkbox[name="restricoes"]').prop('checked', false).trigger('change');
        }
      }
      
      // Atualizado para <md-checkbox>
      function handleRestricaoChange(e) {
          const checkbox = $(e.target)[0]; // Pega o elemento DOM
          const isChecked = checkbox.checked;
          const value = checkbox.value;

          if (value === 'LTS' && isChecked) {
              $('md-checkbox[name="restricoes"]').not(checkbox).prop('checked', false).prop('disabled', true);
              $('#restricao-outros-text').addClass('hidden').val('');
          } else if (value === 'LTS' && !isChecked) {
              $('md-checkbox[name="restricoes"]').prop('disabled', false);
          } else if (value !== 'LTS' && isChecked) {
              $('md-checkbox[name="restricoes"][value="LTS"]').prop('disabled', true);
          } else if (value !== 'LTS' && !isChecked) {
              if ($('md-checkbox[name="restricoes"]:checked').not('[value="LTS"]').length === 0) {
                  $('md-checkbox[name="restricoes"][value="LTS"]').prop('disabled', false);
              }
          }

          if (value === 'Outros') {
              $('#restricao-outros-text').parent('md-outlined-text-field').toggleClass('hidden', !isChecked);
              if (!isChecked) $('#restricao-outros-text').val('');
          }
      }

      /* --- Lógica de Modos HNRe vs Manual --- */

      function setupHnreMode() {
        $('#inspecionadoContainer').html('<span>Carregando...</span>');
        // Substitui o select MWC por um input readonly
        $('#pgContainer').html('<md-outlined-text-field label="Posto/Graduação" id="pg" name="pg" required readonly></md-outlined-text-field>');
        $('#nip').val('').prop('readonly', true);
        
        google.script.run.withSuccessHandler(function(data) {
          hnreMilitaryData = data;
          const selectHtml = '<select id="inspecionado" name="inspecionado" required style="width:100%;"></select>';
          $('#inspecionadoContainer').html(selectHtml);
          const inspSelect = $('#inspecionado');
          inspSelect.append(new Option('', '', true, true));
          data.forEach(m => inspSelect.append(new Option(m.inspecionado, m.inspecionado)));
          
          inspSelect.select2({ placeholder: 'Digite para buscar...', allowClear: true });
          
          inspSelect.on('change', function() {
            const selectedName = $(this).val();
            const military = hnreMilitaryData.find(m => m.inspecionado === selectedName);
            if (military) {
              $('#pg').val(military.pg);
              $('#nip').val(military.nip);
            } else {
              $('#pg, #nip').val('');
            }
          });
        }).withFailureHandler(onInitialLoadFailure)
        .getHnreMilitaryDataForForm(); // Função correta do Code.gs
      }

      function setupManualMode() {
        // Remove select2 e restaura input manual
        if ($('#inspecionado').data('select2')) $('#inspecionado').select2('destroy');
        $('#inspecionadoContainer').html('<md-outlined-text-field label="Inspecionado" id="inspecionado" name="inspecionado" required></md-outlined-text-field>');
        
        // Restaura select manual de P/G
        $('#pgContainer').html('<select id="pg" name="pg" required></select>');
        populateSimpleSelect('#pg', originalPgOptions, 'Selecione o P/G...');
        
        $('#nip').val('').prop('readonly', false);
      }

      /* --- Submissão do Formulário --- */

      function handleFormSubmit(e) {
        e.preventDefault();
        const btn = $('#submitBtn');
        btn.prop('disabled', true).html('<md-icon slot="icon">hourglass_top</md-icon> Salvando...');
        setStatus('processing', 'Salvando...');
        
        const formData = {
          om: $('#om').val(),
          inspecionado: ($('#inspecionado').val() || '').toUpperCase(),
          pg: $('#pg').val(),
          nip: $('#nip').val(),
          is: $('#is').val(),
          finalidade: $('#finalidade').val(),
          dataEntrevista: $('#dataEntrevista').val(),
          statusIS: $('#statusIS').val(),
          tis: $('#tis').val(),
          ds1a: $('#ds1a').val(),
          laudo: $('#laudo').val(),
          dataLaudo: $('#dataLaudo').val(),
          restricoes: $('md-checkbox[name="restricoes"]:checked').map(function() { return this.value; }).get(), // Atualizado para md-checkbox
          outrosRestricao: $('#restricao-outros-text').val()
        };
        
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).addNewInspection(formData);
      }

      function onSuccess(response) {
        if (response.status === 'success') {
          setStatus('success', `<strong>Sucesso!</strong> ${response.message}`);
          $('#submitBtn').prop('disabled', false).html('<md-icon slot="icon">add_circle</md-icon> Adicionar Outra');
          
          // Reset do formulário (método MWC)
          $('#inspectionForm').find('md-outlined-text-field, md-outlined-select').val('');
          $('md-checkbox').prop('checked', false);
          $('#restricao-outros-text').parent('md-outlined-text-field').addClass('hidden');
          if ($('#inspecionado').data('select2')) {
            $('#inspecionado').val(null).trigger('change');
          }

          // Redefine valores padrão
          document.getElementById('dataEntrevista').valueAsDate = new Date();
          $('#statusIS').val('Agendada');
          $('#om').val('HNRe').trigger('change');
          handleStatusChange();
        } else {
          onFailure({ message: response.message });
        }
      }

      function onFailure(error) {
        setStatus('error', `ERRO: ${error.message}`);
        $('#submitBtn').prop('disabled', false).html('<md-icon slot="icon">error</md-icon> Tentar Novamente');
      }

      /* --- Utilitários --- */

      function setStatus(type, message) {
        const statusDiv = $('#status');
        statusDiv.removeClass('processing success error').addClass('hidden');
        if (type !== 'clear') {
          statusDiv.addClass(type).html(message).removeClass('hidden');
        }
      }

      function maskNip(e){
        let v = e.target.value.replace(/\D/g,"");
        v.length > 8 && (v = v.slice(0,8));
        v.length > 6 ? v = v.replace(/^(\d{2})(\d{4})(\d{1,2})/,"$1.$2.$3") : v.length > 2 && (v = v.replace(/^(\d{2})(\d{1,4})/,"$1.$2"));
        e.target.value = v;
      }
      
      function navigateTo(page) {
        if (BASE_URL) {
          window.top.location.href = BASE_URL + '?page=' + page;
        }
      }
    </script>
</body>
</html>
