<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Inspeções JRS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <script type="module" src="https://cdn.jsdelivr.net/npm/@material/web/all.js/+esm"></script>

  <style>
    /* --- Material Design 3 Tokens & Globals --- */
    :root {
      /* Paleta de Cores (Tokens) */
      --md-sys-color-primary: #050F41;
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-secondary: #5A5D72;
      --md-sys-color-on-secondary: #FFFFFF;
      --md-sys-color-background: #F5F5F5;
      --md-sys-color-surface: #FFFFFF;
      --md-sys-color-surface-container-high: #F0F0F0;
      --md-sys-color-on-surface: #1C1B1F;
      --md-sys-color-on-surface-variant: #49454F;
      --md-sys-color-outline: #79747E;
      --md-sys-color-error: #B3261E;

      /* Tipografia (Tokens) */
      --md-sys-font-family-headline: 'Montserrat', sans-serif;
      --md-sys-font-family-body: 'Carlito', sans-serif;

      /* Shape */
      --md-sys-shape-corner-medium: 12px;
      --md-sys-shape-corner-large: 16px;
    }

    /* Estilos Globais */
    body {
      font-family: var(--md-sys-font-family-body);
      background-color: var(--md-sys-color-background);
      color: var(--md-sys-color-on-surface);
      margin: 0;
      padding: 24px;
      box-sizing: border-box;
    }

    /* Tipografia */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--md-sys-font-family-headline);
      color: var(--md-sys-color-primary);
      font-weight: 500;
    }
    
    h1 { font-size: 2rem; margin-bottom: 16px; }
    h3 { font-size: 1.5rem; margin: 24px 0 16px 0; border-bottom: 1px solid var(--md-sys-color-outline); padding-bottom: 8px;}

    /* Componente Principal */
    md-elevated-card {
      background-color: var(--md-sys-color-surface);
      border-radius: var(--md-sys-shape-corner-medium);
      padding: 24px;
      margin: 0 auto;
      max-width: 900px;
      box-sizing: border-box;
    }

    /* Layout do Formulário */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      width: 100%;
    }

    md-outlined-text-field,
    md-outlined-select {
      width: 100%;
      margin-bottom: 16px;
      --md-outlined-text-field-container-shape: var(--md-sys-shape-corner-medium);
      --md-outlined-select-container-shape: var(--md-sys-shape-corner-medium);
    }
    
    /* Campos que devem ocupar 2 colunas */
    .grid-span-2 {
      grid-column: span 2;
    }
    
    /* Campos que devem ocupar 3 colunas */
    .grid-span-3 {
      grid-column: span 3;
    }
    
    /* Ajuste para grids responsivos */
    @media (max-width: 800px) {
      .grid-span-2, .grid-span-3 {
        grid-column: span 1;
      }
      .form-grid {
        grid-template-columns: 1fr; /* Coluna única em telas pequenas */
      }
    }

    .button-container {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 24px;
    }

    /* Seções condicionais */
    #conclusao-section, #restricoes-section, #concurso-section {
      display: none; /* Mantém a lógica original */
      border: 1px solid var(--md-sys-color-outline);
      border-radius: var(--md-sys-shape-corner-medium);
      padding: 16px;
      margin-top: 16px;
      background-color: var(--md-sys-color-surface-container-high);
    }
    
    #restricoes-list {
      margin-top: 16px;
    }
    
    /* Loader */
    #loader {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
    md-circular-progress {
      --md-circular-progress-size: 64px;
    }

    /* Navegação */
    .header-actions {
      display: flex;
      justify-content: flex-end;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .IconButton {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-primary);
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      text-decoration: none;
    }
    .IconButton:hover {
      background-color: rgba(5, 15, 65, 0.1);
    }
    .IconButton .material-symbols-outlined {
      font-size: 24px;
    }

  </style>
</head>
<body>

  <div class="header-actions">
      <div class="IconButton" onclick="navigateTo('dashboard')" title="Dashboard">
        <span class="material-symbols-outlined">dashboard</span>
      </div>
      <div class="IconButton" onclick="navigateTo('parecer')" title="Gerar Parecer">
        <span class="material-symbols-outlined">edit_note</span>
      </div>
  </div>

  <md-elevated-card>
    <h1>Nova Inspeção de Saúde</h1>
    <form id="inspectionForm">
      
      <div class="form-grid">
        <md-outlined-text-field
          label="Data da IS"
          type="date"
          id="dataIS"
          name="dataIS"
          required>
        </md-outlined-text-field>

        <md-outlined-select label="OM" id="omSelect" name="om" onchange="omChanged()" required>
          </md-outlined-select>

        <md-outlined-select label="Finalidade" id="finalidadeSelect" name="finalidade" onchange="finalidadeChanged()" required>
          </md-outlined-select>
      </div>

      <div class="form-grid">
        <md-outlined-text-field
          label="NIP (com pontos e traço)"
          id="nip"
          name="nip"
          onchange="fetchMilitarData()">
        </md-outlined-text-field>

        <md-outlined-select label="P/G" id="postoSelect" name="posto">
          </md-outlined-select>

        <md-outlined-text-field
          label="Nome do Inspecionado"
          id="nome"
          name="nome"
          class="grid-span-2">
        </md-outlined-text-field>
      </div>

      <div id="concurso-section">
        <h3>Dados do Concurso</h3>
        <div class="form-grid">
          <md-outlined-text-field
            label="Inscrição"
            id="inscricao"
            name="inscricao">
          </md-outlined-text-field>
          <md-outlined-text-field
            label="DS-1A"
            id="ds1a"
            name="ds1a">
          </md-outlined-text-field>
        </div>
      </div>

      <div id="conclusao-section">
        <h3>Conclusão da Inspeção</h3>
        <div class="form-grid">
          <md-outlined-select label="Laudo" id="laudoSelect" name="laudo">
            <md-menu-item value="APTO">APTO</md-menu-item>
            <md-menu-item value="APTO A">APTO "A"</md-menu-item>
            <md-menu-item value="APTO B">APTO "B"</md-menu-item>
            <md-menu-item value="INCAPAZ B1">INCAPAZ "B1"</md-menu-item>
            <md-menu-item value="INCAPAZ B2">INCAPAZ "B2"</md-menu-item>
            <md-menu-item value="INCAPAZ C">INCAPAZ "C"</md-menu-item>
            <md-menu-item value="INCAPAZ DEFINITIVAMENTE">INCAPAZ DEFINITIVAMENTE</md-menu-item>
            <md-menu-item value="FALTOU">FALTOU</md-menu-item>
          </md-outlined-select>
          
          <md-outlined-text-field
            label="Nº TIS"
            id="tis"
            name="tis">
          </md-outlined-text-field>

          <md-outlined-text-field
            label="Data do Laudo"
            type="date"
            id="dataLaudo"
            name="dataLaudo">
          </md-outlined-text-field>
        </div>
      </div>

      <div id="restricoes-section">
        <h3>Adicionar Restrições</h3>
        <div class="form-grid">
          <md-outlined-select label="Restrição" id="restricaoSelect" name="restricao">
            </md-outlined-select>

          <md-outlined-text-field
            label="Complemento"
            id="complemento"
            name="complemento"
            placeholder="Ex: 'joelho esquerdo'">
          </md-outlined-text-field>

          <md-outlined-text-field
            label="Prazo (dias)"
            id="prazo"
            name="prazo"
            type="number">
          </md-outlined-text-field>

          <div style="align-self: center;">
            <md-outlined-button id="addRestricaoButton" onclick="addRestricao()">
              Adicionar
              <span class="material-symbols-outlined" slot="icon">add</span>
            </md-outlined-button>
          </div>
        </div>
        <div id="restricoes-list">
          </div>
      </div>

      <h3 style="margin-top: 24px;">Observações</h3>
      <md-outlined-text-field
        label="Observações / Laudo"
        type="textarea"
        rows="4"
        id="observacoes"
        name="observacoes">
      </md-outlined-text-field>

      <div class="button-container">
        <md-filled-button id="saveButton" onclick="saveInspection()">
          Salvar Inspeção
          <span class="material-symbols-outlined" slot="icon">save</span>
        </md-filled-button>
      </div>
    </form>
  </md-elevated-card>

  <div id="loader">
    <md-circular-progress indeterminate></md-circular-progress>
  </div>

    <script>
      let hnreMilitaryData = []; let originalPgOptions = [];
      $(document).ready(function() { document.getElementById('dataEntrevista').valueAsDate = new Date(); setStatus('processing', 'Carregando opções do formulário...'); google.script.run.withSuccessHandler(populateDropdowns).withFailureHandler(onInitialLoadFailure).getDropdownData(); $('#nip').on('input', maskNip); $('#inspectionForm').on('submit', handleFormSubmit); $('#om').on('change', handleOmChange); $('#finalidade').on('change', checkRestricoesVisibility); $('#statusIS').on('change', handleStatusChange); $('#secao-conclusao').on('input keyup', '#laudo', handleLaudoInput); $('.accordion-header').on('click', function() { $(this).toggleClass('active').next('.accordion-panel').slideToggle(200); }); });
      function onInitialLoadFailure(error) { setStatus('error', `<b>Falha Crítica:</b> Não foi possível carregar os dados dos menus. <br><small>Erro: ${error.message}</small>`); $('#inspectionForm').find('input, select, textarea, button').prop('disabled', true); }
      function populateDropdowns(data) { setStatus('clear'); originalPgOptions = data.pgOptions; const statusesToRemove = ['Auditoria', 'Cancelada', 'Faltou', 'JSD', 'Remarcada', 'Restituída JSD', 'Restituída Auditoria']; const filteredStatusOptions = data.statusOptions.filter(opt => !statusesToRemove.includes(opt)); populateSimpleSelect('#om', data.omOptions, 'Selecione a OM...'); populateSimpleSelect('#finalidade', data.finalidadeOptions, 'Selecione a finalidade...'); populateSimpleSelect('#pg', originalPgOptions, 'Selecione o P/G...'); populateSimpleSelect('#statusIS', filteredStatusOptions, 'Selecione o status...'); populateRestricoes(data.restricoesOptions); $('#om').val('HNRe').trigger('change'); $('#statusIS').val('Agendada'); }
      function populateSimpleSelect(selector, options, placeholder) { const select = $(selector); select.empty(); select.append(`<option value="" disabled selected>${placeholder}</option>`); if (options && options.length > 0) options.sort().forEach(opt => select.append(new Option(opt, opt))); }
      function populateRestricoes(options) { const grid = $('#restricoes-grid'); grid.empty(); grid.append(createCheckboxItem('LTS', 'restricoes', 'LTS')); if(options) options.forEach(opt => { if(opt !== 'LTS') grid.append(createCheckboxItem(opt, 'restricoes', opt)); }); const outrosHtml = `<div class="checkbox-item"><input type="checkbox" id="restricao-outros" name="restricoes" value="Outros"><label for="restricao-outros">Outros:</label><input type="text" id="restricao-outros-text" class="hidden" placeholder="Descreva..."></div>`; grid.append(outrosHtml); $('input[name="restricoes"]').on('change', handleRestricaoChange); }
      function createCheckboxItem(value, name, label) { const id = `restricao-${value.replace(/[^a-zA-Z0-9]/g, "")}`; return `<div class="checkbox-item"><input type="checkbox" id="${id}" name="${name}" value="${value}"><label for="${id}">${label}</label></div>`; }
      function handleOmChange() { if ($(this).val() === 'HNRe') setupHnreMode(); else setupManualMode(); checkRestricoesVisibility(); }
      function handleStatusChange() { const status = $(this).val(); const conclusaoStatuses = ['Concluída', 'TIS assinado', 'Votada JRS']; const showConclusao = conclusaoStatuses.includes(status); $('#secao-conclusao').toggleClass('hidden', !showConclusao); const showTis = ['TIS assinado', 'Votada JRS'].includes(status); const showDs1a = status === 'TIS assinado'; $('#tis-group').toggleClass('hidden', !showTis); $('#ds1a-group').toggleClass('hidden', !showDs1a); if (!showConclusao) { $('#secao-conclusao').find('input, textarea').val(''); handleLaudoInput(); } $('#laudo, #tis, #ds1a').prop('required', false); switch(status) { case 'Concluída': $('#laudo').prop('required', true); break; case 'Votada JRS': $('#laudo, #tis').prop('required', true); break; case 'TIS assinado': $('#laudo, #tis, #ds1a').prop('required', true); break; } }
      function handleLaudoInput() { const laudoText = ($('#laudo').val() || '').trim(); const showDataLaudo = laudoText !== ''; const dataLaudoInput = $('#dataLaudo'); $('#dataLaudo-group').toggleClass('hidden', !showDataLaudo); if(showDataLaudo && !dataLaudoInput.val()) document.getElementById('dataLaudo').valueAsDate = new Date(); if(!showDataLaudo) dataLaudoInput.val(''); checkRestricoesVisibility(); }
      function checkRestricoesVisibility() { const laudoPreenchido = ($('#laudo').val() || '').trim() !== ''; const omEhHNRe = $('#om').val() === 'HNRe'; const finalidadesValidas = ['TÉRMINO DE RESTRIÇÕES', 'TÉRMINO DE INCAPACIDADE', 'VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL']; const finalidadeEhValida = finalidadesValidas.includes($('#finalidade').val()); if (laudoPreenchido && omEhHNRe && finalidadeEhValida) { $('#restricoes-section').removeClass('hidden'); } else { $('#restricoes-section').addClass('hidden'); if ($('.accordion-header').hasClass('active')) $('.accordion-header').trigger('click'); $('input[name="restricoes"]').prop('checked', false).trigger('change'); } }
      function handleRestricaoChange(e) { const checkbox = $(e.target); const isChecked = checkbox.is(':checked'); const value = checkbox.val(); if (value === 'LTS' && isChecked) { $('input[name="restricoes"]').not(checkbox).prop('checked', false).prop('disabled', true); $('#restricao-outros-text').addClass('hidden').val(''); } else if (value === 'LTS' && !isChecked) { $('input[name="restricoes"]').prop('disabled', false); } else if (value !== 'LTS' && isChecked) { $('input[name="restricoes"][value="LTS"]').prop('disabled', true); } else if (value !== 'LTS' && !isChecked) { if ($('input[name="restricoes"]:checked').not('[value="LTS"]').length === 0) { $('input[name="restricoes"][value="LTS"]').prop('disabled', false); } } if (value === 'Outros') { $('#restricao-outros-text').toggleClass('hidden', !isChecked); if (!isChecked) $('#restricao-outros-text').val(''); } }
      function setupHnreMode() { $('#inspecionadoContainer').html('<span>Carregando...</span>'); $('#pgContainer').html('<input type="text" id="pg" name="pg" required readonly>'); $('#nip').val('').prop('readonly', true); google.script.run.withSuccessHandler(function(data) { hnreMilitaryData = data; const selectHtml = '<select id="inspecionado" name="inspecionado" required style="width:100%;"></select>'; $('#inspecionadoContainer').html(selectHtml); const inspSelect = $('#inspecionado'); inspSelect.append(new Option('', '', true, true)); data.forEach(m => inspSelect.append(new Option(m.inspecionado, m.inspecionado))); inspSelect.select2({ placeholder: 'Digite para buscar...', allowClear: true }); inspSelect.on('change', function() { const selectedName = $(this).val(); const military = hnreMilitaryData.find(m => m.inspecionado === selectedName); if (military) { $('#pg').val(military.pg); $('#nip').val(military.nip); } else { $('#pg, #nip').val(''); } }); }).withFailureHandler(onInitialLoadFailure).getHnreMilitaryData(); }
      function setupManualMode() { if ($('#inspecionado').data('select2')) $('#inspecionado').select2('destroy'); $('#inspecionadoContainer').html('<input type="text" id="inspecionado" name="inspecionado" required>'); $('#pgContainer').html('<select id="pg" name="pg" required></select>'); populateSimpleSelect('#pg', originalPgOptions, 'Selecione o P/G...'); $('#nip').val('').prop('readonly', false); }
      function handleFormSubmit(e) { e.preventDefault(); const btn = $('#submitBtn'); btn.prop('disabled', true).html('<span class="material-symbols-outlined" style="font-variation-settings: \'FILL\' 1;">hourglass_top</span> Salvando...'); setStatus('processing', 'Salvando...'); const formData = { om: $('#om').val(), inspecionado: ($('#inspecionado').val() || '').toUpperCase(), pg: $('#pg').val(), nip: $('#nip').val(), is: $('#is').val(), finalidade: $('#finalidade').val(), dataEntrevista: $('#dataEntrevista').val(), statusIS: $('#statusIS').val(), tis: $('#tis').val(), ds1a: $('#ds1a').val(), laudo: $('#laudo').val(), dataLaudo: $('#dataLaudo').val(), restricoes: $('input[name="restricoes"]:checked').map(function() { return this.value; }).get(), outrosRestricao: $('#restricao-outros-text').val() }; google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).addNewInspection(formData); }
      function onSuccess(response) { if (response.status === 'success') { setStatus('success', `<strong>Sucesso!</strong> ${response.message}`); $('#submitBtn').prop('disabled', false).html('<span class="material-symbols-outlined" style="font-variation-settings: \'FILL\' 1;">add_circle</span> Adicionar Outra'); $('#inspectionForm')[0].reset(); document.getElementById('dataEntrevista').valueAsDate = new Date(); $('#statusIS').val('Agendada'); $('#om').val('HNRe').trigger('change'); handleStatusChange(); } else { onFailure({ message: response.message }); } }
      function onFailure(error) { setStatus('error', `ERRO: ${error.message}`); $('#submitBtn').prop('disabled', false).html('<span class="material-symbols-outlined" style="font-variation-settings: \'FILL\' 1;">error</span> Tentar Novamente'); }
      function setStatus(type, message) { const statusDiv = $('#status'); statusDiv.removeClass('processing success error').hide(); if (type !== 'clear') { statusDiv.addClass(type).html(message).show(); } }
      function maskNip(e){let v=e.target.value.replace(/\D/g,"");v.length>8&&(v=v.slice(0,8)),v.length>6?v=v.replace(/^(\d{2})(\d{4})(\d{1,2})/,"$1.$2.$3"):v.length>2&&(v=v.replace(/^(\d{2})(\d{1,4})/,"$1.$2")),e.target.value=v}
      function setupHnreMode() { 
        $('#inspecionadoContainer').html('<span>Carregando...</span>');
        $('#pgContainer').html('<input type="text" id="pg" name="pg" required readonly>');
        $('#nip').val('').prop('readonly', true);
        // AQUI ESTÁ A MUDANÇA:
        google.script.run.withSuccessHandler(function(data) {
          hnreMilitaryData = data;
          const selectHtml = '<select id="inspecionado" name="inspecionado" required style="width:100%;"></select>';
          $('#inspecionadoContainer').html(selectHtml);
          const inspSelect = $('#inspecionado');
          inspSelect.append(new Option('', '', true, true));
          data.forEach(m => inspSelect.append(new Option(m.inspecionado, m.inspecionado)));
          inspSelect.select2({ placeholder: 'Digite para buscar...', allowClear: true });
          inspSelect.on('change', function() {
            const selectedName = $(this).val();
            const military = hnreMilitaryData.find(m => m.inspecionado === selectedName);
            if (military) { $('#pg').val(military.pg); $('#nip').val(military.nip); } 
            else { $('#pg, #nip').val(''); }
          });
        }).withFailureHandler(onInitialLoadFailure)
        .getHnreMilitaryDataForForm(); // <-- NOME DA FUNÇÃO ATUALIZADO
      }

      function handleFormSubmit(e) {
        e.preventDefault();
        const btn = $('#submitBtn'); btn.prop('disabled', true).html('<span class="material-symbols-outlined" style="font-variation-settings: \'FILL\' 1;">hourglass_top</span> Salvando...');
        setStatus('processing', 'Salvando...');
        const formData = {
          om: $('#om').val(), inspecionado: ($('#inspecionado').val() || '').toUpperCase(),
          pg: $('#pg').val(), nip: $('#nip').val(), is: $('#is').val(),
          finalidade: $('#finalidade').val(), dataEntrevista: $('#dataEntrevista').val(),
          statusIS: $('#statusIS').val(), tis: $('#tis').val(), ds1a: $('#ds1a').val(),
          laudo: $('#laudo').val(), dataLaudo: $('#dataLaudo').val(),
          restricoes: $('input[name="restricoes"]:checked').map(function() { return this.value; }).get(),
          outrosRestricao: $('#restricao-outros-text').val()
        };
        // ATUALIZADO AQUI TAMBÉM:
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).addNewInspection(formData);
      }
    </script>
    
    <script>
      let BASE_URL = '';
      function navigateTo(page) {
        if (BASE_URL) {
          window.top.location.href = BASE_URL + '?page=' + page;
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        google.script.run.withSuccessHandler((url) => {
          BASE_URL = url;
        }).getWebAppUrl();
      });
    </script>
</body>
</html>
