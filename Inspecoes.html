<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <!-- Importação Material Symbols com Eixos Variáveis COMPLETA -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
      :root { 
          --primary-color: #050F41; --accent-color: #FAB932; --success-color: #079551; --danger-color: #B71C1C;
          --font-main: 'Montserrat', sans-serif;
          --sidebar-width-collapsed: 70px; --sidebar-width-expanded: 260px;
      }
      @font-face { font-family: 'Octin College Bold'; src: url('Octin College Bold.ttf') format('truetype'); font-weight: bold; font-style: normal; font-display: swap; }
      
      body { font-family: var(--font-main); background: #f4f4f9; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
      
      /* SIDEBAR */
      .sidenav { height: 100%; width: var(--sidebar-width-collapsed); position: fixed; z-index: 1000; top: 0; left: 0; background: var(--primary-color); transition: width 0.4s; display: flex; flex-direction: column; overflow: hidden; }
      .sidenav:hover { width: var(--sidebar-width-expanded); }
      .sidenav-header { display: flex; justify-content: center; align-items: center; height: 80px; padding-top: 15px; }
      .sidenav-header img { width: 40px; transition: 0.3s; }
      .sidenav:hover .sidenav-header img { width: 90px; }
      
      .sidenav a { padding: 0; text-decoration: none; font-size: 16px; font-weight: 600; color: #e0e0e0; display: flex; align-items: center; border-left: 4px solid transparent; height: 50px; overflow: hidden; white-space: nowrap; cursor: pointer; width: 100%; }
      .sidenav a:hover, .sidenav a.active { background: rgba(255,255,255,0.1); color: #fff; border-left: 4px solid var(--accent-color); }
      .sidenav a .material-symbols-outlined { min-width: var(--sidebar-width-collapsed); text-align: center; font-size: 24px; margin-left: -4px; z-index: 2; font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 48 !important; }
      .nav-text { opacity: 0; transition: 0.3s; pointer-events: none; margin-left: 10px; }
      .sidenav:hover .nav-text { opacity: 1; }
      
      .sidenav-footer { margin-top: auto; padding-bottom: 20px; display: flex; justify-content: center; opacity: 0.7; }
      .sidenav:hover .sidenav-footer { opacity: 1; }
      .sidenav-footer img { width: 40px; transition: 0.3s; }
      .sidenav:hover .sidenav-footer img { width: 140px; }
      
      /* MAIN */
      .container-main { margin-left: var(--sidebar-width-collapsed); padding: 20px; flex: 1; display: flex; flex-direction: column; transition: 0.4s; }
      .header-box { background: var(--primary-color); color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: center; }
      .header-text h1 { font-family: 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; font-size: 32px; margin: 0; }
      
      .chip-filters { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
      .chip { padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #555; white-space: nowrap; transition: 0.2s; }
      .chip:hover { background-color: #f0f0f0; }
      
      .chip-count { background: rgba(0,0,0,0.1); border-radius: 50%; padding: 2px 6px; font-size: 11px; margin-left: 5px; transition: 0.2s; }
      
      /* ESTILO PADRÃO DE CHIP ATIVO (AZUL) */
      .chip.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
      .chip.active .chip-count { background: rgba(255,255,255,0.2); color: white; }

      /* --- ESTILOS ESPECIAIS PARA O CHIP "MSG PENDENTES" --- */
      
      /* 1. Badge Vermelho quando tem pendências (>0) e chip não ativo */
      .chip#chip-msg-pendente.has-pending:not(.active) .chip-count {
          background-color: var(--danger-color);
          color: white;
      }
      
      /* 2. Chip Inteiro Vermelho quando Ativo */
      .chip#chip-msg-pendente.active {
          background-color: var(--danger-color) !important;
          border-color: var(--danger-color) !important;
          color: white !important;
      }
      .chip#chip-msg-pendente.active .chip-count {
          background-color: rgba(255,255,255,0.2); /* Fundo sutil branco sobre o vermelho */
          color: white;
      }
      
      /* TOOLBAR E AUTOCOMPLETE */
      .toolbar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
      
      .search-wrapper { flex: 0 1 300px; position: relative; min-width: 250px; } 
      
      .search-box { position: relative; width: 100%; }
      .search-box input { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #ccc; border-radius: 4px; font-family: var(--font-main); box-sizing: border-box; }
      .search-box .search-icon { position: absolute; left: 10px; top: 12px; color: #888; pointer-events: none; }
      
      .autocomplete-list {
          position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #ddd; border-top: none; z-index: 99; background-color: #fff;
          max-height: 250px; overflow-y: auto; border-radius: 0 0 4px 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
      }
      .autocomplete-item { padding: 10px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f1f1f1; }
      .autocomplete-item:hover { background-color: #e9e9e9; }
      .autocomplete-item strong { color: var(--primary-color); }

      /* Botões */
      .toolbar-actions { display: flex; gap: 10px; margin-left: auto; }
      .btn { padding: 10px 20px; border: none; border-radius: 4px; font-family: var(--font-main); font-weight: 700; text-transform: uppercase; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px; font-size: 13px; white-space: nowrap; }
      .btn-primary { background: var(--primary-color); }
      .btn-secondary { background: var(--accent-color); color: #000; }
      
      /* TABELA */
      .table-container { background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow-x: auto; min-height: 200px; }
      table { width: 100%; border-collapse: collapse; min-width: 900px; }
      th { background: var(--primary-color); color: white; text-align: left; padding: 15px; font-weight: 600; text-transform: uppercase; font-size: 12px; border-bottom: 3px solid var(--accent-color); }
      td { padding: 12px 15px; border-bottom: 1px solid #eee; color: #333; font-size: 13px; vertical-align: middle; }
      tr:hover { background: #f9f9fa; }
      
      .status-cell { text-align: center; white-space: nowrap; }
      .icon-status { font-size: 28px; vertical-align: middle; }
      .om-tag { font-size: 11px; color: #777; font-weight: 400; }
      .finalidade-cell { display: flex; justify-content: space-between; align-items: center; }
      .action-icons { display: flex; gap: 5px; }
      .icon-btn { border: none; background: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; }
      .icon-btn:hover { background: #f0f0f0; }

      /* ESTILOS DE ÍCONES (Status) */
      .st-blue { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' -25, 'opsz' 48; color: #050F41; }
      .st-blue-heavy { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48; color: #050F41; }
      .st-red-acute { font-variation-settings: 'FILL' 0, 'wght' 600, 'GRAD' -25, 'opsz' 24; color: #B71C1C; }
      .st-red { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 200, 'opsz' 48; color: #B71C1C; }
      .st-red-heavy { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 40; color: #B71C1C; }
      /* Concluída */
      .st-red-heavy-48 { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48; color: #B71C1C; } 
      .st-red-outlined { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 40; color: #B71C1C; } 
      .st-red-bomb { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 400, 'opsz' 48; color: #B71C1C; }
      .st-green { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 200, 'opsz' 48; color: #079551; }
      .st-green-task { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; color: #079551; }
      .st-green-folder { font-variation-settings: 'FILL' 1, 'wght' 600, 'GRAD' 200, 'opsz' 40; color: #079551; }
      .st-yellow { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 200, 'opsz' 48; color: #FAB932; }
      .st-yellow-light { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' -25, 'opsz' 48; color: #FAB932; }
      .st-yellow-heavy { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48; color: #FAB932; }
      .st-yellow-reply { font-variation-settings: 'FILL' 0, 'wght' 700, 'GRAD' 200, 'opsz' 40; color: #FAB932; }
      .st-yellow-reply-heavy { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 40; color: #FAB932; }

      /* Estilos de Ícones (Ação) */
      .act-green { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 200, 'opsz' 48; color: #079551; }
      .act-yellow { font-variation-settings: 'FILL' 0, 'wght' 700, 'GRAD' 0, 'opsz' 40; color: #FAB932; }
      .act-blue { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; color: #050F41; }
      .act-red { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 24; color: #B71C1C; }
      .act-reply { font-variation-settings: 'FILL' 0, 'wght' 700, 'GRAD' 0, 'opsz' 24; color: #FAB932; }

      .double-icon-container { display: inline-flex; align-items: center; gap: 6px; justify-content: center; }

      /* RODAPÉ DUPLO */
      .main-footer { margin-top: auto; padding: 20px; display: flex; justify-content: center; align-items: center; gap: 80px; border-top: 1px solid #e0e0e0; }
      .footer-logo { height: 70px; width: auto; object-fit: contain; }
      
      .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
      .modal-content { background: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
      .modal-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
      .btn-option { padding: 12px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: 600; transition: 0.2s; font-family: var(--font-main); }
      .btn-option:hover { background: #f0f0f0; border-color: var(--primary-color); }
      #loading-msg { text-align: center; padding: 20px; color: #666; }
      #error-msg { text-align: center; padding: 20px; color: var(--danger-color); display: none; }
    </style>
</head>
<body>
    <nav class="sidenav" id="mySidenav">
        <div class="sidenav-header"><img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe"></div>
        <a href="<?= url ?>?page=dashboard"><span class="material-symbols-outlined">chart_data</span><span class="nav-text">Dashboard</span></a>
        <a href="<?= url ?>?page=inspecoes" class="active"><span class="material-symbols-outlined">clinical_notes</span><span class="nav-text">Inspeções</span></a>
        <a href="<?= url ?>?page=parecer"><span class="material-symbols-outlined">lab_profile</span><span class="nav-text">Parecer</span></a>
        <div class="sidenav-footer"><img src="https://i.imgur.com/XHPXHdt.png"></div>
    </nav>
    <main class="container-main">
        <div class="header-box"><div class="header-text"><h1>INSPEÇÕES DE SAÚDE</h1></div></div>
        
        <!-- CHIP FILTERS -->
        <div class="chip-filters">
            <div class="chip active" onclick="applyChipFilter('all', this)">Todos <span class="chip-count" id="count-all">0</span></div>
            <div class="chip" onclick="applyChipFilter('agendada', this)">Agendadas <span class="chip-count" id="count-agendada">0</span></div>
            <div class="chip" onclick="applyChipFilter('concluida', this)">Concluídas <span class="chip-count" id="count-concluida">0</span></div>
            <div class="chip" id="chip-faltas" onclick="applyChipFilter('faltas', this)">Faltas <span class="chip-count" id="count-faltas">0</span></div>
            <div class="chip" id="chip-canceladas" onclick="applyChipFilter('canceladas', this)">Canceladas <span class="chip-count" id="count-canceladas">0</span></div>
            <!-- CHIP MSG PENDENTE -->
            <div class="chip" id="chip-msg-pendente" onclick="applyChipFilter('msg_pendente', this)">MSG Pendentes <span class="chip-count" id="count-msg-pendente">0</span></div>
        </div>

        <div class="toolbar">
            <div class="search-wrapper">
                <div class="search-box">
                    <span class="material-symbols-outlined search-icon">search</span>
                    <input type="text" id="searchInput" placeholder="Buscar por nome..." autocomplete="off">
                    <div id="autocompleteList" class="autocomplete-list"></div>
                </div>
            </div>
            <div class="toolbar-actions">
                <button class="btn btn-secondary"><span class="material-symbols-outlined">playlist_add</span> Add em Lote</button>
                <button class="btn btn-primary" onclick="window.top.location.href='<?= url ?>?page=parecer'"><span class="material-symbols-outlined">add</span> Nova Inspeção</button>
            </div>
        </div>
        <div class="table-container">
            <div id="loading-msg">Carregando dados...</div>
            <div id="error-msg"></div>
            <table id="dataTable" style="display:none;">
                <thead><tr><th style="width:90px;text-align:center;">STATUS</th><th style="width:100px;">DATA</th><th>INSPECIONADO</th><th>FINALIDADE</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <footer class="main-footer">
            <img src="https://i.imgur.com/mPObmH0.png" class="footer-logo" alt="Logo HNRe">
            <img src="https://i.imgur.com/lYp37Ar.png" class="footer-logo" alt="Logo Marinha">
        </footer>
    </main>
    <div id="statusModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--primary-color);">Qual o Status da IS no momento?</h3>
            <div class="modal-buttons">
                <button class="btn-option" onclick="confirmStatus('IS Concluída s/ voto')">IS Concluída s/ voto</button>
                <button class="btn-option" onclick="confirmStatus('Aprovada AUDITORIA CPMM')">Aprovada AUDITORIA CPMM</button>
                <button class="btn-option" onclick="confirmStatus('Homologada JSD')">Homologada JSD</button>
            </div>
        </div>
    </div>
    <script>
        let currentEditIndex=null;
        let allData=[], filteredData=[], currentFilter='all';

        document.addEventListener("DOMContentLoaded",()=>{ loadData(); setupAutocomplete(); });

        function loadData() {
            document.getElementById('loading-msg').style.display='block';
            document.getElementById('dataTable').style.display='none';
            google.script.run.withSuccessHandler(data => {
                allData = data; filteredData = data;
                updateCounts(); applyChipFilter('all', document.querySelector('.chip.active'));
            }).withFailureHandler(err=>{
                document.getElementById('loading-msg').style.display='none';
                document.getElementById('error-msg').innerText = "Erro: " + err.message;
                document.getElementById('error-msg').style.display = 'block';
            }).getInspecoesData();
        }

        function applyChipFilter(type, element) {
            if(element) { document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); element.classList.add('active'); }
            currentFilter = type;
            let result = [];
            if (type === 'all') result = allData;
            else if (type === 'agendada') result = allData.filter(d => ['IS Agendada', 'IS Remarcada'].includes(d.StatusIS));
            else if (type === 'concluida') result = allData.filter(d => ['IS Concluída s/ voto', 'IS Votada s/ assinatura', 'TIS assinado', 'Homologada JSD', 'Aprovada AUDITORIA CPMM'].includes(d.StatusIS));
            else if (type === 'faltas') result = allData.filter(d => d.StatusIS === 'Faltou');
            else if (type === 'canceladas') result = allData.filter(d => d.StatusIS === 'IS Cancelada');
            else if (type === 'msg_pendente') result = allData.filter(d => d.MSG === 'MSG PENDENTE' || d.MSG === 'MSG ATRASADA');
            
            const searchVal = document.getElementById('searchInput').value;
            if(searchVal) result = result.filter(d => (d['Inspecionado'] || d['Nome'] || '').includes(searchVal));
            
            renderTable(result);
        }

        function updateCounts() {
            if (!allData) return;
            const ag = allData.filter(d => ['IS Agendada', 'IS Remarcada'].includes(d.StatusIS)).length;
            const co = allData.filter(d => ['IS Concluída s/ voto', 'IS Votada s/ assinatura', 'TIS assinado', 'Homologada JSD', 'Aprovada AUDITORIA CPMM'].includes(d.StatusIS)).length;
            const fa = allData.filter(d => d.StatusIS === 'Faltou').length;
            const ca = allData.filter(d => d.StatusIS === 'IS Cancelada').length;
            const mp = allData.filter(d => d.MSG === 'MSG PENDENTE' || d.MSG === 'MSG ATRASADA').length;
            
            document.getElementById('count-all').innerText = allData.length;
            document.getElementById('count-agendada').innerText = ag;
            document.getElementById('count-concluida').innerText = co;
            document.getElementById('count-faltas').innerText = fa;
            document.getElementById('count-canceladas').innerText = ca;
            document.getElementById('count-msg-pendente').innerText = mp;
            
            // ATIVANDO ESTILO DE ALERTA SE CONTADOR > 0
            updateAlertChipStyle('chip-msg-pendente', mp);
            updateAlertChipStyle('chip-faltas', fa);
            updateAlertChipStyle('chip-canceladas', ca);
        }
        
        function updateAlertChipStyle(chipId, count) {
            const chip = document.getElementById(chipId);
            if(count > 0) chip.classList.add('has-pending'); else chip.classList.remove('has-pending');
        }

        function setupAutocomplete() {
            const input = document.getElementById('searchInput');
            const list = document.getElementById('autocompleteList');
            input.addEventListener('input', function(e) {
                const val = this.value; closeAllLists();
                if (!val) { applyChipFilter(currentFilter, null); return; }
                list.style.display = 'block';
                const names = [...new Set(allData.map(item => item['Inspecionado'] || item['Nome'] || '').filter(n => n))];
                let matches = 0;
                names.forEach(name => {
                    if (name.toUpperCase().includes(val.toUpperCase())) {
                        const item = document.createElement("div");
                        item.className = "autocomplete-item";
                        const regex = new RegExp(`(${val})`, "gi");
                        item.innerHTML = name.replace(regex, "<strong>$1</strong>");
                        item.addEventListener("click", function() {
                            input.value = name; closeAllLists();
                            const result = allData.filter(d => (d['Inspecionado'] || d['Nome']) === name);
                            renderTable(result);
                        });
                        list.appendChild(item);
                        matches++;
                    }
                });
                if (matches === 0) closeAllLists();
            });
            document.addEventListener("click", function (e) { if (e.target !== input) closeAllLists(); });
        }
        function closeAllLists() { document.getElementById('autocompleteList').innerHTML = ""; document.getElementById('autocompleteList').style.display = 'none'; }

        function renderTable(data){
            document.getElementById('loading-msg').style.display='none';
            document.getElementById('dataTable').style.display='table';
            const tbody=document.getElementById('tableBody'); tbody.innerHTML='';
            
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Nenhum dado encontrado.</td></tr>'; return; }

            data.forEach((r)=>{
                const idx = r.rowIndex;
                const tr=document.createElement('tr');
                let iconHTML = '';
                
                const s = r.StatusIS;
                const m = r.MSG;
                const isMsgEnviada = (m === 'MSG ENVIADA');
                const isMsgPend = (m === 'MSG PENDENTE' || m === 'MSG ATRASADA'); // Explicit MSG column check
                const isFaltouOrCancelada = (s === 'Faltou' || s === 'IS Cancelada');

                // 1. ÍCONES DUPLOS
                if (isFaltouOrCancelada && isMsgEnviada) {
                    let stIcon = (s === 'Faltou') ? 'event_busy' : 'person_cancel';
                    let stClass = (s === 'Faltou') ? 'st-red' : 'st-red-heavy'; // Cancelada is heavy
                    iconHTML = `<div class="double-icon-container"><span class="material-symbols-outlined ${stClass}" title="${s}">${stIcon}</span><span class="material-symbols-outlined st-green" title="MSG ENVIADA">mark_email_read</span></div>`;
                } 
                else if (isFaltouOrCancelada && isMsgPend) {
                    let stIcon = (s === 'Faltou') ? 'event_busy' : 'person_cancel';
                    let stClass = (s === 'Faltou') ? 'st-red' : 'st-red-heavy';
                    iconHTML = `<div class="double-icon-container"><span class="material-symbols-outlined ${stClass}" title="${s}">${stIcon}</span><span class="material-symbols-outlined st-red" title="MSG PENDENTE">unsubscribe</span></div>`;
                }
                // 2. STATUS UNICOS
                else {
                     // Prioridade MSG se TIS Assinado
                     if (s === 'TIS assinado') {
                        if (isMsgEnviada) iconHTML = `<span class="material-symbols-outlined st-green" title="MSG ENVIADA">mark_email_read</span>`;
                        else if (isMsgPend) iconHTML = `<span class="material-symbols-outlined st-red" title="MSG PENDENTE">unsubscribe</span>`;
                        else iconHTML = `<span class="material-symbols-outlined st-gray" title="TIS assinado">check_circle</span>`;
                     } else {
                        // Mapeamento Direto
                        if(s==='IS aberta') iconHTML = `<span class="material-symbols-outlined st-blue" title="${s}">folder_open</span>`;
                        else if(s==='Declínio de competência de MPI') iconHTML = `<span class="material-symbols-outlined st-blue-heavy" title="${s}">input</span>`;
                        else if(s==='Revisão Ex-officio de MPI') iconHTML = `<span class="material-symbols-outlined st-blue-heavy" title="${s}">document_search</span>`;
                        else if(s==='Homologada Ex-officio de MPI') iconHTML = `<span class="material-symbols-outlined st-blue-heavy" title="${s}">gavel</span>`;
                        else if(s==='Inspecionado atrasado') iconHTML = `<span class="material-symbols-outlined st-red-acute" title="${s}">acute</span>`;
                        else if(s==='IS Cancelada') iconHTML = `<span class="material-symbols-outlined st-red-heavy" title="${s}">folder_delete</span>`; // Tabela diz folder_delete, prompt disse person_cancel? Table wins.
                        else if(s==='IS Agendada') iconHTML = `<span class="material-symbols-outlined st-green" title="${s}">calendar_check</span>`;
                        else if(s==='Faltou') iconHTML = `<span class="material-symbols-outlined st-red" title="${s}">person_cancel</span>`; // Tabela: person_cancel
                        else if(s==='IS Remarcada') iconHTML = `<span class="material-symbols-outlined st-yellow" title="${s}">calendar_clock</span>`;
                        else if(s==='Conclusão Pendente') iconHTML = `<span class="material-symbols-outlined st-red-outlined" title="${s}">unknown_document</span>`;
                        else if(s==='AUDITORIA CPMM') iconHTML = `<span class="material-symbols-outlined st-yellow-light" title="${s}">document_search</span>`;
                        else if(s==='Aprovada AUDITORIA CPMM') iconHTML = `<span class="material-symbols-outlined st-green-task" title="${s}">task</span>`;
                        else if(s==='REVISÃO JSD') iconHTML = `<span class="material-symbols-outlined st-yellow-heavy" title="${s}">gavel</span>`;
                        else if(s==='Homologada JSD') iconHTML = `<span class="material-symbols-outlined st-green-folder" title="${s}">folder_check</span>`; // EXCEÇÃO 1: Prioridade sobre MSG
                        else if(s==='Restituída AUDITORIA CPMM') iconHTML = `<span class="material-symbols-outlined st-yellow-reply" title="${s}">assignment_return</span>`;
                        else if(s==='Restituída JSD') iconHTML = `<span class="material-symbols-outlined st-yellow-reply-heavy" title="${s}">assignment_return</span>`;
                        else if(s==='IS Concluída s/ voto') iconHTML = `<span class="material-symbols-outlined st-red" title="${s}">how_to_vote</span>`;
                        else if(s==='IS Votada s/ assinatura') iconHTML = `<span class="material-symbols-outlined st-red-heavy-48" title="${s}">signature</span>`; // RED HEAVY
                        else iconHTML = `<span class="material-symbols-outlined st-gray" title="${s}">help</span>`;
                     }
                }

                // --- AÇÕES ---
                let acts = '';
                const btnDetail = btn('visibility','act-blue','Abrir Detalhamento IS',`viewDetails(${idx})`);
                
                // Exceção Homologada JSD / AUDITORIA CPMM / REVISÃO JSD / MSG ENVIADA -> Apenas Detalhes (Encerrada)
                const isEncerrada = ['Homologada JSD', 'Aprovada AUDITORIA CPMM'].includes(s) || isMsgEnviada;
                // Mas espere, a tabela diz visibility se encerrada.
                
                if (isEncerrada) {
                     acts += btnDetail;
                } else {
                     // Lógica Geral de Ações
                     // 1.5 Registrar MSG Enviada
                     if (m === 'MSG PENDENTE' || m === 'MSG ATRASADA' || (s==='TIS assinado' && r['TIS'] && r['DS-1a'])) {
                         acts += btn('outgoing_mail','act-green','Registrar MSG enviada',`doAction('msg_sent',${idx})`);
                     }
                     // 1.2 Editar IS
                     // Condições: Iniciada mas não encerrada
                     const editable = ['Declínio de competência de MPI','Revisão Ex-officio de MPI','IS Agendada','IS Remarcada','Conclusão Pendente','Aprovada AUDITORIA CPMM','Restituída AUDITORIA CPMM','Restituída JSD','IS Concluída s/ voto','IS Votada s/ assinatura'].includes(s) || (m==='MSG PENDENTE' || m==='MSG ATRASADA');
                     if (editable && !isMsgEnviada) acts += btn('edit','act-blue','Editar IS',`openEdit(${idx})`);

                     // 1.3 Reagendar
                     if(['IS Agendada','IS Remarcada','Faltou'].includes(s) && !isMsgEnviada) acts += btn('event_repeat','act-yellow','Reagendar IS',`doAction('reagendar',${idx})`);

                     // 1.4 Cancelar
                     if(['IS aberta','IS Agendada','IS Remarcada','Conclusão Pendente'].includes(s)) acts += btn('close','act-red','Cancelar IS',`doAction('cancel',${idx})`);

                     // 1.6 Agendar
                     if(['IS aberta','Declínio de competência de MPI','Revisão Ex-officio de MPI'].includes(s) && !r.DataEntrevista) acts += btn('event_upcoming','act-green','Agendar IS',`doAction('agendar',${idx})`);
                     
                     // 1.7 Restituir
                     if(s==='AUDITORIA CPMM' || s==='REVISÃO JSD') acts += btn('reply','act-reply','Registrar IS restituida',`doAction('restituir',${idx})`);
                     
                     // 1.1 Detalhes (Sempre por último)
                     acts += btnDetail;
                }

                // Nome Candidato
                let pg = r['P/G/Q'] || '';
                if(pg.trim().toUpperCase() === 'CANDIDATO') pg = '';
                const inspName = r['Inspecionado'] || r['Nome'] || '';
                const inspOM = r['OM'] || '';
                const inspHTML = `<b>${pg} ${inspName}</b> <span class="om-tag">(${inspOM})</span>`;
                
                tr.innerHTML=`<td class="status-cell">${iconHTML}</td><td>${formatDate(r.DataEntrevista)}</td><td>${inspHTML}</td><td class="finalidade-cell"><span>${r.Finalidade||''}</span><div class="action-icons">${acts}</div></td>`;
                tbody.appendChild(tr);
            });
        }

        function btn(icon, cssClass, title, click) { return `<button class="icon-btn" title="${title}" onclick="${click}"><span class="material-symbols-outlined ${cssClass}">${icon}</span></button>`; }
        function formatDate(d){ return d?d.split('-').reverse().join('/'):''; }
        function doAction(a,i){ if(confirm("Confirmar ação?")) google.script.run.withSuccessHandler(loadData).updateInspectionStatus(i,a); }
        function openEdit(i){ currentEditIndex=i; alert("Editar"); }
        function viewDetails(i){ alert("Detalhes"); }
        function confirmStatus(s){ document.getElementById('statusModal').style.display='none'; google.script.run.withSuccessHandler(loadData).updateInspectionStatus(currentEditIndex,'manual_status_update',{newStatus:s}); }
    </script>
</body>
</html>
