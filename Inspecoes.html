<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&family=Oswald:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #050f41;
        --danger-color: #990000;
        --danger-color-vivid: #d9534f;
        --danger-color-light: #fef5f5;
        --success-color: #146c43;
        --link-color: #0d6efd;
        --warning-color: #FAB932;
        --info-color: #6c757d;
        --secondary-color: #adb5bd;
        --font-oswald: 'Oswald', sans-serif;
        --font-carlito: 'Carlito', sans-serif;
        --light-gray-1: #fcfcfc;
        --dark-gray-3: #6c757d; 
        --card-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        --card-shadow-hover: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }
      body {
        font-family: var(--font-carlito);
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
        transition: margin-left .3s;
      }
      
      /* Sidebar */
      .sidenav {
        height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0; background-color: var(--primary-color);
        overflow-x: hidden; transition: 0.3s; padding-top: 60px; box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      }
      .sidenav a {
        padding: 15px 25px; text-decoration: none; font-size: 18px; font-family: var(--font-oswald); color: #e0e0e0; display: block; transition: 0.2s; border-left: 4px solid transparent;
      }
      .sidenav a:hover { background-color: rgba(255,255,255,0.1); color: #fff; border-left: 4px solid var(--warning-color); }
      .sidenav .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; margin-left: 50px; }
      .sidenav-header { text-align: center; color: white; margin-bottom: 30px; }
      .sidenav-header img { width: 80px; margin-bottom: 10px; }
      .sidenav-header h4 { font-family: var(--font-oswald); font-size: 1.2rem; }

      .container-main { max-width: 1400px; margin: 20px auto; padding: 20px; }
      
      .header-box { display: flex; align-items: center; background-color: var(--primary-color); color: #fff; padding: 20px 30px; border-radius: 8px; margin-bottom: 20px; box-shadow: var(--card-shadow); }
      .header-logo { height: 65px; margin-right: 25px; }
      .header-text h1 { font-family: var(--font-oswald); font-size: 32px; margin: 0; font-weight: 700; }
      .header-text p { font-family: var(--font-carlito); font-size: 18px; margin: 5px 0 0; opacity: .9; }
      
      .IconButton{display:flex;align-items:center;justify-content:center;width:55px;height:55px;border-radius:50%;background-color:rgba(255,255,255,0.1);color:#fff;cursor:pointer;transition:background-color .2s ease-in-out; text-decoration: none; margin-left: auto;}
      .IconButton:hover{background-color:rgba(255,255,255,0.2)}

      .card-elevated { background-color: #fff; border-radius: 8px; box-shadow: var(--card-shadow); border: 1px solid #e9e9e9; margin-bottom: 20px; overflow: hidden; }
      
      .section-title { display: flex; align-items: center; justify-content: center; font-family: var(--font-oswald); font-size: 32px; font-weight: 700; text-transform: uppercase; gap: 15px; color: #333; margin-top: 40px; margin-bottom: 25px; }
      .section-title .material-symbols-outlined { font-size: 38px !important; }

      /* Table Styles */
      .table-container { background-color: transparent; padding: 20px; } 
      .table-cell-main { font-weight: bold; color: #333; font-size: 1.15em; }
      .table-cell-sub { font-size: 0.8em; color: var(--dark-gray-3); }
      .table-row-alert td, .table-row-alert .table-cell-main, .table-row-alert .table-cell-sub { background-color: var(--danger-color-light) !important; color: var(--danger-color) !important; font-weight: bold !important; }
      .actions-cell-content { display: flex; justify-content: space-between; align-items: center; }
      .actions-icon { cursor: pointer; color: #777; font-size: 1.4em; }
      .actions-icon:hover { color: #000; }
      .status-icon { font-size: 1.4em; vertical-align: middle; margin-right: 0px; }

      /* Chips */
      .chip-filter { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 20px; font-family: var(--font-oswald); font-weight: 700; text-transform: uppercase; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; box-shadow: var(--card-shadow); user-select: none; background-color: #e9ecef; color: #495057; border: 1px solid #e9ecef; }
      .chip-filter.active { background-color: var(--dark-gray-3); color: #fff; }
      .chip-filter.chip-danger { background-color: var(--danger-color-light); color: var(--danger-color-vivid); border: 1px solid var(--danger-color-vivid); }
      .chip-filter.chip-danger.active { background-color: var(--danger-color-vivid); color: #fff; }
      .chip-filter.chip-warning { background-color: #fff8e1; color: #FAB932; border: 1px solid #FAB932; }
      .chip-filter.chip-warning.active { background-color: #FAB932; color: #fff; }
      .chip-filter .material-symbols-outlined { font-size: 1.2em; }
      
      /* Purpose Filter */
      .purpose-filter-menu { max-height: 300px; overflow-y: auto; }
      .purpose-item-wrapper { display: flex; align-items: center; padding: .25rem 1rem; cursor: pointer; }
      .purpose-item-wrapper:hover { background-color: #f8f9fa; }

      /* Modals */
      .modal-header { background-color: var(--primary-color); color: white; }
      .modal-body span { font-family: var(--font-oswald); text-transform: uppercase; color: #050f41; font-size: 1.2rem; }
      .restricoes-accordion-body { max-height: 250px; overflow-y: auto; padding: 1rem; column-count: 2; }
      #modalDetailsInspecionado { font-size: 1.5rem; font-weight: bold; font-family: var(--font-oswald); }
    </style>
</head>
<body>
    
    <!-- MENU LATERAL -->
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="sidenav-header">
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo">
            <h4>JRS - HNRe</h4>
        </div>
        <a href="#" onclick="navigateTo('dashboard'); return false;"><span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 10px;">dashboard</span>Dashboard</a>
        <a href="#" onclick="navigateTo('inspecoes'); return false;"><span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 10px;">table_view</span>Inspeções</a>
        <a href="#" onclick="navigateTo('formulario'); return false;"><span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 10px;">description</span>Formulário</a>
        <a href="#" onclick="navigateTo('parecer'); return false;"><span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 10px;">edit_note</span>Parecer</a>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main" class="container-main">
        <div class="header-box"> 
            <div class="IconButton" onclick="openNav()" style="margin-right: 20px; margin-left: 0;">
                <span class="material-symbols-outlined">menu</span>
            </div>
            <img src="https://i.imgur.com/KUbQz08.png" alt="Logo HNRe" class="header-logo">
            <div class="header-text">
                <h1>JUNTA REGULAR DE SAÚDE</h1>
                <p>HOSPITAL NAVAL DE RECIFE</p>
            </div>
            <div class="IconButton" onclick="navigateTo('formulario')" title="Nova Inspeção" style="margin-left: auto;">
                <span class="material-symbols-outlined">add_circle</span>
            </div>
        </div>

        <div id="loader" class="text-center card-elevated" style="padding: 50px;"> 
            <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div>
            <p class="mt-2">A carregar dados...</p>
        </div>

        <div id="mainContent" class="d-none">
            <div class="card-elevated"> 
                <div class="table-container">
                    <h2 class="section-title"><span class="material-symbols-outlined">patient_list</span> DETALHES DAS INSPEÇÕES</h2>
                    
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-3"> 
                            <input type="text" id="searchInput" class="form-control mb-2" placeholder="Buscar por nome...">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="purposeFilterButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                    Finalidades
                                </button>
                                <ul class="dropdown-menu w-100 purpose-filter-menu" id="purposeFilterMenu" aria-labelledby="purposeFilterButton"></ul>
                            </div>
                        </div>
                        
                        <div class="col-md-9 d-flex align-items-center justify-content-start pb-1 gap-2 flex-wrap">
                            <div class="chip-filter" id="agendadasFilter" title="Filtrar IS Agendadas"><span class="material-symbols-outlined">event_available</span> IS Agendadas</div>
                            <div class="chip-filter chip-danger" id="isPendenteFilter" title="Filtrar IS com pendência de status"><span class="material-symbols-outlined">pending_actions</span> IS Pendentes</div>
                            <div class="chip-filter chip-danger" id="pendingMsgFilter" title="Filtrar mensagens pendentes"><span class="material-symbols-outlined">unsubscribe</span> MSG PENDENTES</div>
                            <div class="chip-filter chip-warning" id="revisaoFilter" title="Filtrar inspeções Em Revisão"><span class="material-symbols-outlined">manage_search</span> Em Revisão</div>
                            <div class="chip-filter chip-warning" id="restituidaFilter" title="Filtrar inspeções Restituídas"><span class="material-symbols-outlined">arrow_circle_left</span> Restituídas</div>
                            <div class="chip-filter chip-danger" id="faltasFilter" title="Filtrar Faltas"><span class="material-symbols-outlined">person_off</span> Faltas</div>
                            <div class="chip-filter chip-danger" id="canceladasFilter" title="Filtrar IS Canceladas"><span class="material-symbols-outlined">event_busy</span> IS Canceladas</div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>STATUS</th><th>DATA</th><th>INSPECIONADO</th> <th>FINALIDADE</th></tr></thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS (Copiados do Dashboard.html original) -->
    
    <!-- Modal Detalhes -->
    <div class="modal fade" id="detailsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Detalhes da Inspeção</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="modalDetailsInspecionado"></p><p id="modalDetailsFinalidade"></p><hr><div id="laudo-section"><span>Laudo</span><p id="modalDetailsLaudo"></p></div><div id="restricoes-section"><span>Restrições</span><p id="modalDetailsRestricoes"></p></div><div class="row"><div class="col-md-4" id="dataLaudo-section"><span>Data do Laudo</span><p id="modalDetailsDataLaudo"></p></div><div class="col-md-4" id="tis-section"><span>TIS</span><p id="modalDetailsTis"></p></div><div class="col-md-4" id="ds1a-section"><span>DS-1a</span><p id="modalDetailsDs1a"></p></div></div><div id="minuta-msg-section" class="accordion mt-3 d-none"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMinuta">MINUTA MSG</button></h2><div id="collapseMinuta" class="accordion-collapse collapse"><div class="accordion-body"><p id="modalMinutaMsgText" style="white-space: pre-wrap;"></p></div></div></div></div></div></div></div></div>
    
    <!-- Modal Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><form id="editForm"><div class="modal-header"><h5 class="modal-title" id="editModalLabel">Editar Conclusão da Inspeção - <span id="editModalIsTitle"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div class="card-elevated" style="padding: 1.0rem; background-color: var(--light-gray-1, #fcfcfc); margin-bottom: 1.5rem;"><p class="h5" style="color: var(--primary-color); margin-bottom: 0; text-align: center; font-size: 1.5rem; font-weight: 700;"><span id="editModalInspecionado"></span></p></div><input type="hidden" id="editIsNumber"><div class="mb-3"><label for="editLaudo" class="form-label">Laudo</label><textarea class="form-control" id="editLaudo" rows="3"></textarea></div><div class="mb-3" id="editRestricoesContainer"><label class="form-label">Restrições</label><div class="accordion" id="editRestricoesAccordion"><div class="accordion-item"><h2 class="accordion-header" id="edit-headingOne"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#edit-collapseOne" aria-expanded="false" aria-controls="edit-collapseOne">Selecionar Restrições</button></h2><div id="edit-collapseOne" class="accordion-collapse collapse" aria-labelledby="edit-headingOne" data-bs-parent="#editRestricoesAccordion"><div class="accordion-body restricoes-accordion-body" id="editRestricoesBody"></div><div class="input-group p-3 d-none" id="editOutrosRestricaoContainer"><span class="input-group-text">Outros:</span><input type="text" class="form-control" id="editOutrosRestricaoText"></div></div></div></div></div><div class="row mb-3"><div class="col-md-4"><label for="editDataLaudo" class="form-label">Data do Laudo</label><input type="date" class="form-control" id="editDataLaudo"></div><div class="col-md-4"><label for="editTis" class="form-label">Nº TIS</label><input type="text" class="form-control" id="editTis" placeholder="000.000.00000" onkeyup="applyTISMask(this)"></div><div class="col-md-4"><label for="editDs1a" class="form-label">Código DS-1a</label><input type="text" class="form-control" id="editDs1a"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="saveEditButton">Salvar Alterações</button></div></form></div></div></div>

    <!-- Modal Remarcação -->
    <div class="modal fade" id="remarcarModal" tabindex="-1" aria-labelledby="remarcarModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="remarcarForm"><div class="modal-header"><h5 class="modal-title" id="remarcarModalLabel">Remarcar Inspeção</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p><strong>Inspecionado:</strong> <span id="remarcarModalInspecionado"></span></p><p><strong>IS:</strong> <span id="remarcarModalIs"></span></p><input type="hidden" id="remarcarIsNumber"><div class="mb-3"><label for="remarcarNovaData" class="form-label">Nova Data da Entrevista</label><input type="date" class="form-control" id="remarcarNovaData" required></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary" id="saveRemarcarButton">Salvar Nova Data</button></div></form></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- NAVEGAÇÃO E SIDEBAR ---
        function openNav() { document.getElementById("mySidenav").style.width = "250px"; document.getElementById("main").style.marginLeft = "250px"; }
        function closeNav() { document.getElementById("mySidenav").style.width = "0"; document.getElementById("main").style.marginLeft= "0"; }
        
        let BASE_URL = '';
        function navigateTo(page) { if (BASE_URL) window.top.location.href = BASE_URL + '?page=' + page; }
        
        // --- VARIÁVEIS GLOBAIS DA TABELA ---
        let allTableData = []; let filteredData = []; let allRestricoes = [];
        let detailsModalInstance, editModalInstance, remarcarModalInstance;
        let tooltipList = [];

        document.addEventListener('DOMContentLoaded', () => { 
            google.script.run.withSuccessHandler((url) => { BASE_URL = url; }).getWebAppUrl();
            
            detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal')); 
            editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
            remarcarModalInstance = new bootstrap.Modal(document.getElementById('remarcarModal'));

            document.getElementById('loader').classList.remove('d-none'); 
            document.getElementById('mainContent').classList.add('d-none'); 
            initializeTooltips();
            
            document.getElementById('editForm').addEventListener('submit', handleEditFormSubmit);
            document.getElementById('remarcarForm').addEventListener('submit', handleRemarcarFormSubmit);
            document.getElementById('searchInput').addEventListener('keyup', applyFilters);

            google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataError).getDashboardData(); 
        });

        function initializeTooltips() {
            tooltipList.forEach(tooltip => tooltip.dispose());
            tooltipList = [];
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {html: true}); 
            });
        }

        function onDataLoaded(response) { 
            try { 
                if (!response || !Array.isArray(response.tableData)) throw new Error("Dados inválidos."); 
                allTableData = response.tableData; 
                allRestricoes = response.restricoesOptions;
                
                document.getElementById('loader').classList.add('d-none'); 
                document.getElementById('mainContent').classList.remove('d-none'); 
                
                populateFilters(allTableData);
                populateEditModalOptions(allRestricoes);
                applyFilters();
                
                // Configurar Listeners de Chips
                ['isPendenteFilter','pendingMsgFilter','revisaoFilter','restituidaFilter','agendadasFilter','faltasFilter','canceladasFilter'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener('click', () => { el.classList.toggle('active'); applyFilters(); });
                });

            } catch(e) { onDataError(e); } 
        }

        function onDataError(error) { 
             document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`; 
        }

        // --- LÓGICA DE FILTROS E TABELA (Mantida do Original) ---
        function populateFilters(tableData) { 
            try { 
                const purposeMenu = document.getElementById('purposeFilterMenu');
                purposeMenu.innerHTML = '<li><button class="dropdown-item" type="button" id="clearPurposeFilter">Limpar Seleção</button></li><li><hr class="dropdown-divider"></li>';
                const purposes = [...new Set(tableData.map(row => row.Finalidade).filter(Boolean).sort())]; 
                
                purposes.forEach((p, index) => {
                  const li = document.createElement('li');
                  const uniqueId = 'check-purpose-' + index; 
                  li.innerHTML = `<div class="purpose-item-wrapper form-check"><input type="checkbox" class="form-check-input purpose-filter-item" value="${p}" id="${uniqueId}"><label class="form-check-label" for="${uniqueId}">${p}</label></div>`;
                  purposeMenu.appendChild(li);
                });

                // Listeners
                document.getElementById('clearPurposeFilter').addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    document.querySelectorAll('.purpose-filter-item:checked').forEach(cb => cb.checked = false);
                    applyFilters(); updatePurposeButtonText();
                });
                purposeMenu.addEventListener('change', (e) => {
                    if (e.target.classList.contains('purpose-filter-item')) { applyFilters(); updatePurposeButtonText(); }
                });
            } catch (e) { console.error("Erro populateFilters:", e); } 
        }

        function applyFilters() { 
            try { 
                const search = document.getElementById('searchInput').value.toLowerCase(); 
                const selectedPurposes = Array.from(document.querySelectorAll('.purpose-filter-item:checked')).map(cb => cb.value);
                
                const pendingMsgOnly = document.getElementById('pendingMsgFilter').classList.contains('active'); 
                const isPendenteOnly = document.getElementById('isPendenteFilter').classList.contains('active');
                const revisaoOnly = document.getElementById('revisaoFilter').classList.contains('active');
                const restituidaOnly = document.getElementById('restituidaFilter').classList.contains('active');
                const agendadasOnly = document.getElementById('agendadasFilter').classList.contains('active');
                const faltasOnly = document.getElementById('faltasFilter').classList.contains('active');
                const canceladasOnly = document.getElementById('canceladasFilter').classList.contains('active');

                const pendingStatusList = ['Conclusão Pendente', 'Concluída', 'Votada JRS']; 

                filteredData = allTableData.filter(r => { 
                    if (!r) return false;
                    const inspecionadoLower = (r.Inspecionado || '').toLowerCase(); 
                    const finalidadeMatch = (selectedPurposes.length === 0 || selectedPurposes.includes(r.Finalidade));
                    const searchMatch = (!search || inspecionadoLower.includes(search)); 
                    const pendingMsgMatch = (!pendingMsgOnly || r.MSG === 'PENDENTE'); 
                    const isPendenteMatch = (!isPendenteOnly || pendingStatusList.includes(r.StatusIS));
                    const emRevisaoMatch = (!revisaoOnly || (r.StatusIS === 'Auditoria' || r.StatusIS === 'JSD'));
                    const restituidaMatch = (!restituidaOnly || (r.StatusIS === 'Restituída Auditoria' || r.StatusIS === 'Restituída JSD'));
                    const agendadasMatch = (!agendadasOnly || r.StatusIS === 'Agendada');
                    const faltasMatch = (!faltasOnly || r.StatusIS === 'Faltou');
                    const canceladasMatch = (!canceladasOnly || r.StatusIS === 'Cancelada');
                    return searchMatch && finalidadeMatch && pendingMsgMatch && isPendenteMatch && emRevisaoMatch && restituidaMatch && agendadasMatch && faltasMatch && canceladasMatch; 
                }); 
                
                renderTable(filteredData); 
                initializeTooltips(); 
            } catch(e) { console.error("Erro filtros:", e); } 
        }

        function updatePurposeButtonText() {
            const count = document.querySelectorAll('.purpose-filter-item:checked').length;
            document.getElementById('purposeFilterButton').textContent = count === 0 ? 'Finalidades' : `Finalidades (${count})`;
        }

        function renderTable(dataToRender) { 
            const tBody = document.getElementById('dataTableBody'); 
            tBody.innerHTML = ''; 
            if (dataToRender.length === 0) { tBody.innerHTML = `<tr><td colspan="4" class="text-center">Nenhum resultado.</td></tr>`; return; } 
            
            const statusConfig = {
                'Agendada': { icon: 'event_available', color: 'info-color', tooltipText: 'Agendada'},
                'Auditoria': { icon: 'quick_reference_all', color: 'warning-color', tooltipText: 'Em Auditoria'},
                'Cancelada': { icon: 'event_busy', color: 'danger-color', tooltipText: 'Cancelada'},
                'Conclusão Pendente': { icon: 'help', color: 'danger-color', tooltipText: 'Conclusão Pendente'},
                'Concluída': { icon: 'gavel', color: 'danger-color', tooltipText: 'Votação Pendente'}, 
                'Faltou': { icon: 'disabled_by_default', color: 'danger-color', tooltipText: 'Faltou'},
                'JSD': { icon: 'quick_reference_all', color: 'warning-color', tooltipText: 'Revisão JSD'},
                'Remarcada': { icon: 'event_repeat', color: 'warning-color', tooltipText: 'Remarcada'},
                'Restituída Auditoria': { icon: 'arrow_circle_left', color: 'warning-color', tooltipText: 'Restituída (Auditoria)'},
                'Restituída JSD': { icon: 'arrow_circle_left', color: 'warning-color', tooltipText: 'Restituída (JSD)'},
                'TIS assinado': { icon: 'assignment_turned_in',color: 'success-color', tooltipText: 'TIS Assinado'}, 
                'Votada JRS': { icon: 'unknown_document', color: 'danger-color', tooltipText: 'Assinatura Pendente'} 
            };
            
            dataToRender.forEach((row, index) => { 
                const tr = tBody.insertRow(); 
                if (['AGU exames', 'Conclusão Pendente', 'Concluída', 'Votada JRS'].includes(row.StatusIS) || row.MSG === 'PENDENTE') { tr.classList.add('table-row-alert'); } 
                
                const config = statusConfig[row.StatusIS] || {};
                const statusHtml = config.icon ? `<span class="material-symbols-outlined status-icon" style="color: var(--${config.color});" data-bs-toggle="tooltip" title="${config.tooltipText}">${config.icon}</span>` : `<span>${row.StatusIS}</span>`;
                
                let msgHtml = '';
                if (row.MSG === 'ENVIADA') msgHtml = `<span class="material-symbols-outlined" style="color:var(--success-color);" data-bs-toggle="tooltip" title="Mensagem Enviada">mark_email_read</span>`; 
                else if (row.MSG === 'PENDENTE') msgHtml = `<span class="material-symbols-outlined" style="color:var(--danger-color-vivid);" data-bs-toggle="tooltip" title="Mensagem Pendente">unsubscribe</span>`; 
                
                const inspecionadoNome = `${row['P/G/Q'] && !['CANDIDATO', 'DEPEND / PENS'].includes(row['P/G/Q']) ? row['P/G/Q'] + ' ' : ''}${row.Inspecionado || ''}`;
                
                let syncIconHtml = row.MSG === 'PENDENTE' ? `<span class="material-symbols-outlined actions-icon" title="Marcar MSG como Enviada" onclick="updateMsgStatus(event, '${row.IS}', ${index})">sync</span>` : ''; 
                let editIconHtml = row.MSG !== 'ENVIADA' ? `<span class="material-symbols-outlined actions-icon" title="Editar Conclusão" onclick="openEditModal(event, ${index})">edit</span>` : '';
                let remarcarIconHtml = (row.StatusIS === 'Agendada' || row.StatusIS === 'Remarcada') ? `<span class="material-symbols-outlined actions-icon" title="Remarcar Inspeção" onclick="openRemarcarModal(event, ${index})">event_repeat</span>` : '';

                tr.innerHTML = `
                    <td><div style="display: flex; align-items: center; gap: 10px;">${statusHtml}${msgHtml}</div></td>
                    <td><div class="table-cell-main">${row.DataEntrevista || ''}</div><div class="table-cell-sub">${row.IS || ''}</div></td>
                    <td><div><div class="table-cell-main">${inspecionadoNome}</div><div class="table-cell-sub">${row.OM || ''}</div></div></td>
                    <td><div class="actions-cell-content"><span>${row.Finalidade||''}</span><span style="display: flex; align-items: center; gap: 8px;">${syncIconHtml}${editIconHtml}${remarcarIconHtml} <span class="material-symbols-outlined actions-icon" onclick="showDetailsModal(event, ${index})">more_vert</span></span></div></td>
                `; 
            }); 
        }

        // --- LÓGICA DE MODAIS E CRUD (Mantida do Original) ---
        function updateMsgStatus(event, isNumber, rowIndex) {
             if (event) event.stopPropagation();
             const icon = event.target;
             icon.textContent = 'hourglass_top';
             google.script.run.withSuccessHandler(response => {
                 if (response.success) {
                     const originalDataIndex = allTableData.findIndex(item => item.IS == isNumber);
                     if (originalDataIndex > -1) allTableData[originalDataIndex].MSG = 'ENVIADA';
                     applyFilters();
                 } else { alert("Erro: " + response.message); icon.textContent = 'sync'; }
             }).updateMsgStatus(isNumber);
        }

        function showDetailsModal(event, index) { 
             if (event) event.stopPropagation();
             const data = filteredData[index]; 
             document.getElementById('modalDetailsInspecionado').textContent = data.Inspecionado; 
             document.getElementById('modalDetailsFinalidade').textContent = data.Finalidade;
             document.getElementById('modalDetailsLaudo').textContent = data.Laudo;
             document.getElementById('modalDetailsRestricoes').textContent = data.Restrições;
             document.getElementById('modalDetailsDataLaudo').textContent = data.DataLaudo;
             document.getElementById('modalDetailsTis').textContent = data.TIS;
             document.getElementById('modalDetailsDs1a').textContent = data['DS-1a'];
             
             // Minuta (simplificada para brevidade, lógica original mantida)
             if (data['DS-1a']) {
                 document.getElementById('modalMinutaMsgText').textContent = `INSPEÇÃO DE SAÚDE FIM ${data.Finalidade} - ${data.Inspecionado}... (Ver detalhes completos)`;
                 document.getElementById('minuta-msg-section').classList.remove('d-none');
             } else { document.getElementById('minuta-msg-section').classList.add('d-none'); }
             detailsModalInstance.show(); 
        }

        function populateEditModalOptions(restricoes) {
            const container = document.getElementById('editRestricoesBody');
            container.innerHTML = ''; 
            restricoes.forEach((item, index) => {
              const div = document.createElement('div');
              div.className = 'form-check';
              div.innerHTML = `<input class="form-check-input edit-restricao-item" type="checkbox" value="${item}" id="edit-check-${index}"><label class="form-check-label" for="edit-check-${index}">${item}</label>`;
              if (item === 'Outros') div.querySelector('input').addEventListener('click', function() { document.getElementById('editOutrosRestricaoContainer').classList.toggle('d-none', !this.checked); });
              container.appendChild(div);
            });
        }
        
        function openEditModal(event, index) {
            if (event) event.stopPropagation();
            const data = filteredData[index];
            document.getElementById('editModalIsTitle').textContent = data.IS;
            document.getElementById('editModalInspecionado').textContent = data.Inspecionado;
            document.getElementById('editIsNumber').value = data.IS;
            document.getElementById('editLaudo').value = data.Laudo || '';
            document.getElementById('editTis').value = data.TIS || '';
            document.getElementById('editDs1a').value = data['DS-1a'] || '';
            
            // Tratamento de Data
            if (data.DataLaudo) {
                const parts = data.DataLaudo.split('/');
                if(parts.length===3) document.getElementById('editDataLaudo').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else { document.getElementById('editDataLaudo').valueAsDate = new Date(); }

            // Restrições
            const allCheckboxes = document.querySelectorAll('.edit-restricao-item');
            allCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('editOutrosRestricaoText').value = '';
            document.getElementById('editOutrosRestricaoContainer').classList.add('d-none');

            const arr = data.Restrições ? data.Restrições.split(', ') : [];
            arr.forEach(r => {
                let match = false;
                allCheckboxes.forEach(cb => { if(cb.value === r) { cb.checked = true; match = true; } });
                if (!match && r.startsWith('Outros: ')) {
                    const outros = Array.from(allCheckboxes).find(cb => cb.value === 'Outros');
                    if(outros) { outros.checked = true; document.getElementById('editOutrosRestricaoContainer').classList.remove('d-none'); document.getElementById('editOutrosRestricaoText').value = r.substring(8); }
                }
            });
            
            // Visibilidade Restrições
            const showList = ['VERIFICAÇÃO DE DEFICIÊNCIA FUNCIONAL','TÉRMINO DE INCAPACIDADE','TÉRMINO DE RESTRIÇÕES'];
            document.getElementById('editRestricoesContainer').style.display = showList.includes((data.Finalidade||'').toUpperCase()) ? 'block' : 'none';

            editModalInstance.show();
        }

        function handleEditFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('saveEditButton');
            btn.disabled = true; btn.textContent = 'Salvando...';
            
            const formData = {
                isNumber: document.getElementById('editIsNumber').value,
                laudo: document.getElementById('editLaudo').value,
                dataLaudo: document.getElementById('editDataLaudo').value,
                tis: document.getElementById('editTis').value,
                ds1a: document.getElementById('editDs1a').value,
                restricoes: Array.from(document.querySelectorAll('.edit-restricao-item:checked')).map(cb => cb.value),
                outrosRestricao: document.getElementById('editOutrosRestricaoText').value
            };
            
            google.script.run.withSuccessHandler(response => {
                if(response.success) {
                    const idx = allTableData.findIndex(i => i.IS == formData.isNumber);
                    if(idx > -1) Object.assign(allTableData[idx], response.updatedData);
                    editModalInstance.hide();
                    applyFilters();
                } else { alert("Erro: " + response.message); }
                btn.disabled = false; btn.textContent = 'Salvar Alterações';
            }).updateInspectionConclusion(formData);
        }

        function openRemarcarModal(event, index) {
            if (event) event.stopPropagation();
            const data = filteredData[index];
            document.getElementById('remarcarModalInspecionado').textContent = data.Inspecionado;
            document.getElementById('remarcarModalIs').textContent = data.IS;
            document.getElementById('remarcarIsNumber').value = data.IS;
            document.getElementById('remarcarNovaData').value = '';
            remarcarModalInstance.show();
        }

        function handleRemarcarFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('saveRemarcarButton');
            btn.disabled = true; btn.textContent = 'Salvando...';
            
            const formData = { isNumber: document.getElementById('remarcarIsNumber').value, novaData: document.getElementById('remarcarNovaData').value };
            
            google.script.run.withSuccessHandler(response => {
                if(response.success) {
                    const idx = allTableData.findIndex(i => i.IS == formData.isNumber);
                    if(idx > -1) { allTableData[idx].DataEntrevista = response.updatedData.DataEntrevista; allTableData[idx].StatusIS = response.updatedData.StatusIS; }
                    remarcarModalInstance.hide();
                    applyFilters();
                } else { alert("Erro: " + response.message); }
                btn.disabled = false; btn.textContent = 'Salvar Nova Data';
            }).remarcarInspecao(formData);
        }

        function applyTISMask(input) {
            let v = input.value.replace(/\D/g, '').substring(0, 11);
            input.value = v.length > 6 ? `${v.substring(0,3)}.${v.substring(3,6)}.${v.substring(6)}` : v.length > 3 ? `${v.substring(0,3)}.${v.substring(3)}` : v;
        }
    </script>
</body>
</html>
